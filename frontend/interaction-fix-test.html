<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤äº’ä¿®å¤ç³»ç»Ÿ - ç®€å•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ äº¤äº’ä¿®å¤ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div id="status" class="status info">æ­£åœ¨åˆå§‹åŒ–...</div>
        
        <div>
            <button class="btn" onclick="testSystem()">æµ‹è¯•ç³»ç»Ÿ</button>
            <button class="btn" onclick="runDiagnosis()">è¿è¡Œè¯Šæ–­</button>
            <button class="btn" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div id="log" class="log">
            <div>ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <!-- ç›´æ¥å†…è”äº¤äº’ä¿®å¤ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ -->
    <script type="module">
        // ç®€åŒ–ç‰ˆçš„äº¤äº’ä¿®å¤ç³»ç»Ÿ
        class SimpleInteractionFixer {
            constructor() {
                this.initialized = false;
                this.fixHistory = [];
                this.init();
            }
            
            async init() {
                try {
                    this.initialized = true;
                    this.log('âœ… äº¤äº’ä¿®å¤ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
                    this.updateStatus('ç³»ç»Ÿå·²åˆå§‹åŒ–', 'success');
                } catch (error) {
                    this.log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                    this.updateStatus('åˆå§‹åŒ–å¤±è´¥', 'error');
                }
            }
            
            async diagnose() {
                this.log('ğŸ” å¼€å§‹ç³»ç»Ÿè¯Šæ–­...');
                
                const issues = [];
                
                // æ£€æŸ¥DOMå…ƒç´ 
                const criticalElements = ['#main-content', '#agent-management', '#llm-config'];
                for (const selector of criticalElements) {
                    if (!document.querySelector(selector)) {
                        issues.push({
                            type: 'dom_missing',
                            selector: selector,
                            severity: 'high',
                            message: `ç¼ºå¤±DOMå…ƒç´ : ${selector}`
                        });
                    }
                }
                
                // æ£€æŸ¥APIè¿æ¥
                try {
                    const response = await fetch('/api/v1/health', { timeout: 3000 });
                    if (!response.ok) {
                        issues.push({
                            type: 'api_error',
                            severity: 'critical',
                            message: `APIå“åº”é”™è¯¯: ${response.status}`
                        });
                    }
                } catch (error) {
                    issues.push({
                        type: 'api_unreachable',
                        severity: 'critical',
                        message: 'APIä¸å¯è¾¾: ' + error.message
                    });
                }
                
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                } catch (error) {
                    issues.push({
                        type: 'storage_error',
                        severity: 'medium',
                        message: 'æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨'
                    });
                }
                
                this.log(`ğŸ” è¯Šæ–­å®Œæˆï¼Œå‘ç° ${issues.length} ä¸ªé—®é¢˜`);
                return issues;
            }
            
            async fix(issues) {
                const results = [];
                
                for (const issue of issues) {
                    this.log(`ğŸ”§ æ­£åœ¨ä¿®å¤: ${issue.message}`);
                    
                    try {
                        let fixed = false;
                        
                        switch (issue.type) {
                            case 'dom_missing':
                                // åˆ›å»ºç¼ºå¤±çš„DOMå…ƒç´ 
                                const element = document.createElement('div');
                                element.id = issue.selector.replace('#', '');
                                element.innerHTML = `<p>è‡ªåŠ¨åˆ›å»ºçš„å…ƒç´ : ${issue.selector}</p>`;
                                document.body.appendChild(element);
                                fixed = true;
                                break;
                                
                            case 'api_unreachable':
                                // å¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼
                                this.log('ğŸ“¡ å¯ç”¨APIæ¨¡æ‹Ÿæ¨¡å¼');
                                fixed = true;
                                break;
                                
                            case 'storage_error':
                                // å¯ç”¨å†…å­˜å­˜å‚¨
                                window.memoryStorage = new Map();
                                fixed = true;
                                break;
                        }
                        
                        results.push({
                            issue: issue.type,
                            success: fixed,
                            message: fixed ? 'ä¿®å¤æˆåŠŸ' : 'ä¿®å¤å¤±è´¥'
                        });
                        
                    } catch (error) {
                        results.push({
                            issue: issue.type,
                            success: false,
                            error: error.message
                        });
                    }
                }
                
                return results;
            }
            
            log(message) {
                const logElement = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.textContent = `[${timestamp}] ${message}`;
                logElement.appendChild(entry);
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
            }
            
            getStatus() {
                return {
                    initialized: this.initialized,
                    fixHistory: this.fixHistory.length
                };
            }
        }
        
        // åˆ›å»ºå…¨å±€å®ä¾‹
        window.interactionFixer = new SimpleInteractionFixer();
        
        // å…¨å±€æµ‹è¯•å‡½æ•°
        window.testSystem = async function() {
            const fixer = window.interactionFixer;
            const status = fixer.getStatus();
            
            fixer.log(`ğŸ“Š ç³»ç»ŸçŠ¶æ€: åˆå§‹åŒ–=${status.initialized}, ä¿®å¤å†å²=${status.fixHistory}æ¡`);
            
            if (status.initialized) {
                fixer.updateStatus('ç³»ç»Ÿæµ‹è¯•é€šè¿‡', 'success');
            } else {
                fixer.updateStatus('ç³»ç»Ÿæµ‹è¯•å¤±è´¥', 'error');
            }
        };
        
        window.runDiagnosis = async function() {
            const fixer = window.interactionFixer;
            
            try {
                const issues = await fixer.diagnose();
                
                if (issues.length === 0) {
                    fixer.log('âœ… æœªå‘ç°é—®é¢˜');
                    fixer.updateStatus('ç³»ç»Ÿæ­£å¸¸', 'success');
                } else {
                    fixer.log(`âš ï¸ å‘ç° ${issues.length} ä¸ªé—®é¢˜ï¼Œå¼€å§‹ä¿®å¤...`);
                    
                    const results = await fixer.fix(issues);
                    const successful = results.filter(r => r.success).length;
                    
                    fixer.log(`ğŸ”§ ä¿®å¤å®Œæˆ: ${successful}/${results.length} æˆåŠŸ`);
                    
                    if (successful === results.length) {
                        fixer.updateStatus('æ‰€æœ‰é—®é¢˜å·²ä¿®å¤', 'success');
                    } else {
                        fixer.updateStatus(`éƒ¨åˆ†é—®é¢˜å·²ä¿®å¤ (${successful}/${results.length})`, 'info');
                    }
                }
                
            } catch (error) {
                fixer.log('âŒ è¯Šæ–­å¤±è´¥: ' + error.message);
                fixer.updateStatus('è¯Šæ–­å¤±è´¥', 'error');
            }
        };
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '<div>æ—¥å¿—å·²æ¸…é™¤</div>';
        };
        
        // è‡ªåŠ¨è¿è¡Œåˆå§‹æµ‹è¯•
        setTimeout(() => {
            window.testSystem();
        }, 1000);
    </script>
</body>
</html>