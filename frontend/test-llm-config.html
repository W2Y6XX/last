<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æ¨¡å‹é…ç½®æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 25%, #2d3561 50%, #4a3d8a 75%, #6b5b95 100%);
            min-height: 100vh;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        
        .btn-blue {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            transition: all 0.3s ease;
        }
        
        .btn-blue:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        
        .hover-scale {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hover-scale:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold mb-8 text-center">
            ğŸ§  å¤§æ¨¡å‹é…ç½®æµ‹è¯•
        </h1>
        
        <!-- å¤§æ¨¡å‹é…ç½®åŒºåŸŸ -->
        <div class="glass-morphism rounded-xl p-6 mb-6" id="llm-config-section">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-xl font-semibold text-blue-100 flex items-center">
                        <i class="fas fa-brain mr-2 text-purple-300"></i>
                        å¤§æ¨¡å‹é…ç½®
                    </h3>
                    <p class="text-sm opacity-80 mt-1">é…ç½®å’Œç®¡ç†å¤§è¯­è¨€æ¨¡å‹ï¼Œä¸ºæ™ºèƒ½ä½“æä¾›AIèƒ½åŠ›</p>
                </div>
                <button onclick="openLLMConfigModal()" class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    æ·»åŠ é…ç½®
                </button>
            </div>
            
            <!-- é…ç½®ç»Ÿè®¡æ‘˜è¦ -->
            <div id="llm-config-summary" class="mb-6 p-4 glass-morphism rounded-lg">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- é…ç½®åˆ—è¡¨ -->
            <div id="llm-config-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- é…ç½®å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center border-2 border-dashed border-purple-300 border-opacity-50">
                    <div class="py-8">
                        <i class="fas fa-plus-circle text-4xl text-purple-300 mb-3"></i>
                        <p class="text-lg font-medium">æ·»åŠ å¤§æ¨¡å‹é…ç½®</p>
                        <p class="text-sm opacity-75 mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹é…ç½®</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="text-center">
            <button onclick="testLLMConfigManager()" class="btn-blue px-8 py-4 text-white rounded-lg text-lg">
                <i class="fas fa-flask mr-2"></i>
                æµ‹è¯•é…ç½®ç®¡ç†å™¨
            </button>
        </div>
        
        <!-- æµ‹è¯•ç»“æœ -->
        <div id="test-results" class="mt-8 glass-morphism rounded-xl p-6 hidden">
            <h3 class="text-xl font-semibold mb-4">æµ‹è¯•ç»“æœ</h3>
            <pre id="test-output" class="text-sm bg-black bg-opacity-30 p-4 rounded overflow-auto max-h-96"></pre>
        </div>
    </div>

    <!-- å¤§æ¨¡å‹é…ç½®æ¨¡æ€æ¡† -->
    <div id="llm-config-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-morphism rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-blue-100 flex items-center">
                    <i class="fas fa-brain mr-2 text-purple-300"></i>
                    <span id="llm-modal-title">æ·»åŠ å¤§æ¨¡å‹é…ç½®</span>
                </h3>
                <button onclick="closeLLMConfigModal()" class="text-blue-100 hover:text-purple-300 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="llm-config-form" class="space-y-6">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">åŸºæœ¬ä¿¡æ¯</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">é…ç½®åç§° *</label>
                        <input type="text" id="config-name" name="name" required
                               class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                               placeholder="è¯·è¾“å…¥é…ç½®åç§°">
                        <div class="text-red-400 text-sm mt-1 hidden" id="name-error"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">æä¾›å•† *</label>
                        <select id="config-provider" name="provider" required
                                class="w-full p-3 rounded-lg glass-morphism text-blue-100 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                onchange="updateProviderFields()">
                            <option value="">è¯·é€‰æ‹©æä¾›å•†</option>
                            <option value="siliconflow">SiliconFlow</option>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="local">æœ¬åœ°éƒ¨ç½²</option>
                        </select>
                        <div class="text-red-400 text-sm mt-1 hidden" id="provider-error"></div>
                    </div>
                </div>
                
                <!-- è¿æ¥é…ç½® -->
                <div class="space-y-4" id="connection-config">
                    <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">è¿æ¥é…ç½®</h4>
                    
                    <div id="api-key-field">
                        <label class="block text-sm font-medium text-blue-100 mb-2">APIå¯†é’¥ *</label>
                        <div class="relative">
                            <input type="password" id="config-api-key" name="apiKey"
                                   class="w-full p-3 pr-12 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                   placeholder="è¯·è¾“å…¥APIå¯†é’¥">
                            <button type="button" onclick="togglePasswordVisibility('config-api-key')" 
                                    class="absolute right-3 top-3 text-blue-100 hover:text-purple-300">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="text-red-400 text-sm mt-1 hidden" id="apiKey-error"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">åŸºç¡€URL</label>
                        <input type="url" id="config-base-url" name="baseUrl"
                               class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                               placeholder="APIåŸºç¡€URL">
                        <div class="text-red-400 text-sm mt-1 hidden" id="baseUrl-error"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">æ¨¡å‹åç§° *</label>
                        <input type="text" id="config-model" name="model" required
                               class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                               placeholder="è¯·è¾“å…¥æ¨¡å‹åç§°">
                        <div class="text-red-400 text-sm mt-1 hidden" id="model-error"></div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex justify-between items-center pt-6 border-t border-purple-300 border-opacity-30">
                    <div class="flex space-x-3">
                        <button type="button" onclick="testLLMConnection()" id="test-connection-btn"
                                class="px-4 py-2 glass-morphism rounded-lg text-blue-100 hover:bg-white hover:bg-opacity-10 transition-all flex items-center">
                            <i class="fas fa-plug mr-2"></i>
                            æµ‹è¯•è¿æ¥
                        </button>
                        <div id="test-result" class="flex items-center text-sm hidden">
                            <i class="fas fa-spinner fa-spin mr-2 text-yellow-400"></i>
                            <span>æµ‹è¯•ä¸­...</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeLLMConfigModal()"
                                class="px-6 py-3 glass-morphism rounded-lg text-blue-100 hover:bg-white hover:bg-opacity-10 transition-all">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" id="save-config-btn"
                                class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                            <i class="fas fa-save mr-2"></i>
                            ä¿å­˜é…ç½®
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- å¼•å…¥è„šæœ¬ -->
    <script src="js/core/form-validator.js"></script>
    <script src="js/managers/llm-config-manager.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let currentEditingConfigId = null;
        let formValidator = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–è¡¨å•éªŒè¯å™¨
            if (typeof FormValidator !== 'undefined') {
                formValidator = new FormValidator();
            }
            
            // åˆå§‹åŒ–å¤§æ¨¡å‹é…ç½®ç®¡ç†å™¨
            if (typeof LLMConfigManager !== 'undefined') {
                window.llmConfigManager = new LLMConfigManager();
                loadLLMConfigs();
                setupFormValidation();
            }
        });

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // æµ‹è¯•é…ç½®ç®¡ç†å™¨
        function testLLMConfigManager() {
            const output = document.getElementById('test-output');
            const results = document.getElementById('test-results');
            
            let log = '';
            
            try {
                log += '=== å¤§æ¨¡å‹é…ç½®ç®¡ç†å™¨æµ‹è¯• ===\n\n';
                
                // æµ‹è¯•ç®¡ç†å™¨åˆå§‹åŒ–
                log += '1. æµ‹è¯•ç®¡ç†å™¨åˆå§‹åŒ–\n';
                if (window.llmConfigManager) {
                    log += 'âœ“ é…ç½®ç®¡ç†å™¨å·²åˆå§‹åŒ–\n';
                    log += `âœ“ æ”¯æŒçš„æä¾›å•†: ${window.llmConfigManager.getSupportedProviders().map(p => p.name).join(', ')}\n`;
                } else {
                    log += 'âœ— é…ç½®ç®¡ç†å™¨æœªåˆå§‹åŒ–\n';
                }
                
                // æµ‹è¯•é…ç½®åˆ—è¡¨
                log += '\n2. æµ‹è¯•é…ç½®åˆ—è¡¨\n';
                const configs = window.llmConfigManager.getAllConfigs();
                log += `âœ“ å½“å‰é…ç½®æ•°é‡: ${configs.length}\n`;
                
                if (configs.length > 0) {
                    configs.forEach((config, index) => {
                        log += `  é…ç½® ${index + 1}: ${config.name} (${config.provider})\n`;
                    });
                }
                
                // æµ‹è¯•æ´»è·ƒé…ç½®
                log += '\n3. æµ‹è¯•æ´»è·ƒé…ç½®\n';
                const activeConfig = window.llmConfigManager.getActiveConfig();
                if (activeConfig) {
                    log += `âœ“ æ´»è·ƒé…ç½®: ${activeConfig.name}\n`;
                } else {
                    log += '- æ— æ´»è·ƒé…ç½®\n';
                }
                
                // æµ‹è¯•è¡¨å•éªŒè¯å™¨
                log += '\n4. æµ‹è¯•è¡¨å•éªŒè¯å™¨\n';
                if (formValidator) {
                    log += 'âœ“ è¡¨å•éªŒè¯å™¨å·²åˆå§‹åŒ–\n';
                    
                    // æµ‹è¯•éªŒè¯è§„åˆ™
                    const testResult = formValidator.validateField('test@example.com', ['email']);
                    log += `âœ“ é‚®ç®±éªŒè¯æµ‹è¯•: ${testResult.isValid ? 'é€šè¿‡' : 'å¤±è´¥'}\n`;
                } else {
                    log += 'âœ— è¡¨å•éªŒè¯å™¨æœªåˆå§‹åŒ–\n';
                }
                
                log += '\n=== æµ‹è¯•å®Œæˆ ===\n';
                
            } catch (error) {
                log += `\nâœ— æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}\n`;
                console.error('æµ‹è¯•é”™è¯¯:', error);
            }
            
            output.textContent = log;
            results.classList.remove('hidden');
        }

        // åŒ…å«æ‰€æœ‰å¿…è¦çš„å‡½æ•°ï¼ˆä»88.htmlå¤åˆ¶ï¼‰
        function openLLMConfigModal(configId = null) {
            currentEditingConfigId = configId;
            const modal = document.getElementById('llm-config-modal');
            const title = document.getElementById('llm-modal-title');
            const form = document.getElementById('llm-config-form');
            
            if (configId) {
                title.textContent = 'ç¼–è¾‘å¤§æ¨¡å‹é…ç½®';
                loadConfigForEdit(configId);
            } else {
                title.textContent = 'æ·»åŠ å¤§æ¨¡å‹é…ç½®';
                form.reset();
                clearFormErrors();
            }
            
            modal.classList.remove('hidden');
        }

        function closeLLMConfigModal() {
            const modal = document.getElementById('llm-config-modal');
            modal.classList.add('hidden');
            currentEditingConfigId = null;
            document.getElementById('llm-config-form').reset();
            clearFormErrors();
        }

        function updateProviderFields() {
            const provider = document.getElementById('config-provider').value;
            const apiKeyField = document.getElementById('api-key-field');
            
            if (!window.llmConfigManager) return;
            
            const providers = window.llmConfigManager.getSupportedProviders();
            const providerInfo = providers.find(p => p.key === provider);
            
            if (providerInfo) {
                // è®¾ç½®é»˜è®¤å€¼
                Object.keys(providerInfo.defaultValues).forEach(key => {
                    const field = document.getElementById(`config-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
                    if (field && !field.value) {
                        field.value = providerInfo.defaultValues[key];
                    }
                });
                
                // æ§åˆ¶APIå¯†é’¥å­—æ®µæ˜¾ç¤º
                if (providerInfo.requiredFields.includes('apiKey')) {
                    apiKeyField.style.display = 'block';
                    document.getElementById('config-api-key').required = true;
                } else {
                    apiKeyField.style.display = 'none';
                    document.getElementById('config-api-key').required = false;
                }
            }
        }

        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.nextElementSibling.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function clearFormErrors() {
            if (formValidator) {
                formValidator.clearErrors();
            }
        }

        function setupFormValidation() {
            if (!formValidator) return;
            
            const form = document.getElementById('llm-config-form');
            const fields = form.querySelectorAll('input, select');
            
            fields.forEach(field => {
                const fieldName = field.name;
                if (fieldName && LLMConfigValidationRules[fieldName]) {
                    formValidator.setupRealTimeValidation(field, LLMConfigValidationRules[fieldName]);
                }
            });
        }

        function loadLLMConfigs() {
            if (!window.llmConfigManager) return;
            
            const configs = window.llmConfigManager.getAllConfigs();
            const configList = document.getElementById('llm-config-list');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œä½†ä¿ç•™æ·»åŠ æŒ‰é’®
            const addButton = configList.querySelector('.border-dashed');
            configList.innerHTML = '';
            if (addButton) {
                configList.appendChild(addButton);
            }
            
            configs.forEach(config => {
                const configCard = createLLMConfigCard(config);
                configList.appendChild(configCard);
            });
            
            updateConfigSummary();
        }

        function createLLMConfigCard(config) {
            const card = document.createElement('div');
            card.className = 'glass-morphism rounded-lg p-4 text-blue-100 hover-scale cursor-pointer';
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold">${config.name}</h4>
                            <p class="text-xs opacity-75">${config.provider}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${config.isActive ? '<span class="px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">æ´»è·ƒ</span>' : ''}
                    </div>
                </div>
                
                <div class="text-sm opacity-80 mb-3">
                    <div class="flex justify-between">
                        <span>æ¨¡å‹:</span>
                        <span>${config.settings.model || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button onclick="event.stopPropagation(); editLLMConfig('${config.id}')" 
                                class="text-blue-300 hover:text-blue-200 text-sm">
                            <i class="fas fa-edit mr-1"></i>ç¼–è¾‘
                        </button>
                    </div>
                    <button onclick="event.stopPropagation(); deleteLLMConfig('${config.id}')" 
                            class="text-red-300 hover:text-red-200">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            return card;
        }

        function updateConfigSummary() {
            if (!window.llmConfigManager) return;
            
            const configs = window.llmConfigManager.getAllConfigs();
            const summary = {
                total: configs.length,
                active: configs.filter(c => c.isActive).length
            };
            
            const summaryElement = document.getElementById('llm-config-summary');
            if (summaryElement) {
                summaryElement.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-blue-100">${summary.total}</div>
                            <div class="text-xs opacity-75">æ€»é…ç½®</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-400">${summary.active}</div>
                            <div class="text-xs opacity-75">æ´»è·ƒ</div>
                        </div>
                    </div>
                `;
            }
        }

        // ç®€åŒ–çš„å‡½æ•°
        function editLLMConfig(configId) {
            openLLMConfigModal(configId);
        }

        function deleteLLMConfig(configId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) {
                window.llmConfigManager.deleteConfig(configId).then(() => {
                    loadLLMConfigs();
                    showNotification('é…ç½®å·²åˆ é™¤', 'success');
                });
            }
        }

        async function testLLMConnection() {
            showNotification('è¿æ¥æµ‹è¯•åŠŸèƒ½éœ€è¦åç«¯APIæ”¯æŒ', 'info');
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('llm-config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const config = {
                name: formData.get('name'),
                provider: formData.get('provider'),
                settings: {
                    apiKey: formData.get('apiKey'),
                    baseUrl: formData.get('baseUrl'),
                    model: formData.get('model')
                }
            };
            
            try {
                let result;
                if (currentEditingConfigId) {
                    result = await window.llmConfigManager.updateConfig(currentEditingConfigId, config);
                } else {
                    result = await window.llmConfigManager.createConfig(config);
                }
                
                if (result.success) {
                    showNotification(currentEditingConfigId ? 'é…ç½®æ›´æ–°æˆåŠŸï¼' : 'é…ç½®åˆ›å»ºæˆåŠŸï¼', 'success');
                    closeLLMConfigModal();
                    loadLLMConfigs();
                } else {
                    showNotification('ä¿å­˜å¤±è´¥: ' + result.errors.join(', '), 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showNotification('ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            }
        });
    </script>
</body>
</html>