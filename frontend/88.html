<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学办小星 - AI智能助手系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 25%, #2d3561 50%, #4a3d8a 75%, #6b5b95 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* 添加紫色和白色渐变覆盖层 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 40%),
                        radial-gradient(circle at 60% 20%, rgba(167, 139, 250, 0.12) 0%, transparent 45%);
            pointer-events: none;
            z-index: 1;
        }
        
        /* 星空背景效果 */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 4s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        
        /* 添加装饰性背景元素 */
        .bg-decoration {
            position: fixed;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            pointer-events: none;
            animation: float 20s infinite ease-in-out;
        }
        
        .bg-decoration:nth-child(1) {
            width: 300px;
            height: 300px;
            top: -150px;
            right: -150px;
            animation-delay: 0s;
            background: radial-gradient(circle, rgba(138, 43, 226, 0.15) 0%, rgba(30, 144, 255, 0.08) 100%);
        }
        
        .bg-decoration:nth-child(2) {
            width: 200px;
            height: 200px;
            bottom: -100px;
            left: -100px;
            animation-delay: 5s;
            background: radial-gradient(circle, rgba(30, 144, 255, 0.15) 0%, rgba(138, 43, 226, 0.08) 100%);
        }
        
        .bg-decoration:nth-child(3) {
            width: 150px;
            height: 150px;
            top: 50%;
            left: -75px;
            animation-delay: 10s;
            background: radial-gradient(circle, rgba(147, 112, 219, 0.15) 0%, rgba(123, 104, 238, 0.08) 100%);
        }
        
        /* 添加额外的紫色和白色光晕 */
        .bg-decoration:nth-child(4) {
            width: 250px;
            height: 250px;
            top: 20%;
            right: 10%;
            animation-delay: 3s;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.12) 0%, rgba(139, 92, 246, 0.06) 100%);
        }
        
        .bg-decoration:nth-child(5) {
            width: 180px;
            height: 180px;
            bottom: 20%;
            right: 20%;
            animation-delay: 7s;
            background: radial-gradient(circle, rgba(167, 139, 250, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(120deg); }
            66% { transform: translateY(20px) rotate(240deg); }
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .nav-item {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .nav-item:hover::before {
            left: 100%;
        }
        
        .nav-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #8b5cf6;
        }
        
        .chat-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8b5cf6;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .data-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .data-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }
        
        .data-card:hover::after {
            animation: shine 0.5s ease-in-out;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }
        
        /* 添加星光效果 */
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            animation: sparkle 3s linear infinite;
        }
        
        @keyframes sparkle {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }
        
        /* 按钮悬停效果 */
        .btn-blue {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            transition: all 0.3s ease;
        }
        
        .btn-blue:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        
        /* 卡片悬停效果 */
        .feature-card {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .feature-card:hover {
            transform: scale(1.05);
        }
        
        .feature-card:hover .feature-icon {
            animation: bounce 0.5s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* 从3.html中引入的样式 */
        .hover-scale {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hover-scale:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* 智能体卡片样式 */
        .agent-card {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .agent-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(139, 92, 246, 0.3);
        }
        
        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .agent-card:hover::before {
            left: 100%;
        }
        
        /* 状态指示器样式 */
        .status-indicator {
            position: relative;
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-active::before {
            background: #10b981;
            animation: pulse-green 2s infinite;
        }
        
        .status-idle {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }
        
        .status-idle::before {
            background: #9ca3af;
        }
        
        .status-busy {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .status-busy::before {
            background: #f59e0b;
            animation: pulse-yellow 1.5s infinite;
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-error::before {
            background: #ef4444;
            animation: pulse-red 1s infinite;
        }
        
        .status-offline {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }
        
        .status-offline::before {
            background: #9ca3af;
        }
        
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes pulse-yellow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        
        /* 能力标签样式 */
        .capability-tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        /* 统计信息样式 */
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .stat-value {
            font-size: 14px;
            font-weight: 600;
        }
        
        /* 进度条样式 */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* 健康状态指示器 */
        .health-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .health-healthy {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        .health-warning {
            background: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
        }
        
        .health-error {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
        
        /* 模态框样式 */
        .detail-tab-btn {
            transition: all 0.3s ease;
        }
        
        .detail-tab-btn.active {
            border-bottom-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        
        .detail-tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* 历史记录项样式 */
        .history-item {
            padding: 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }
        
        .history-item.success {
            border-left-color: #10b981;
        }
        
        .history-item.failed {
            border-left-color: #ef4444;
        }
        
        .history-item.running {
            border-left-color: #f59e0b;
        }
        
        /* 日志样式 */
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #9ca3af;
            margin-right: 8px;
        }
        
        .log-level {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .log-level.error {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
        }
        
        .log-level.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fed7aa;
        }
        
        .log-level.info {
            background: rgba(59, 130, 246, 0.2);
            color: #bfdbfe;
        }
        
        .log-level.debug {
            background: rgba(107, 114, 128, 0.2);
            color: #d1d5db;
        }
        
        .log-message {
            color: #e5e7eb;
        }
        
        /* 分页样式 */
        .pagination-btn {
            padding: 8px 12px;
            margin: 0 2px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #e5e7eb;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pagination-btn:hover {
            background: rgba(139, 92, 246, 0.3);
        }
        
        .pagination-btn.active {
            background: #8b5cf6;
            color: white;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 状态更新动画 */
        .status-updating {
            animation: statusUpdate 0.5s ease-in-out;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }
        
        @keyframes statusUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* 通知样式 */
        .notification {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
        }
        
        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }
        
        .notification-warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
        }
        
        .notification-info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }
        
        /* 连接状态指示器 */
        #websocket-status {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* 实时更新指示器 */
        .realtime-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: realtimePulse 2s infinite;
        }
        
        @keyframes realtimePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        /* 数据变化高亮 */
        .data-highlight {
            animation: dataHighlight 0.6s ease-in-out;
        }
        
        @keyframes dataHighlight {
            0% { background: transparent; }
            50% { background: rgba(139, 92, 246, 0.3); }
            100% { background: transparent; }
        }
        
        /* 加载状态动画 */
        .loading-shimmer {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.1) 25%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .interactive-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .interactive-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .interactive-button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .task-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .task-card:hover {
            transform: translateX(10px);
            box-shadow: -5px 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
        }
        
        /* 新增任务卡片样式 */
        .add-task-card {
            border: 2px dashed rgba(139, 92, 246, 0.5);
            transition: all 0.3s ease;
        }
        
        .add-task-card:hover {
            border-color: rgba(139, 92, 246, 0.8);
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }
        
        /* 任务创建方式选择样式 */
        .creation-option {
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .creation-option:hover {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
        }
        
        .creation-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .creation-option:hover::before {
            left: 100%;
        }
        
        .guided-creation:hover {
            border-color: rgba(139, 92, 246, 0.8);
        }
        
        .direct-creation:hover {
            border-color: rgba(59, 130, 246, 0.8);
        }
        
        .option-icon {
            transition: transform 0.3s ease;
        }
        
        .creation-option:hover .option-icon {
            transform: scale(1.1);
        }

        /* 新建任务按钮增强样式 */
        .enhanced-add-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .enhanced-add-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .enhanced-add-btn:hover::after {
            left: 100%;
        }
        
        .enhanced-add-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(139, 92, 246, 0.4);
        }

        /* 元智能体对话界面样式 */
        .chat-header {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .agent-avatar {
            position: relative;
        }
        
        .agent-avatar::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8b5cf6, #a78bfa, #c4b5fd);
            z-index: -1;
            animation: avatarGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes avatarGlow {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .message-bubble {
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .agent-message .message-content {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid #8b5cf6;
        }
        
        .user-message {
            flex-direction: row-reverse;
        }
        
        .user-message .message-content {
            background: rgba(59, 130, 246, 0.1);
            border-right: 3px solid #3b82f6;
            margin-left: 0;
            margin-right: 12px;
        }
        
        .system-message .message-content {
            background: rgba(107, 114, 128, 0.1);
            border-left: 3px solid #6b7280;
            font-style: italic;
        }
        
        .message-avatar {
            flex-shrink: 0;
        }
        
        .message-content {
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .message-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 4px;
        }
        
        .message-sender {
            color: #e0e7ff;
        }
        
        .message-time {
            color: #9ca3af;
        }
        
        .message-text {
            color: #e0e7ff;
            line-height: 1.5;
        }
        
        /* 进度跟踪样式 */
        .progress-bar {
            position: relative;
        }
        
        .progress-fill {
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShimmer 2s infinite;
        }
        
        @keyframes progressShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .milestone {
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .milestone:hover {
            color: #c4b5fd;
        }
        
        .milestone.active {
            color: #8b5cf6;
            font-weight: 600;
            transform: scale(1.1);
        }
        
        .milestone.completed {
            color: #10b981;
            font-weight: 500;
        }
        
        .milestone.completed::before {
            content: '✓';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            color: #10b981;
            font-size: 12px;
            animation: checkmarkBounce 0.5s ease-out;
        }
        
        @keyframes checkmarkBounce {
            0% { transform: translateX(-50%) scale(0); }
            50% { transform: translateX(-50%) scale(1.2); }
            100% { transform: translateX(-50%) scale(1); }
        }
        
        /* 任务汇总样式 */
        .task-summary {
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: all 0.3s ease;
        }
        
        .task-summary.collapsed .summary-content {
            display: none;
        }
        
        .summary-grid {
            gap: 8px;
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .summary-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-value {
            font-weight: 500;
            color: #e0e7ff;
        }
        
        .summary-value.updated {
            animation: valueUpdate 0.5s ease-out;
            color: #8b5cf6;
        }
        
        @keyframes valueUpdate {
            0% { background: rgba(139, 92, 246, 0.3); }
            100% { background: transparent; }
        }
        
        .summary-tags {
            gap: 4px;
        }
        
        .summary-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        .summary-tag.new {
            animation: tagAppear 0.3s ease-out;
        }
        
        @keyframes tagAppear {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* 阶段指示器样式 */
        .phase-indicator {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            padding: 8px;
            border-left: 3px solid #8b5cf6;
        }
        
        .phase-value {
            color: #8b5cf6;
        }
        
        .phase-description {
            font-style: italic;
        }
        
        /* 进度动画增强 */
        .progress-fill.updating {
            animation: progressPulse 0.5s ease-out;
        }
        
        @keyframes progressPulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { box-shadow: 0 0 0 4px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }
        
        /* 里程碑工具提示 */
        .milestone::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        
        .milestone:hover::after {
            opacity: 1;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .progress-milestones {
                font-size: 9px;
            }
            
            .milestone::after {
                display: none;
            }
        }
        
        /* 输入区域样式 */
        .input-container {
            position: relative;
        }
        
        .input-hint {
            pointer-events: none;
        }
        
        .btn-send {
            min-width: 48px;
            height: 48px;
        }
        
        .btn-decompose {
            min-width: 48px;
            height: 48px;
        }
        
        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-send.loading {
            position: relative;
        }
        
        .btn-send.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .btn-send.loading i {
            opacity: 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 快速回复样式 */
        .quick-reply-btn {
            padding: 6px 12px;
            border-radius: 16px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #c4b5fd;
            font-size: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quick-reply-btn:hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-1px);
        }
        
        /* 复杂度分析样式 */
        .complexity-analysis {
            background: rgba(255, 165, 0, 0.05);
            border: 1px solid rgba(255, 165, 0, 0.2);
        }
        
        .complexity-analysis.collapsed .complexity-content {
            display: none;
        }
        
        .complexity-score-ring {
            position: relative;
        }
        
        .complexity-factors .factor-tag {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(255, 165, 0, 0.2);
            color: #f59e0b;
            border-radius: 10px;
            font-size: 10px;
            margin: 1px;
        }
        
        .complexity-threshold {
            position: relative;
        }
        
        .threshold-marker {
            position: absolute;
            top: -1px;
            transform: translateX(-50%);
        }
        
        /* 拆解按钮动态显示样式 */
        .btn-decompose {
            position: relative;
            overflow: hidden;
        }
        
        .btn-decompose.can-decompose {
            animation: pulse-decompose 2s infinite;
        }
        
        @keyframes pulse-decompose {
            0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); }
            100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); }
        }
        
        .btn-decompose::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-decompose.can-decompose::before {
            animation: shine-decompose 2s infinite;
        }
        
        @keyframes shine-decompose {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        /* 任务拆解结果样式 */
        .task-item {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
        }
        
        .task-item.main {
            border-left: 4px solid #8b5cf6;
        }
        
        .task-item.subtask {
            border-left: 4px solid #3b82f6;
            margin-left: 20px;
        }
        
        .task-priority {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .priority-high {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
        }
        
        .priority-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fed7aa;
        }
        
        .priority-low {
            background: rgba(59, 130, 246, 0.2);
            color: #bfdbfe;
        }
        
        .task-duration {
            color: #9ca3af;
            font-size: 12px;
        }
        
        .task-dependencies {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .task-duration {
            background: rgba(156, 163, 175, 0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
        }
        
        .task-complexity {
            background: rgba(255, 165, 0, 0.2);
            color: #f59e0b;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .dependency-tag {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-radius: 8px;
            font-size: 10px;
            margin: 1px;
        }
        
        .requirement-tag {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-radius: 8px;
            font-size: 10px;
            margin: 1px;
        }
        
        .deliverable-tag {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border-radius: 8px;
            font-size: 10px;
            margin: 1px;
        }
        
        .detail-label {
            font-weight: 500;
        }
        
        .task-type-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
        }
        
        .stat-icon {
            margin-bottom: 8px;
        }
        
        .stat-value {
            color: #e0e7ff;
        }
        
        .stat-label {
            color: #9ca3af;
        }
        
        /* 任务创建进度样式 */
        .creation-progress {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .progress-steps {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
        }
        
        .step {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .step.active {
            background: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
            transform: scale(1.05);
        }
        
        .step i {
            margin-right: 8px;
        }
        
        .creation-spinner {
            animation: pulse 2s infinite;
        }
        
        /* 成功状态样式 */
        .creation-success {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .success-animation i {
            animation: bounceIn 0.6s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .success-stats {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        /* 错误状态样式 */
        .creation-error {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .error-animation i {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .error-details {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .error-actions button {
            transition: all 0.3s ease;
        }
        
        .error-actions button:hover {
            transform: translateY(-2px);
        }
        
        /* 编辑工具栏样式 */
        .edit-toolbar {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .toolbar-info {
            color: #a78bfa;
        }
        
        .toolbar-actions button {
            transition: all 0.3s ease;
        }
        
        .toolbar-actions button:hover {
            transform: translateY(-1px);
        }
        
        .delete-task-btn {
            transition: all 0.3s ease;
        }
        
        .delete-task-btn:hover {
            transform: scale(1.05);
        }
        
        .dependency-tag {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            border-radius: 8px;
            font-size: 10px;
            background: rgba(107, 114, 128, 0.2);
            color: #d1d5db;
        }
        
        /* 依赖关系图样式 */
        .dependency-graph {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dependency-placeholder {
            text-align: center;
            opacity: 0.6;
        }
        
        /* 编辑模式样式 */
        .task-item.editing {
            background: rgba(139, 92, 246, 0.1);
            border-color: #8b5cf6;
        }
        
        .task-item.editing .task-content {
            display: none;
        }
        
        .task-item.editing .task-edit-form {
            display: block;
        }
        
        .task-edit-form {
            display: none;
        }
        
        .task-edit-form input,
        .task-edit-form textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px;
            color: #e0e7ff;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .task-edit-form input:focus,
        .task-edit-form textarea:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .chat-header {
                padding: 16px;
            }
            
            .agent-info h4 {
                font-size: 18px;
            }
            
            .chat-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .chat-actions button {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .input-actions {
                flex-direction: row;
                space-y: 0;
                gap: 8px;
            }
            
            .progress-milestones {
                font-size: 10px;
            }
            
            .milestone {
                writing-mode: vertical-rl;
                text-orientation: mixed;
            }
        }
        
        /* 打字指示器样式 */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8b5cf6;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* 时间轴样式 */
        .timeline-container {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(139, 92, 246, 0.3);
            transform: translateX(-50%);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
        }
        
        .timeline-item:nth-child(odd) {
            flex-direction: row-reverse;
        }
        
        .timeline-content {
            width: calc(50% - 40px);
            padding: 20px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            transition: all 0.3s ease;
        }
        
        .timeline-content:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }
        
        .timeline-dot {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            border: 3px solid white;
            z-index: 1;
        }
        
        .timeline-date {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: -30px;
            font-size: 14px;
            color: #e0e7ff;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .timeline-icon {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 2;
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
        }
        
        .timeline-title {
            font-size: 18px;
            font-weight: 600;
            color: #e0e7ff;
            margin-bottom: 8px;
        }
        
        .timeline-description {
            color: #e0e7ff;
            opacity: 0.8;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .timeline-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 6px;
            margin-top: 8px;
        }
        
        .tag-work {
            background: rgba(139, 92, 246, 0.2);
            color: #e0e7ff;
        }
        
        .tag-personal {
            background: rgba(16, 185, 129, 0.2);
            color: #d1fae5;
        }
        
        .tag-important {
            background: rgba(239, 68, 68, 0.2);
            color: #fee2e2;
        }
        
        @media (max-width: 768px) {
            .timeline-line {
                left: 20px;
            }
            
            .timeline-item {
                flex-direction: row !important;
                margin-left: 50px;
            }
            
            .timeline-content {
                width: calc(100% - 20px);
            }
            
            .timeline-dot, .timeline-icon {
                left: 20px;
            }
            
            .timeline-date {
                left: 60px;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- 星空背景 -->
    <div class="stars" id="stars"></div>
    
    <!-- 装饰性背景元素 -->
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    
    <div class="flex h-screen relative z-10">
        <!-- 侧边导航栏 -->
        <nav class="w-64 glass-morphism text-blue-100 p-6">
            <div class="mb-8">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-heart mr-3 text-purple-300"></i>
                    学办小星
                </h1>
            </div>
            
            <div class="space-y-2">
                <div class="nav-item p-3 rounded-lg" onclick="showPage('home')">
                    <i class="fas fa-home mr-3"></i>
                    主页
                </div>
                <div class="nav-item p-3 rounded-lg" onclick="showPage('chat')">
                    <i class="fas fa-clock mr-3"></i>
                    时光回音
                </div>
                <div class="nav-item p-3 rounded-lg" onclick="showPage('analytics')">
                    <i class="fas fa-chart-line mr-3"></i>
                    数据分析
                </div>
                <div class="nav-item p-3 rounded-lg" onclick="showPage('timeline')">
                    <i class="fas fa-timeline mr-3"></i>
                    时间轴
                </div>
                <div class="nav-item p-3 rounded-lg" onclick="showPage('tasks')">
                    <i class="fas fa-puzzle-piece mr-3"></i>
                    任务拼图
                </div>
                <div class="nav-item p-3 rounded-lg" onclick="showPage('agents')">
                    <i class="fas fa-robot mr-3"></i>
                    智能体管理
                </div>
                <div class="nav-item p-3 rounded-lg" onclick="showPage('dependencies')">
                    <i class="fas fa-project-diagram mr-3"></i>
                    任务依赖关系
                </div>
                <div class="nav-item p-3 rounded-lg" onclick="showPage('knowledge')">
                    <i class="fas fa-book mr-3"></i>
                    知识库管理
                </div>
                <div class="nav-item p-3 rounded-lg" onclick="showPage('taskDefinition')">
                    <i class="fas fa-tasks mr-3"></i>
                    任务定义界面
                </div>
            </div>
            
            <div class="absolute bottom-6 left-6 right-6">
                <div class="glass-morphism p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm">系统状态</span>
                        <span class="w-2 h-2 bg-purple-400 rounded-full pulse-animation"></span>
                    </div>
                    <p class="text-xs opacity-80">时光引擎运行正常</p>
                </div>
            </div>
        </nav>
        
        <!-- 主内容区域 -->
        <main class="flex-1 p-8 overflow-auto">
            <!-- 主页 -->
            <div id="home" class="page active">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-4xl font-bold text-blue-100 mb-8 flex items-center">
                        <span class="mr-3">✨</span>
                        欢迎使用学办小星
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="feature-card glass-morphism p-6 rounded-xl text-blue-100 cursor-pointer" onclick="showPage('chat')">
                            <div class="feature-icon text-4xl mb-4">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">时光回音</h3>
                            <p class="opacity-80">与AI助手进行时光对话，记录美好瞬间</p>
                            <div class="mt-4 flex space-x-1">
                                <span class="sparkle" style="top: 20%; left: 10%;"></span>
                                <span class="sparkle" style="top: 60%; left: 80%; animation-delay: 1s;"></span>
                                <span class="sparkle" style="top: 40%; left: 50%; animation-delay: 2s;"></span>
                            </div>
                        </div>
                        
                        <div class="feature-card glass-morphism p-6 rounded-xl text-blue-100 cursor-pointer" onclick="showPage('analytics')">
                            <div class="feature-icon text-4xl mb-4">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">数据分析</h3>
                            <p class="opacity-80">可视化数据展示，深度洞察时光轨迹</p>
                        </div>
                        
                        <div class="feature-card glass-morphism p-6 rounded-xl text-blue-100 cursor-pointer" onclick="showPage('tasks')">
                            <div class="feature-icon text-4xl mb-4">
                                <i class="fas fa-puzzle-piece"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">任务拼图</h3>
                            <p class="opacity-80">拼凑任务碎片，完成生活画卷</p>
                        </div>
                    </div>
                    
                    <div class="glass-morphism p-6 rounded-xl text-blue-100">
                        <h3 class="text-2xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-magic mr-2 text-purple-300"></i>
                            快速操作
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="openAddTaskModal()" class="p-4 glass-morphism rounded-lg hover:bg-white hover:bg-opacity-10 transition-all hover:scale-105">
                                <i class="fas fa-plus-circle text-2xl mb-2 text-purple-300"></i>
                                <p>新建任务</p>
                            </button>
                            <button onclick="showPage('tasks')" class="p-4 glass-morphism rounded-lg hover:bg-white hover:bg-opacity-10 transition-all hover:scale-105">
                                <i class="fas fa-calendar text-2xl mb-2 text-purple-300"></i>
                                <p>查看日程</p>
                            </button>
                            <button onclick="exportData()" class="p-4 glass-morphism rounded-lg hover:bg-white hover:bg-opacity-10 transition-all hover:scale-105">
                                <i class="fas fa-download text-2xl mb-2 text-purple-300"></i>
                                <p>导出数据</p>
                            </button>
                            <button onclick="importData()" class="p-4 glass-morphism rounded-lg hover:bg-white hover:bg-opacity-10 transition-all hover:scale-105">
                                <i class="fas fa-upload text-2xl mb-2 text-purple-300"></i>
                                <p>导入数据</p>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 时光回音页面 -->
            <div id="chat" class="page">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-blue-100 mb-6 flex items-center">
                        <i class="fas fa-clock mr-3 text-purple-300"></i>
                        时光回音
                    </h2>
                    
                    <div class="glass-morphism rounded-xl p-6 h-[600px] flex flex-col">
                        <div class="flex-1 overflow-y-auto mb-4 space-y-4" id="chatMessages">
                            <div class="chat-bubble">
                                <div class="flex items-start">
                                    <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="glass-morphism p-4 rounded-lg max-w-md">
                                        <p class="text-blue-100">🌸 欢迎来到时光回音，我是您的时光守护者，让我们一起记录美好时光吧！</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <input type="text" id="chatInput" placeholder="分享您的时光故事..." 
                                   class="flex-1 p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                            <button onclick="sendMessage()" class="btn-blue px-6 py-3 text-white rounded-lg">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button class="px-4 py-3 glass-morphism text-blue-100 rounded-lg hover:bg-white hover:bg-opacity-10 transition">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据分析页面 -->
            <div id="analytics" class="page">
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-blue-100 mb-6 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-purple-300"></i>
                        数据分析
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="data-card glass-morphism p-4 rounded-xl text-blue-100">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm opacity-80">总任务数</span>
                                <i class="fas fa-tasks opacity-60 text-purple-300"></i>
                            </div>
                            <p class="text-2xl font-bold">156</p>
                            <p class="text-xs opacity-60 mt-1">↑ 12% 较上月</p>
                        </div>
                        
                        <div class="data-card glass-morphism p-4 rounded-xl text-blue-100">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm opacity-80">完成率</span>
                                <i class="fas fa-check-circle opacity-60 text-purple-300"></i>
                            </div>
                            <p class="text-2xl font-bold">78%</p>
                            <p class="text-xs opacity-60 mt-1">↑ 5% 较上月</p>
                        </div>
                        
                        <div class="data-card glass-morphism p-4 rounded-xl text-blue-100">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm opacity-80">进行中</span>
                                <i class="fas fa-spinner opacity-60 text-purple-300"></i>
                            </div>
                            <p class="text-2xl font-bold">34</p>
                            <p class="text-xs opacity-60 mt-1">↓ 3% 较上月</p>
                        </div>
                        
                        <div class="data-card glass-morphism p-4 rounded-xl text-blue-100">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm opacity-80">效率指数</span>
                                <i class="fas fa-chart-line opacity-60 text-purple-300"></i>
                            </div>
                            <p class="text-2xl font-bold">92</p>
                            <p class="text-xs opacity-60 mt-1">↑ 8% 较上月</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-morphism p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-blue-100 mb-4">任务完成趋势</h3>
                            <canvas id="trendChart"></canvas>
                        </div>
                        
                        <div class="glass-morphism p-6 rounded-xl">
                            <h3 class="text-xl font-semibold text-blue-100 mb-4">任务分类统计</h3>
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 时间轴页面 -->
            <div id="timeline" class="page">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-blue-100 mb-6 flex items-center">
                        <i class="fas fa-timeline mr-3 text-purple-300"></i>
                        时光轨迹
                    </h2>
                    
                    <div class="glass-morphism rounded-xl p-6 mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div class="mb-4 md:mb-0">
                                <h3 class="text-xl font-semibold text-blue-100">记录重要时刻</h3>
                                <p class="text-sm opacity-80 mt-1">在时光长河中标记您的里程碑</p>
                            </div>
                            <button class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                                <i class="fas fa-plus mr-2"></i>
                                添加事件
                            </button>
                        </div>
                        
                        <div class="timeline-container">
                            <div class="timeline-line"></div>
                            
                            <!-- 时间轴项目1 -->
                            <div class="timeline-item">
                                <div class="timeline-content">
                                    <div class="timeline-date">2024年1月15日</div>
                                    <h4 class="timeline-title">项目启动</h4>
                                    <p class="timeline-description">正式启动学办小星项目，开始为期三个月的开发周期。团队成员齐聚一堂，共同规划项目蓝图。</p>
                                    <div>
                                        <span class="timeline-tag tag-work">工作</span>
                                        <span class="timeline-tag tag-important">重要</span>
                                    </div>
                                </div>
                                <div class="timeline-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                            </div>
                            
                            <!-- 时间轴项目2 -->
                            <div class="timeline-item">
                                <div class="timeline-content">
                                    <div class="timeline-date">2024年1月20日</div>
                                    <h4 class="timeline-title">完成原型设计</h4>
                                    <p class="timeline-description">完成了系统的整体原型设计，包括用户界面、交互流程和核心功能模块的规划。</p>
                                    <div>
                                        <span class="timeline-tag tag-work">工作</span>
                                    </div>
                                </div>
                                <div class="timeline-icon">
                                    <i class="fas fa-pencil-ruler"></i>
                                </div>
                            </div>
                            
                            <!-- 时间轴项目3 -->
                            <div class="timeline-item">
                                <div class="timeline-content">
                                    <div class="timeline-date">2024年2月5日</div>
                                    <h4 class="timeline-title">团队建设活动</h4>
                                    <p class="timeline-description">组织了一次团队建设活动，增进了团队成员之间的了解和协作能力，为后续工作打下良好基础。</p>
                                    <div>
                                        <span class="timeline-tag tag-personal">个人</span>
                                    </div>
                                </div>
                                <div class="timeline-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            
                            <!-- 时间轴项目4 -->
                            <div class="timeline-item">
                                <div class="timeline-content">
                                    <div class="timeline-date">2024年2月18日</div>
                                    <h4 class="timeline-title">第一阶段测试</h4>
                                    <p class="timeline-description">完成了第一阶段的系统测试，修复了多个关键问题，系统稳定性得到显著提升。</p>
                                    <div>
                                        <span class="timeline-tag tag-work">工作</span>
                                    </div>
                                </div>
                                <div class="timeline-icon">
                                    <i class="fas fa-bug"></i>
                                </div>
                            </div>
                            
                            <!-- 时间轴项目5 -->
                            <div class="timeline-item">
                                <div class="timeline-content">
                                    <div class="timeline-date">2024年3月1日</div>
                                    <h4 class="timeline-title">用户反馈收集</h4>
                                    <p class="timeline-description">开始收集早期用户的反馈意见，为产品优化提供重要参考，用户体验得到进一步改善。</p>
                                    <div>
                                        <span class="timeline-tag tag-work">工作</span>
                                        <span class="timeline-tag tag-important">重要</span>
                                    </div>
                                </div>
                                <div class="timeline-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 任务拼图页面 - 替换为3.html中的任务管理界面 -->
            <div id="tasks" class="page">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-blue-100 mb-6 flex items-center">
                        <i class="fas fa-puzzle-piece mr-3 text-purple-300"></i>
                        任务管理中心
                    </h2>
                    
                    <!-- 统计卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="glass-morphism rounded-xl p-6 text-blue-100 hover-scale fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-white bg-opacity-10 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clipboard-list text-2xl"></i>
                                </div>
                                <span class="text-3xl font-bold">24</span>
                            </div>
                            <p class="text-sm opacity-75">总任务数</p>
                            <div class="mt-2 text-xs">
                                <span class="text-green-300">↑ 12%</span> 较上周
                            </div>
                        </div>
                        
                        <div class="glass-morphism rounded-xl p-6 text-blue-100 hover-scale fade-in" style="animation-delay: 0.1s">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-white bg-opacity-10 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-2xl"></i>
                                </div>
                                <span class="text-3xl font-bold">18</span>
                            </div>
                            <p class="text-sm opacity-75">已完成</p>
                            <div class="mt-2 text-xs">
                                <span class="text-green-300">↑ 8%</span> 完成率
                            </div>
                        </div>
                        
                        <div class="glass-morphism rounded-xl p-6 text-blue-100 hover-scale fade-in" style="animation-delay: 0.2s">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-white bg-opacity-10 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-2xl"></i>
                                </div>
                                <span class="text-3xl font-bold">6</span>
                            </div>
                            <p class="text-sm opacity-75">进行中</p>
                            <div class="mt-2 text-xs">
                                <span class="text-yellow-300">→ 0%</span> 无变化
                            </div>
                        </div>
                        
                        <div class="glass-morphism rounded-xl p-6 text-blue-100 hover-scale fade-in" style="animation-delay: 0.3s">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-white bg-opacity-10 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                                </div>
                                <span class="text-3xl font-bold">3</span>
                            </div>
                            <p class="text-sm opacity-75">紧急任务</p>
                            <div class="mt-2 text-xs">
                                <span class="text-red-300">↑ 2</span> 新增
                            </div>
                        </div>
                    </div>
                    
                    <!-- 任务操作栏 -->
                    <div class="glass-morphism rounded-xl p-4 mb-6 text-blue-100 fade-in" style="animation-delay: 0.4s">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                            <div class="flex items-center space-x-4">
                                <button onclick="openAddTaskModal()" class="enhanced-add-btn px-6 py-3 rounded-lg text-white font-medium flex items-center">
                                    <i class="fas fa-plus mr-2"></i>新建任务
                                </button>
                                <button onclick="filterTasks('all')" class="px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                                    全部
                                </button>
                                <button onclick="filterTasks('today')" class="px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                                    今日
                                </button>
                                <button onclick="filterTasks('week')" class="px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                                    本周
                                </button>
                                <button onclick="filterTasks('completed')" class="px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                                    已完成
                                </button>
                                <button onclick="filterTasks('pending')" class="px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                                    待完成
                                </button>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <input type="text" placeholder="搜索任务..." class="bg-white bg-opacity-10 rounded-lg px-4 py-2 pr-10 text-blue-100 placeholder-blue-300 focus:outline-none focus:bg-opacity-20 transition-all">
                                    <i class="fas fa-search absolute right-3 top-3 opacity-75"></i>
                                </div>
                                <button onclick="toggleView()" class="interactive-button p-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                                    <i class="fas fa-th-large"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 任务列表 -->
                    <div class="space-y-4" id="taskList">
                        <!-- 新建任务卡片 -->
                        <div class="add-task-card glass-morphism rounded-xl p-6 text-blue-100 fade-in" style="animation-delay: 0.4s" onclick="openAddTaskModal()">
                            <div class="flex items-center justify-center h-24">
                                <div class="text-center">
                                    <i class="fas fa-plus-circle text-4xl mb-2 text-purple-300"></i>
                                    <p class="text-lg font-medium">创建新任务</p>
                                    <p class="text-sm opacity-75">点击添加新的任务拼图</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 任务卡片1 -->
                        <div class="glass-morphism rounded-xl p-6 text-blue-100 task-card fade-in" style="animation-delay: 0.5s" onclick="openTaskDetail(1)">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <input type="checkbox" class="mr-3 w-5 h-5 rounded" onclick="event.stopPropagation(); toggleTaskComplete(this)">
                                        <h3 class="text-lg font-semibold">完成项目提案文档</h3>
                                        <span class="ml-3 px-2 py-1 bg-red-500 bg-opacity-30 text-xs rounded-full">紧急</span>
                                    </div>
                                    <p class="text-sm opacity-75 mb-3">需要准备下周一的项目提案演示文档，包括市场分析和技术方案</p>
                                    <div class="flex items-center text-xs space-x-4">
                                        <span><i class="far fa-calendar mr-1"></i>截止: 2024-01-15</span>
                                        <span><i class="far fa-clock mr-1"></i>剩余2天</span>
                                        <span><i class="far fa-user mr-1"></i>负责人: 张三</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <svg class="progress-ring" width="60" height="60">
                                        <circle class="progress-ring-circle" stroke="#e0e7ff" stroke-width="4" fill="transparent" r="54" cx="30" cy="30" style="stroke-dashoffset: 135.7168"/>
                                    </svg>
                                    <div class="text-center -mt-10 text-sm">60%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 任务卡片2 -->
                        <div class="glass-morphism rounded-xl p-6 text-blue-100 task-card fade-in" style="animation-delay: 0.6s" onclick="openTaskDetail(2)">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <input type="checkbox" class="mr-3 w-5 h-5 rounded" onclick="event.stopPropagation(); toggleTaskComplete(this)">
                                        <h3 class="text-lg font-semibold">代码审查和优化</h3>
                                        <span class="ml-3 px-2 py-1 bg-blue-500 bg-opacity-30 text-xs rounded-full">进行中</span>
                                    </div>
                                    <p class="text-sm opacity-75 mb-3">审查新功能模块的代码，进行性能优化和安全检查</p>
                                    <div class="flex items-center text-xs space-x-4">
                                        <span><i class="far fa-calendar mr-1"></i>截止: 2024-01-18</span>
                                        <span><i class="far fa-clock mr-1"></i>剩余5天</span>
                                        <span><i class="far fa-user mr-1"></i>负责人: 李四</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <svg class="progress-ring" width="60" height="60">
                                        <circle class="progress-ring-circle" stroke="#e0e7ff" stroke-width="4" fill="transparent" r="54" cx="30" cy="30" style="stroke-dashoffset: 203.5752"/>
                                    </svg>
                                    <div class="text-center -mt-10 text-sm">40%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 任务卡片3 -->
                        <div class="glass-morphism rounded-xl p-6 text-blue-100 task-card fade-in" style="animation-delay: 0.7s" onclick="openTaskDetail(3)">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <input type="checkbox" checked class="mr-3 w-5 h-5 rounded" onclick="event.stopPropagation(); toggleTaskComplete(this)">
                                        <h3 class="text-lg font-semibold line-through opacity-50">团队周会准备</h3>
                                        <span class="ml-3 px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">已完成</span>
                                    </div>
                                    <p class="text-sm opacity-50 mb-3">准备本周团队会议的议程和材料</p>
                                    <div class="flex items-center text-xs space-x-4">
                                        <span><i class="far fa-calendar mr-1"></i>完成: 2024-01-13</span>
                                        <span><i class="far fa-user mr-1"></i>负责人: 王五</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <svg class="progress-ring" width="60" height="60">
                                        <circle class="progress-ring-circle" stroke="#e0e7ff" stroke-width="4" fill="transparent" r="54" cx="30" cy="30" style="stroke-dashoffset: 0"/>
                                    </svg>
                                    <div class="text-center -mt-10 text-sm">100%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 智能体管理页面 -->
            <div id="agents" class="page">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-blue-100 mb-6 flex items-center">
                        <i class="fas fa-robot mr-3 text-purple-300"></i>
                        智能体管理
                    </h2>
                    
                    <!-- 大模型配置区域 -->
                    <div class="glass-morphism rounded-xl p-6 mb-6" id="llm-config-section">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div class="mb-4 md:mb-0">
                                <h3 class="text-xl font-semibold text-blue-100 flex items-center">
                                    <i class="fas fa-brain mr-2 text-purple-300"></i>
                                    大模型配置
                                </h3>
                                <p class="text-sm opacity-80 mt-1">配置和管理大语言模型，为智能体提供AI能力</p>
                            </div>
                            <button onclick="openLLMConfigModal()" class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                                <i class="fas fa-plus mr-2"></i>
                                添加配置
                            </button>
                        </div>
                        
                        <!-- 配置统计摘要 -->
                        <div id="llm-config-summary" class="mb-6 p-4 glass-morphism rounded-lg">
                            <!-- 统计信息将通过JavaScript动态生成 -->
                        </div>
                        
                        <!-- 配置列表 -->
                        <div id="llm-config-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- 配置卡片将通过JavaScript动态生成 -->
                            <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center border-2 border-dashed border-purple-300 border-opacity-50">
                                <div class="py-8">
                                    <i class="fas fa-plus-circle text-4xl text-purple-300 mb-3"></i>
                                    <p class="text-lg font-medium">添加大模型配置</p>
                                    <p class="text-sm opacity-75 mt-1">点击上方按钮开始配置</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 智能体管理中心 -->
                    <div class="glass-morphism rounded-xl p-6 mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div class="mb-4 md:mb-0">
                                <h3 class="text-xl font-semibold text-blue-100 flex items-center">
                                    <i class="fas fa-robot mr-2 text-purple-300"></i>
                                    智能体管理中心
                                </h3>
                                <p class="text-sm opacity-80 mt-1">管理和监控您的AI智能体，实时查看状态和性能</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="refreshAgents()" class="px-4 py-2 glass-morphism text-blue-100 rounded-lg hover:bg-white hover:bg-opacity-10 transition flex items-center">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    刷新
                                </button>
                                <button class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                                    <i class="fas fa-plus mr-2"></i>
                                    创建智能体
                                </button>
                            </div>
                        </div>
                        
                        <!-- 智能体统计摘要 -->
                        <div id="agent-summary" class="mb-6 p-4 glass-morphism rounded-lg">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-blue-100" id="total-agents">0</div>
                                    <div class="text-sm opacity-75">总智能体</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-400" id="active-agents">0</div>
                                    <div class="text-sm opacity-75">活跃中</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-yellow-400" id="busy-agents">0</div>
                                    <div class="text-sm opacity-75">忙碌中</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-purple-400" id="avg-success-rate">0%</div>
                                    <div class="text-sm opacity-75">平均成功率</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 智能体列表 -->
                        <div id="agent-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- 智能体卡片将通过JavaScript动态生成 -->
                            <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center border-2 border-dashed border-purple-300 border-opacity-50">
                                <div class="py-8">
                                    <i class="fas fa-robot text-4xl text-purple-300 mb-3"></i>
                                    <p class="text-lg font-medium">加载智能体中...</p>
                                    <p class="text-sm opacity-75 mt-1">正在从后端获取智能体信息</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 任务依赖关系页面 -->
            <div id="dependencies" class="page">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-blue-100 mb-6 flex items-center">
                        <i class="fas fa-project-diagram mr-3 text-purple-300"></i>
                        任务依赖关系
                    </h2>
                    
                    <div class="glass-morphism rounded-xl p-6 mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div class="mb-4 md:mb-0">
                                <h3 class="text-xl font-semibold text-blue-100">依赖关系图谱</h3>
                                <p class="text-sm opacity-80 mt-1">可视化任务之间的依赖关系，优化工作流程</p>
                            </div>
                            <div class="flex space-x-3">
                                <button class="px-4 py-2 glass-morphism rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                                    <i class="fas fa-expand mr-2"></i>
                                    全屏查看
                                </button>
                                <button class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                                    <i class="fas fa-plus mr-2"></i>
                                    添加依赖
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white bg-opacity-5 rounded-xl p-8 h-96 flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-project-diagram text-6xl text-purple-300 mb-4"></i>
                                <p class="text-blue-100 text-lg">任务依赖关系可视化图表</p>
                                <p class="text-blue-100 opacity-75 text-sm mt-2">显示任务之间的前后置关系和依赖路径</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="glass-morphism rounded-lg p-4 text-blue-100">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-link mr-2 text-purple-300"></i>
                                    <h4 class="font-semibold">关键路径</h4>
                                </div>
                                <p class="text-sm opacity-80">识别影响项目进度的关键任务链</p>
                            </div>
                            <div class="glass-morphism rounded-lg p-4 text-blue-100">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2 text-yellow-300"></i>
                                    <h4 class="font-semibold">风险任务</h4>
                                </div>
                                <p class="text-sm opacity-80">标记可能影响项目进度的风险任务</p>
                            </div>
                            <div class="glass-morphism rounded-lg p-4 text-blue-100">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-clock mr-2 text-green-300"></i>
                                    <h4 class="font-semibold">时间估算</h4>
                                </div>
                                <p class="text-sm opacity-80">基于依赖关系计算项目完成时间</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 知识库管理页面 -->
            <div id="knowledge" class="page">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-blue-100 mb-6 flex items-center">
                        <i class="fas fa-book mr-3 text-purple-300"></i>
                        知识库管理
                    </h2>
                    
                    <div class="glass-morphism rounded-xl p-6 mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div class="mb-4 md:mb-0">
                                <h3 class="text-xl font-semibold text-blue-100">知识库中心</h3>
                                <p class="text-sm opacity-80 mt-1">组织和管理您的知识资源，构建智能知识体系</p>
                            </div>
                            <button class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                                <i class="fas fa-plus mr-2"></i>
                                添加知识
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center">
                                <i class="fas fa-folder text-3xl text-purple-300 mb-2"></i>
                                <p class="font-semibold">文档库</p>
                                <p class="text-2xl font-bold mt-2">128</p>
                                <p class="text-xs opacity-75">文档数量</p>
                            </div>
                            <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center">
                                <i class="fas fa-tags text-3xl text-purple-300 mb-2"></i>
                                <p class="font-semibold">标签</p>
                                <p class="text-2xl font-bold mt-2">46</p>
                                <p class="text-xs opacity-75">分类标签</p>
                            </div>
                            <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center">
                                <i class="fas fa-users text-3xl text-purple-300 mb-2"></i>
                                <p class="font-semibold">贡献者</p>
                                <p class="text-2xl font-bold mt-2">12</p>
                                <p class="text-xs opacity-75">活跃成员</p>
                            </div>
                            <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center">
                                <i class="fas fa-search text-3xl text-purple-300 mb-2"></i>
                                <p class="font-semibold">搜索</p>
                                <p class="text-2xl font-bold mt-2">324</p>
                                <p class="text-xs opacity-75">今日搜索</p>
                            </div>
                        </div>
                        
                        <div class="glass-morphism rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-blue-100">最近文档</h4>
                                <button class="text-purple-300 hover:text-purple-200 text-sm">
                                    查看全部 <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-white bg-opacity-5 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-alt text-purple-300 mr-3"></i>
                                        <div>
                                            <p class="font-medium">项目需求文档</p>
                                            <p class="text-xs opacity-75">更新于 2小时前</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <span class="px-2 py-1 bg-blue-500 bg-opacity-30 text-xs rounded-full">项目</span>
                                        <span class="px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">已审核</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white bg-opacity-5 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-alt text-purple-300 mr-3"></i>
                                        <div>
                                            <p class="font-medium">技术架构设计</p>
                                            <p class="text-xs opacity-75">更新于 1天前</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <span class="px-2 py-1 bg-purple-500 bg-opacity-30 text-xs rounded-full">技术</span>
                                        <span class="px-2 py-1 bg-yellow-500 bg-opacity-30 text-xs rounded-full">草稿</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white bg-opacity-5 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-alt text-purple-300 mr-3"></i>
                                        <div>
                                            <p class="font-medium">用户手册</p>
                                            <p class="text-xs opacity-75">更新于 3天前</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <span class="px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">文档</span>
                                        <span class="px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">已发布</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 任务定义界面页面 -->
            <div id="taskDefinition" class="page">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-blue-100 mb-6 flex items-center">
                        <i class="fas fa-tasks mr-3 text-purple-300"></i>
                        任务定义界面
                    </h2>
                    
                    <div class="glass-morphism rounded-xl p-6 mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div class="mb-4 md:mb-0">
                                <h3 class="text-xl font-semibold text-blue-100">任务模板库</h3>
                                <p class="text-sm opacity-80 mt-1">创建和管理任务模板，标准化任务流程</p>
                            </div>
                            <button class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                                <i class="fas fa-plus mr-2"></i>
                                创建模板
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- 任务模板卡片1 -->
                            <div class="glass-morphism rounded-xl p-6 text-blue-100 hover-scale">
                                <div class="flex items-center mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-purple-400 to-purple-600 rounded-lg flex items-center justify-center text-white mr-3">
                                        <i class="fas fa-briefcase"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold">项目开发任务</h4>
                                        <p class="text-xs opacity-75">使用次数: 24</p>
                                    </div>
                                </div>
                                <p class="text-sm opacity-80 mb-4">标准项目开发流程模板，包含需求分析、设计、开发、测试等阶段。</p>
                                <div class="flex justify-between items-center">
                                    <div class="flex space-x-2">
                                        <span class="px-2 py-1 bg-blue-500 bg-opacity-30 text-xs rounded-full">开发</span>
                                        <span class="px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">已验证</span>
                                    </div>
                                    <button class="text-purple-300 hover:text-purple-200">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 任务模板卡片2 -->
                            <div class="glass-morphism rounded-xl p-6 text-blue-100 hover-scale">
                                <div class="flex items-center mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg flex items-center justify-center text-white mr-3">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold">数据分析任务</h4>
                                        <p class="text-xs opacity-75">使用次数: 18</p>
                                    </div>
                                </div>
                                <p class="text-sm opacity-80 mb-4">数据分析标准流程，包含数据收集、清洗、分析和报告生成。</p>
                                <div class="flex justify-between items-center">
                                    <div class="flex space-x-2">
                                        <span class="px-2 py-1 bg-purple-500 bg-opacity-30 text-xs rounded-full">分析</span>
                                        <span class="px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">已验证</span>
                                    </div>
                                    <button class="text-purple-300 hover:text-purple-200">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 任务模板卡片3 -->
                            <div class="glass-morphism rounded-xl p-6 text-blue-100 hover-scale">
                                <div class="flex items-center mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-green-400 to-green-600 rounded-lg flex items-center justify-center text-white mr-3">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold">会议组织任务</h4>
                                        <p class="text-xs opacity-75">使用次数: 32</p>
                                    </div>
                                </div>
                                <p class="text-sm opacity-80 mb-4">会议组织标准流程，包含会前准备、会中记录和会后跟进。</p>
                                <div class="flex justify-between items-center">
                                    <div class="flex space-x-2">
                                        <span class="px-2 py-1 bg-yellow-500 bg-opacity-30 text-xs rounded-full">会议</span>
                                        <span class="px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">已验证</span>
                                    </div>
                                    <button class="text-purple-300 hover:text-purple-200">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 glass-morphism rounded-lg p-4">
                            <h4 class="font-semibold text-blue-100 mb-3">自定义任务字段</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white bg-opacity-5 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="font-medium">优先级</p>
                                        <span class="px-2 py-1 bg-purple-500 bg-opacity-30 text-xs rounded-full">必填</span>
                                    </div>
                                    <p class="text-sm opacity-75">选项: 低、中、高、紧急</p>
                                </div>
                                <div class="bg-white bg-opacity-5 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="font-medium">工作量估算</p>
                                        <span class="px-2 py-1 bg-gray-500 bg-opacity-30 text-xs rounded-full">可选</span>
                                    </div>
                                    <p class="text-sm opacity-75">类型: 数字 (小时)</p>
                                </div>
                                <div class="bg-white bg-opacity-5 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="font-medium">关联项目</p>
                                        <span class="px-2 py-1 bg-purple-500 bg-opacity-30 text-xs rounded-full">必填</span>
                                    </div>
                                    <p class="text-sm opacity-75">类型: 下拉选择</p>
                                </div>
                                <div class="bg-white bg-opacity-5 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="font-medium">标签</p>
                                        <span class="px-2 py-1 bg-gray-500 bg-opacity-30 text-xs rounded-full">可选</span>
                                    </div>
                                    <p class="text-sm opacity-75">类型: 多选标签</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 任务创建方式选择模态框 -->
    <div id="taskCreationModeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="glass-morphism rounded-xl p-6 w-full max-w-2xl text-blue-100 fade-in">
            <h3 class="text-2xl font-semibold mb-6 text-center flex items-center justify-center">
                <i class="fas fa-puzzle-piece mr-3 text-purple-300"></i>
                选择任务创建方式
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- 智能引导创建选项 -->
                <div class="creation-option guided-creation glass-morphism rounded-xl p-6 cursor-pointer transition-all hover:scale-105 hover:shadow-lg" onclick="selectCreationMode('guided')">
                    <div class="text-center">
                        <div class="option-icon mb-4">
                            <i class="fas fa-robot text-5xl text-purple-300"></i>
                        </div>
                        <div class="option-content">
                            <h4 class="text-xl font-semibold mb-3">智能引导创建</h4>
                            <p class="text-sm opacity-80 mb-4">通过元智能体对话，获得智能的任务规划建议和详细分解</p>
                            <div class="text-xs opacity-70 space-y-1">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-check mr-2 text-green-400"></i>
                                    <span>智能任务分析</span>
                                </div>
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-check mr-2 text-green-400"></i>
                                    <span>自动任务拆解</span>
                                </div>
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-check mr-2 text-green-400"></i>
                                    <span>优化建议</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-select-option mt-4 w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition-all">
                            选择此方式
                        </button>
                    </div>
                </div>
                
                <!-- 直接创建选项 -->
                <div class="creation-option direct-creation glass-morphism rounded-xl p-6 cursor-pointer transition-all hover:scale-105 hover:shadow-lg" onclick="selectCreationMode('direct')">
                    <div class="text-center">
                        <div class="option-icon mb-4">
                            <i class="fas fa-edit text-5xl text-blue-300"></i>
                        </div>
                        <div class="option-content">
                            <h4 class="text-xl font-semibold mb-3">直接创建</h4>
                            <p class="text-sm opacity-80 mb-4">直接填写任务信息，快速创建任务，适合简单明确的任务</p>
                            <div class="text-xs opacity-70 space-y-1">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-check mr-2 text-green-400"></i>
                                    <span>快速创建</span>
                                </div>
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-check mr-2 text-green-400"></i>
                                    <span>简单直接</span>
                                </div>
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-check mr-2 text-green-400"></i>
                                    <span>完全控制</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn-select-option mt-4 w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-all">
                            选择此方式
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center">
                <button onclick="closeTaskCreationModeModal()" class="px-6 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- 添加任务模态框 -->
    <div id="addTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="glass-morphism rounded-xl p-6 w-full max-w-md text-blue-100 fade-in">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-plus-circle mr-2 text-purple-300"></i>
                创建新任务
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">任务名称</label>
                    <input type="text" class="w-full bg-white bg-opacity-10 rounded-lg px-3 py-2 focus:outline-none focus:bg-opacity-20 text-blue-100" placeholder="输入任务名称">
                </div>
                
                <div>
                    <label class="block text-sm mb-2">任务描述</label>
                    <textarea class="w-full bg-white bg-opacity-10 rounded-lg px-3 py-2 focus:outline-none focus:bg-opacity-20 text-blue-100" rows="3" placeholder="输入任务描述"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">优先级</label>
                    <select class="w-full bg-white bg-opacity-10 rounded-lg px-3 py-2 focus:outline-none focus:bg-opacity-20 text-blue-100">
                        <option>低</option>
                        <option>中</option>
                        <option>高</option>
                        <option>紧急</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">截止日期</label>
                    <input type="date" class="w-full bg-white bg-opacity-10 rounded-lg px-3 py-2 focus:outline-none focus:bg-opacity-20 text-blue-100">
                </div>
                
                <div>
                    <label class="block text-sm mb-2">负责人</label>
                    <input type="text" class="w-full bg-white bg-opacity-10 rounded-lg px-3 py-2 focus:outline-none focus:bg-opacity-20 text-blue-100" placeholder="输入负责人姓名">
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeAddTaskModal()" class="px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all">
                    取消
                </button>
                <button onclick="saveTask()" class="px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-700 transition-all text-white">
                    创建任务
                </button>
            </div>
        </div>
    </div>

    <!-- 元智能体对话界面模态框 -->
    <div id="metaAgentChatModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="glass-morphism rounded-xl w-full max-w-4xl h-[80vh] text-blue-100 fade-in flex flex-col">
            <!-- 对话头部 -->
            <div class="chat-header flex items-center justify-between p-6 border-b border-white border-opacity-20">
                <div class="agent-info flex items-center">
                    <div class="agent-avatar w-12 h-12 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-4">
                        <i class="fas fa-robot text-xl"></i>
                    </div>
                    <div class="agent-details">
                        <h4 class="text-xl font-semibold">元智能体</h4>
                        <span class="agent-status text-sm opacity-75 flex items-center">
                            <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                            在线
                        </span>
                    </div>
                </div>
                <div class="chat-actions flex space-x-3">
                    <button onclick="restartMetaAgentChat()" class="btn-reset-chat px-4 py-2 glass-morphism rounded-lg hover:bg-white hover:bg-opacity-10 transition-all flex items-center">
                        <i class="fas fa-redo mr-2"></i>
                        重新开始
                    </button>
                    <button onclick="closeMetaAgentChat()" class="btn-close-chat px-4 py-2 glass-morphism rounded-lg hover:bg-white hover:bg-opacity-10 transition-all flex items-center">
                        <i class="fas fa-times mr-2"></i>
                        关闭对话
                    </button>
                </div>
            </div>
            
            <!-- 对话消息区域 -->
            <div class="chat-messages flex-1 overflow-y-auto p-6 space-y-4" id="metaAgentMessages">
                <!-- 欢迎消息 -->
                <div class="message-bubble agent-message">
                    <div class="flex items-start">
                        <div class="message-avatar w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content glass-morphism p-4 rounded-lg max-w-md">
                            <div class="message-header flex items-center mb-2">
                                <span class="message-sender font-medium">元智能体</span>
                                <span class="message-time text-xs opacity-60 ml-2" id="welcome-time"></span>
                            </div>
                            <p class="message-text">🤖 您好！我是元智能体，专门帮助您创建和规划任务。请告诉我您想要创建什么样的任务，我会通过一系列问题来帮助您完善任务细节。</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 进度跟踪区域 -->
            <div class="chat-progress p-4 border-t border-white border-opacity-20">
                <!-- 进度信息 -->
                <div class="progress-info flex items-center justify-between mb-2">
                    <span class="progress-text text-sm opacity-80" id="progressText">等待开始任务创建...</span>
                    <span class="progress-percentage text-sm font-medium" id="progressPercentage">0%</span>
                </div>
                
                <!-- 进度条 -->
                <div class="progress-bar w-full h-2 bg-white bg-opacity-10 rounded-full overflow-hidden mb-3">
                    <div class="progress-fill h-full bg-gradient-to-r from-purple-400 to-purple-600 rounded-full transition-all duration-300" 
                         id="progressFill" style="width: 0%"></div>
                </div>
                
                <!-- 里程碑 -->
                <div class="progress-milestones flex justify-between mb-4 text-xs opacity-60">
                    <span class="milestone" data-phase="initial">开始</span>
                    <span class="milestone" data-phase="collecting">信息收集</span>
                    <span class="milestone" data-phase="analyzing">需求分析</span>
                    <span class="milestone" data-phase="refining">细化完善</span>
                    <span class="milestone" data-phase="finalizing">最终确认</span>
                </div>
                
                <!-- 任务信息汇总 -->
                <div class="task-summary glass-morphism p-3 rounded-lg hidden" id="taskSummary">
                    <div class="summary-header flex items-center justify-between mb-2">
                        <h6 class="text-sm font-medium flex items-center">
                            <i class="fas fa-clipboard-list mr-2 text-purple-300"></i>
                            任务信息汇总
                        </h6>
                        <button onclick="toggleTaskSummary()" class="text-xs opacity-60 hover:opacity-100">
                            <i class="fas fa-chevron-up" id="summaryToggleIcon"></i>
                        </button>
                    </div>
                    <div class="summary-content" id="summaryContent">
                        <div class="summary-grid grid grid-cols-2 gap-2 text-xs">
                            <div class="summary-item">
                                <span class="summary-label opacity-60">任务标题:</span>
                                <span class="summary-value" id="summaryTitle">未设置</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label opacity-60">优先级:</span>
                                <span class="summary-value" id="summaryPriority">未设置</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label opacity-60">复杂度:</span>
                                <span class="summary-value" id="summaryComplexity">分析中</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label opacity-60">预计时长:</span>
                                <span class="summary-value" id="summaryDuration">评估中</span>
                            </div>
                        </div>
                        <div class="summary-description mt-2">
                            <div class="summary-label opacity-60 text-xs mb-1">任务描述:</div>
                            <div class="summary-value text-xs" id="summaryDescription">正在收集任务信息...</div>
                        </div>
                        <div class="summary-requirements mt-2 hidden" id="summaryRequirements">
                            <div class="summary-label opacity-60 text-xs mb-1">需求列表:</div>
                            <div class="summary-tags flex flex-wrap gap-1" id="summaryRequirementTags">
                                <!-- 需求标签将动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 复杂度分析可视化区域 -->
                <div class="complexity-analysis glass-morphism p-3 rounded-lg mt-3 hidden" id="complexityAnalysis">
                    <div class="complexity-header flex items-center justify-between mb-3">
                        <h6 class="text-sm font-medium flex items-center">
                            <i class="fas fa-chart-line mr-2 text-orange-300"></i>
                            复杂度分析
                        </h6>
                        <button onclick="toggleComplexityAnalysis()" class="text-xs opacity-60 hover:opacity-100">
                            <i class="fas fa-chevron-up" id="complexityToggleIcon"></i>
                        </button>
                    </div>
                    <div class="complexity-content" id="complexityContent">
                        <!-- 复杂度评分圆环 -->
                        <div class="complexity-score-ring flex items-center justify-center mb-3">
                            <div class="relative w-20 h-20">
                                <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 36 36">
                                    <!-- 背景圆环 -->
                                    <path class="text-white text-opacity-10" stroke="currentColor" stroke-width="3" fill="none"
                                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                    <!-- 进度圆环 -->
                                    <path id="complexityProgressRing" class="text-orange-400" stroke="currentColor" stroke-width="3" fill="none"
                                          stroke-dasharray="0, 100" stroke-linecap="round"
                                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="text-center">
                                        <div class="text-lg font-bold" id="complexityPercentage">0%</div>
                                        <div class="text-xs opacity-60" id="complexityLevel">简单</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 复杂度详情 -->
                        <div class="complexity-details text-xs space-y-2">
                            <div class="complexity-factors">
                                <div class="factor-label opacity-60 mb-1">影响因素:</div>
                                <div class="factor-tags flex flex-wrap gap-1" id="complexityFactors">
                                    <!-- 复杂度因素标签将动态生成 -->
                                </div>
                            </div>
                            
                            <div class="complexity-threshold">
                                <div class="threshold-info flex items-center justify-between">
                                    <span class="opacity-60">拆解阈值:</span>
                                    <span class="font-medium" id="decompositionThreshold">70%</span>
                                </div>
                                <div class="threshold-bar w-full h-1 bg-white bg-opacity-10 rounded-full mt-1">
                                    <div class="threshold-marker absolute w-0.5 h-3 bg-red-400 rounded-full transform -translate-y-1" 
                                         id="thresholdMarker" style="left: 70%"></div>
                                </div>
                            </div>
                            
                            <div class="complexity-recommendation">
                                <div class="recommendation-text text-xs opacity-75" id="complexityRecommendation">
                                    正在分析任务复杂度...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 阶段指示器 -->
                <div class="phase-indicator mt-3 hidden" id="phaseIndicator">
                    <div class="phase-info flex items-center justify-between text-xs">
                        <span class="phase-name opacity-60">当前阶段:</span>
                        <span class="phase-value font-medium" id="currentPhase">初始化</span>
                    </div>
                    <div class="phase-description text-xs opacity-50 mt-1" id="phaseDescription">
                        准备开始任务创建流程
                    </div>
                </div>
            </div>
            
            <!-- 消息输入区域 -->
            <div class="chat-input p-6 border-t border-white border-opacity-20">
                <div class="input-container flex space-x-3">
                    <div class="flex-1 relative">
                        <textarea id="metaAgentInput" 
                                  placeholder="请输入您的回答..." 
                                  rows="3" 
                                  class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none"
                                  onkeydown="handleMetaAgentInputKeydown(event)"></textarea>
                        <div class="input-hint absolute bottom-2 right-2 text-xs opacity-50">
                            Shift+Enter 换行，Enter 发送
                        </div>
                    </div>
                    <div class="input-actions flex flex-col space-y-2">
                        <button onclick="sendMetaAgentMessage()" 
                                id="sendButton"
                                class="btn-send px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-all text-white flex items-center justify-center">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button onclick="showTaskDecomposition()" 
                                id="decomposeButton"
                                class="btn-decompose px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg transition-all text-white hidden flex items-center justify-center"
                                title="任务拆解">
                            <i class="fas fa-sitemap"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 快速回复选项 -->
                <div class="quick-replies mt-3 hidden" id="quickReplies">
                    <div class="text-xs opacity-60 mb-2">快速回复：</div>
                    <div class="flex flex-wrap gap-2" id="quickReplyButtons">
                        <!-- 快速回复按钮将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务拆解结果模态框 -->
    <div id="taskDecompositionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="glass-morphism rounded-xl w-full max-w-5xl max-h-[90vh] text-blue-100 fade-in overflow-y-auto">
            <div class="decomposition-header p-6 border-b border-white border-opacity-20">
                <div class="flex items-center justify-between">
                    <h4 class="text-2xl font-semibold flex items-center">
                        <i class="fas fa-sitemap mr-3 text-purple-300"></i>
                        任务拆解结果
                    </h4>
                    <div class="complexity-score flex items-center space-x-4">
                        <div class="text-sm">
                            <span class="score-label opacity-75">复杂度评分:</span>
                            <span class="score-value font-bold text-orange-400" id="complexityScore">0.0</span>
                        </div>
                        <button onclick="closeTaskDecomposition()" class="text-blue-100 hover:text-purple-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="decomposition-content p-6">
                <!-- 拆解统计信息 -->
                <div class="decomposition-stats mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="stat-card glass-morphism p-3 rounded-lg text-center">
                            <div class="stat-icon text-2xl mb-2 text-purple-300">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="stat-value text-lg font-bold" id="totalTasksCount">0</div>
                            <div class="stat-label text-xs opacity-60">总任务数</div>
                        </div>
                        <div class="stat-card glass-morphism p-3 rounded-lg text-center">
                            <div class="stat-icon text-2xl mb-2 text-blue-300">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value text-lg font-bold" id="estimatedTime">0h</div>
                            <div class="stat-label text-xs opacity-60">预计时长</div>
                        </div>
                        <div class="stat-card glass-morphism p-3 rounded-lg text-center">
                            <div class="stat-icon text-2xl mb-2 text-green-300">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="stat-value text-lg font-bold" id="taskLevels">0</div>
                            <div class="stat-label text-xs opacity-60">任务层级</div>
                        </div>
                        <div class="stat-card glass-morphism p-3 rounded-lg text-center">
                            <div class="stat-icon text-2xl mb-2 text-orange-300">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div class="stat-value text-lg font-bold" id="dependenciesCount">0</div>
                            <div class="stat-label text-xs opacity-60">依赖关系</div>
                        </div>
                    </div>
                </div>
                
                <!-- 主任务 -->
                <div class="main-task mb-6">
                    <h5 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-flag mr-2 text-purple-300"></i>
                        主任务
                    </h5>
                    <div class="task-item main glass-morphism p-4 rounded-lg" id="mainTaskDisplay">
                        <!-- 主任务内容将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 子任务列表 -->
                <div class="subtasks">
                    <h5 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-list mr-2 text-purple-300"></i>
                        子任务列表
                        <span class="ml-2 text-sm opacity-60" id="subtaskCount">(0个子任务)</span>
                    </h5>
                    <div class="subtask-list space-y-3" id="subtaskList">
                        <!-- 子任务项将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 依赖关系图 -->
                <div class="dependencies mt-6 hidden" id="dependenciesSection">
                    <h5 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fas fa-project-diagram mr-2 text-purple-300"></i>
                        任务依赖关系
                    </h5>
                    <div class="dependency-graph glass-morphism p-4 rounded-lg" id="dependencyGraph">
                        <!-- 依赖关系图将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <div class="decomposition-actions p-6 border-t border-white border-opacity-20 flex justify-end space-x-3">
                <button onclick="editDecompositionResult()" class="btn-edit-tasks px-4 py-2 glass-morphism rounded-lg hover:bg-white hover:bg-opacity-10 transition-all flex items-center">
                    <i class="fas fa-edit mr-2"></i>
                    编辑任务
                </button>
                <button onclick="regenerateDecomposition()" class="btn-regenerate px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg transition-all text-white flex items-center">
                    <i class="fas fa-redo mr-2"></i>
                    重新拆解
                </button>
                <button onclick="confirmTaskCreation()" class="btn-confirm-tasks px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-all text-white flex items-center">
                    <i class="fas fa-check mr-2"></i>
                    确认创建
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== 数据管理层 ====================
        class DataManager {
            constructor() {
                this.version = '1.0.0';
                this.storageKeys = {
                    tasks: 'xuexing_tasks',
                    chatHistory: 'xuexing_chat_history',
                    userSettings: 'xuexing_user_settings',
                    appVersion: 'xuexing_app_version'
                };
                this.init();
            }

            // 初始化数据管理器
            init() {
                this.checkVersion();
                this.ensureDataStructure();
            }

            // 检查版本并迁移数据
            checkVersion() {
                const currentVersion = localStorage.getItem(this.storageKeys.appVersion);
                if (currentVersion !== this.version) {
                    this.migrateData(currentVersion, this.version);
                    localStorage.setItem(this.storageKeys.appVersion, this.version);
                }
            }

            // 确保数据结构存在
            ensureDataStructure() {
                if (!this.getTasks()) {
                    this.saveTasks([]);
                }
                if (!this.getChatHistory()) {
                    this.saveChatHistory([]);
                }
                if (!this.getUserSettings()) {
                    this.saveUserSettings(this.getDefaultSettings());
                }
            }

            // 默认用户设置
            getDefaultSettings() {
                return {
                    theme: 'default',
                    autoSave: true,
                    maxChatHistory: 1000,
                    notifications: true,
                    createdAt: new Date().toISOString()
                };
            }

            // localStorage封装方法
            saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('保存数据失败:', error);
                    this.showError('存储空间不足，请清理浏览器缓存');
                    return false;
                }
            }

            loadData(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('读取数据失败:', error);
                    return null;
                }
            }

            // 任务管理方法
            saveTasks(tasks) {
                return this.saveData(this.storageKeys.tasks, tasks);
            }

            getTasks() {
                return this.loadData(this.storageKeys.tasks) || [];
            }

            addTask(task) {
                const tasks = this.getTasks();
                task.id = Date.now().toString();
                task.createdAt = new Date().toISOString();
                task.status = 'pending';
                tasks.unshift(task);
                return this.saveTasks(tasks);
            }

            updateTask(taskId, updates) {
                const tasks = this.getTasks();
                const index = tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    tasks[index] = { ...tasks[index], ...updates, updatedAt: new Date().toISOString() };
                    return this.saveTasks(tasks);
                }
                return false;
            }

            deleteTask(taskId) {
                const tasks = this.getTasks();
                const filteredTasks = tasks.filter(task => task.id !== taskId);
                return this.saveTasks(filteredTasks);
            }

            // 聊天记录管理
            saveChatHistory(history) {
                // 限制历史记录数量
                const settings = this.getUserSettings();
                const limitedHistory = history.slice(-settings.maxChatHistory);
                return this.saveData(this.storageKeys.chatHistory, limitedHistory);
            }

            getChatHistory() {
                return this.loadData(this.storageKeys.chatHistory) || [];
            }

            addChatMessage(message) {
                const history = this.getChatHistory();
                history.push({
                    ...message,
                    timestamp: new Date().toISOString()
                });
                return this.saveChatHistory(history);
            }

            // 用户设置管理
            saveUserSettings(settings) {
                return this.saveData(this.storageKeys.userSettings, settings);
            }

            getUserSettings() {
                return this.loadData(this.storageKeys.userSettings) || this.getDefaultSettings();
            }

            updateUserSettings(updates) {
                const settings = this.getUserSettings();
                const updatedSettings = { ...settings, ...updates };
                return this.saveUserSettings(updatedSettings);
            }

            // 数据导入导出
            exportData() {
                return {
                    version: this.version,
                    exportDate: new Date().toISOString(),
                    tasks: this.getTasks(),
                    chatHistory: this.getChatHistory(),
                    userSettings: this.getUserSettings()
                };
            }

            importData(data) {
                try {
                    // 验证数据格式
                    if (!data.tasks || !Array.isArray(data.tasks)) {
                        throw new Error('无效的任务数据格式');
                    }
                    if (!data.chatHistory || !Array.isArray(data.chatHistory)) {
                        throw new Error('无效的聊天记录数据格式');
                    }
                    if (!data.userSettings || typeof data.userSettings !== 'object') {
                        throw new Error('无效的用户设置数据格式');
                    }

                    // 导入数据
                    this.saveTasks(data.tasks);
                    this.saveChatHistory(data.chatHistory);
                    this.saveUserSettings({ ...this.getDefaultSettings(), ...data.userSettings });

                    return true;
                } catch (error) {
                    console.error('导入数据失败:', error);
                    throw error;
                }
            }

            // 数据迁移
            migrateData(fromVersion, toVersion) {
                console.log(`数据迁移: ${fromVersion} -> ${toVersion}`);
                // 这里可以添加版本迁移逻辑
            }

            // 错误显示
            showError(message) {
                if (typeof window.showNotification === 'function') {
                    window.showNotification(message, 'error');
                } else {
                    console.error(message);
                }
            }

            // 清空所有数据
            clearAllData() {
                Object.values(this.storageKeys).forEach(key => {
                    localStorage.removeItem(key);
                });
            }
        }

        // 全局数据管理器实例
        window.dataManager = new DataManager();

        // ==================== 原有功能 ====================
        // 生成星空背景
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 200;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // 随机位置
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                
                // 随机大小
                const size = Math.random() * 3;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                
                // 随机动画延迟
                star.style.animationDelay = Math.random() * 4 + 's';
                
                starsContainer.appendChild(star);
            }
        }
        
        // 页面切换功能
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示选中的页面
            document.getElementById(pageId).classList.add('active');
            
            // 更新导航栏状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // 如果是数据分析页面，初始化图表
            if (pageId === 'analytics') {
                initCharts();
            }
        }
        
        // 时光回音对话功能
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (message) {
                const chatMessages = document.getElementById('chatMessages');

                // 保存用户消息到数据管理器
                window.dataManager.addChatMessage({
                    type: 'user',
                    content: message,
                    sender: '用户'
                });

                // 添加用户消息到界面
                const userMessage = `
                    <div class="chat-bubble" data-message-id="${Date.now()}">
                        <div class="flex items-start justify-end">
                            <div class="glass-morphism p-4 rounded-lg max-w-md mr-3">
                                <p class="text-blue-100">${message}</p>
                            </div>
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                    </div>
                `;
                chatMessages.innerHTML += userMessage;

                // 清空输入框
                input.value = '';

                // 显示打字指示器
                const typingIndicator = `
                    <div class="chat-bubble" id="typingIndicator">
                        <div class="flex items-start">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="glass-morphism p-4 rounded-lg">
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                chatMessages.innerHTML += typingIndicator;

                // 模拟AI回复
                setTimeout(() => {
                    const aiMessage = `✨ 时光记录了您的话语："${message}"。愿这份回忆成为您心中的星光。`;

                    // 保存AI回复到数据管理器
                    window.dataManager.addChatMessage({
                        type: 'ai',
                        content: aiMessage,
                        sender: '时光守护者'
                    });

                    document.getElementById('typingIndicator').remove();
                    const aiResponse = `
                        <div class="chat-bubble" data-message-id="${Date.now()}">
                            <div class="flex items-start">
                                <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="glass-morphism p-4 rounded-lg max-w-md">
                                    <p class="text-blue-100">${aiMessage}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    chatMessages.innerHTML += aiResponse;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1500);

                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // 加载聊天历史
        function loadChatHistory() {
            const chatMessages = document.getElementById('chatMessages');
            const history = window.dataManager.getChatHistory();

            if (history.length === 0) {
                // 显示欢迎消息
                const welcomeMessage = `
                    <div class="chat-bubble">
                        <div class="flex items-start">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="glass-morphism p-4 rounded-lg max-w-md">
                                <p class="text-blue-100">🌸 欢迎来到时光回音，我是您的时光守护者，让我们一起记录美好时光吧！</p>
                            </div>
                        </div>
                    </div>
                `;
                chatMessages.innerHTML = welcomeMessage;
            } else {
                // 加载历史消息
                chatMessages.innerHTML = '';
                history.forEach(msg => {
                    const messageHtml = msg.type === 'user' ? `
                        <div class="chat-bubble" data-message-id="${msg.timestamp}">
                            <div class="flex items-start justify-end">
                                <div class="glass-morphism p-4 rounded-lg max-w-md mr-3">
                                    <p class="text-blue-100">${msg.content}</p>
                                </div>
                                <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="chat-bubble" data-message-id="${msg.timestamp}">
                            <div class="flex items-start">
                                <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="glass-morphism p-4 rounded-lg max-w-md">
                                    <p class="text-blue-100">${msg.content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    chatMessages.innerHTML += messageHtml;
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // 监听回车键发送消息
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // 初始化数据图表
        function initCharts() {
            // 趋势图
            const trendCtx = document.getElementById('trendChart');
            if (trendCtx) {
                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '完成任务数',
                            data: [12, 19, 23, 25, 32, 38],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e0e7ff'
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: '#e0e7ff'
                                },
                                grid: {
                                    color: 'rgba(224, 231, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#e0e7ff'
                                },
                                grid: {
                                    color: 'rgba(224, 231, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 分类图
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['工作', '学习', '生活', '其他'],
                        datasets: [{
                            data: [45, 25, 20, 10],
                            backgroundColor: [
                                'rgba(139, 92, 246, 0.8)',
                                'rgba(167, 139, 250, 0.8)',
                                'rgba(196, 181, 253, 0.8)',
                                'rgba(221, 214, 254, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e0e7ff'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 从3.html中引入的任务管理相关函数
        // 打开任务创建方式选择模态框
        function openAddTaskModal() {
            document.getElementById('taskCreationModeModal').classList.remove('hidden');
        }
        
        // 关闭任务创建方式选择模态框
        function closeTaskCreationModeModal() {
            document.getElementById('taskCreationModeModal').classList.add('hidden');
        }
        
        // 选择任务创建方式
        function selectCreationMode(mode) {
            closeTaskCreationModeModal();
            
            if (mode === 'guided') {
                // 启动元智能体引导创建
                startGuidedTaskCreation();
            } else if (mode === 'direct') {
                // 打开直接创建模态框
                openDirectTaskModal();
            }
        }
        
        // 启动元智能体引导创建
        function startGuidedTaskCreation() {
            // 初始化元智能体对话管理器
            if (!window.metaAgentChatManager) {
                if (typeof MetaAgentChatManager !== 'undefined') {
                    window.metaAgentChatManager = new MetaAgentChatManager();
                    setupMetaAgentEventHandlers();
                } else {
                    showNotification('元智能体管理器未加载，请刷新页面重试', 'error');
                    return;
                }
            }
            
            // 打开元智能体对话界面
            openMetaAgentChat();
            
            // 检查是否有未完成的对话可以恢复
            if (checkAndOfferConversationRestore()) {
                // 对话已恢复，无需重新开始
                return;
            }
            
            // 开始新对话
            const initialPrompt = "我想创建一个新任务，请帮助我完善任务细节。";
            startMetaAgentConversation(initialPrompt);
        }
        
        // 打开直接创建任务模态框
        function openDirectTaskModal() {
            // 验证直接创建功能的完整性
            if (!validateDirectCreationIntegrity()) {
                showNotification('直接创建功能初始化失败，请刷新页面重试', 'error');
                return;
            }
            
            // 确保模态框处于创建模式
            resetModal();
            resetTaskForm();
            
            // 打开模态框
            document.getElementById('addTaskModal').classList.remove('hidden');
        }
        
        // 关闭添加任务模态框
        function closeAddTaskModal() {
            const modal = document.getElementById('addTaskModal');
            modal.classList.add('hidden');

            // 重置模态框状态
            setTimeout(() => {
                resetModal();
                resetTaskForm();
            }, 300);
        }
        
        // 重置任务表单
        function resetTaskForm() {
            document.querySelector('#addTaskModal input[type="text"]').value = '';
            document.querySelector('#addTaskModal textarea').value = '';
            document.querySelector('#addTaskModal select').value = '低';
            document.querySelector('#addTaskModal input[type="date"]').value = '';
            document.querySelector('#addTaskModal input[placeholder="输入负责人姓名"]').value = '';
        }
        
        // 保存当前表单状态
        function saveFormState() {
            return {
                taskName: document.querySelector('#addTaskModal input[type="text"]').value,
                taskDesc: document.querySelector('#addTaskModal textarea').value,
                priority: document.querySelector('#addTaskModal select').value,
                deadline: document.querySelector('#addTaskModal input[type="date"]').value,
                assignee: document.querySelector('#addTaskModal input[placeholder="输入负责人姓名"]').value
            };
        }
        
        // 恢复表单状态
        function restoreFormState(state) {
            if (state) {
                document.querySelector('#addTaskModal input[type="text"]').value = state.taskName || '';
                document.querySelector('#addTaskModal textarea').value = state.taskDesc || '';
                document.querySelector('#addTaskModal select').value = state.priority || '低';
                document.querySelector('#addTaskModal input[type="date"]').value = state.deadline || '';
                document.querySelector('#addTaskModal input[placeholder="输入负责人姓名"]').value = state.assignee || '';
            }
        }
        
        // 验证直接创建功能的完整性
        function validateDirectCreationIntegrity() {
            // 检查所有必要的DOM元素是否存在
            const requiredElements = [
                '#addTaskModal',
                '#addTaskModal input[type="text"]',
                '#addTaskModal textarea',
                '#addTaskModal select',
                '#addTaskModal input[type="date"]',
                '#addTaskModal input[placeholder="输入负责人姓名"]'
            ];
            
            let isValid = true;
            requiredElements.forEach(selector => {
                if (!document.querySelector(selector)) {
                    console.error(`Missing required element: ${selector}`);
                    isValid = false;
                }
            });
            
            return isValid;
        }
        
        // 初始化双模式任务创建系统
        function initializeDualModeTaskCreation() {
            // 验证所有必要的模态框和元素是否存在
            const requiredModals = ['#taskCreationModeModal', '#addTaskModal'];
            let allModalsExist = true;
            
            requiredModals.forEach(modalId => {
                if (!document.querySelector(modalId)) {
                    console.error(`Missing required modal: ${modalId}`);
                    allModalsExist = false;
                }
            });
            
            if (!allModalsExist) {
                console.error('Dual-mode task creation system initialization failed');
                return false;
            }
            
            // 验证直接创建功能的完整性
            if (!validateDirectCreationIntegrity()) {
                console.error('Direct task creation integrity check failed');
                return false;
            }
            
            console.log('Dual-mode task creation system initialized successfully');
            return true;
        }
        
        // 保存任务
        function saveTask() {
            // 验证表单
            const taskName = document.querySelector('#addTaskModal input[type="text"]').value.trim();
            const taskDesc = document.querySelector('#addTaskModal textarea').value.trim();
            const priority = document.querySelector('#addTaskModal select').value;
            const deadline = document.querySelector('#addTaskModal input[type="date"]').value;
            const assignee = document.querySelector('#addTaskModal input[placeholder="输入负责人姓名"]').value.trim();

            // 表单验证
            if (!taskName) {
                showNotification('请输入任务名称', 'error');
                return;
            }

            if (!deadline) {
                showNotification('请选择截止日期', 'error');
                return;
            }

            // 创建任务对象
            const task = {
                name: taskName,
                description: taskDesc || '暂无描述',
                priority: priority,
                deadline: deadline,
                assignee: assignee || '未分配',
                progress: 0,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            // 保存到数据管理器
            if (window.dataManager.addTask(task)) {
                // 添加保存动画
                const modal = document.getElementById('addTaskModal');
                modal.querySelector('.glass-morphism').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    modal.querySelector('.glass-morphism').style.transform = 'scale(1)';
                    closeAddTaskModal();
                    showNotification('任务创建成功！');

                    // 清空表单
                    resetTaskForm();

                    // 重新加载任务列表
                    loadTasks();
                }, 200);
            } else {
                showNotification('任务创建失败，请重试', 'error');
            }
        }

        // 加载任务列表
        function loadTasks() {
            const taskList = document.getElementById('taskList');
            const tasks = window.dataManager.getTasks();

            // 保留新建任务卡片
            const addTaskCard = document.querySelector('.add-task-card');
            taskList.innerHTML = '';
            if (addTaskCard) {
                taskList.appendChild(addTaskCard);
            }

            // 添加任务卡片
            tasks.forEach((task, index) => {
                const taskCard = createTaskCard(task, index);
                taskList.appendChild(taskCard);
            });

            // 更新统计
            updateTaskStats();
        }

        // 创建任务卡片
        function createTaskCard(task, index) {
            const taskCard = document.createElement('div');
            taskCard.className = 'glass-morphism rounded-xl p-6 text-blue-100 task-card fade-in';
            taskCard.style.animationDelay = `${(index + 1) * 0.1}s`;
            taskCard.setAttribute('data-task-id', task.id);

            // 优先级标签
            let priorityBadge = '';
            let priorityColor = '';
            if (task.priority === '紧急') {
                priorityBadge = '紧急';
                priorityColor = 'bg-red-500';
            } else if (task.priority === '高') {
                priorityBadge = '高';
                priorityColor = 'bg-orange-500';
            } else if (task.priority === '中') {
                priorityBadge = '中';
                priorityColor = 'bg-blue-500';
            } else {
                priorityBadge = '低';
                priorityColor = 'bg-gray-500';
            }

            // 状态标签
            let statusBadge = '';
            if (task.status === 'completed') {
                statusBadge = '<span class="ml-2 px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">已完成</span>';
            }

            // 计算剩余天数
            const deadlineDate = new Date(task.deadline);
            const today = new Date();
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let remainingText = diffDays > 0 ? `剩余${diffDays}天` : (diffDays === 0 ? '今天到期' : `已过期${Math.abs(diffDays)}天`);

            // 进度环计算
            const circumference = 2 * Math.PI * 54;
            const strokeDashoffset = circumference - (task.progress / 100) * circumference;

            taskCard.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" class="mr-3 w-5 h-5 rounded" ${task.status === 'completed' ? 'checked' : ''} onclick="event.stopPropagation(); toggleTaskComplete(this, '${task.id}')">
                            <h3 class="text-lg font-semibold ${task.status === 'completed' ? 'line-through opacity-50' : ''}">${task.name}</h3>
                            <span class="ml-3 px-2 py-1 ${priorityColor} bg-opacity-30 text-xs rounded-full">${priorityBadge}</span>
                            ${statusBadge}
                        </div>
                        <p class="text-sm opacity-75 mb-3 ${task.status === 'completed' ? 'opacity-50' : ''}">${task.description}</p>
                        <div class="flex items-center text-xs space-x-4">
                            <span><i class="far fa-calendar mr-1"></i>截止: ${task.deadline}</span>
                            <span><i class="far fa-clock mr-1"></i>${remainingText}</span>
                            <span><i class="far fa-user mr-1"></i>负责人: ${task.assignee}</span>
                        </div>
                        <div class="flex items-center space-x-2 mt-3">
                            <button onclick="event.stopPropagation(); editTask('${task.id}')" class="px-2 py-1 text-xs bg-white bg-opacity-10 rounded hover:bg-opacity-20 transition-all">
                                <i class="fas fa-edit mr-1"></i>编辑
                            </button>
                            <button onclick="event.stopPropagation(); deleteTask('${task.id}')" class="px-2 py-1 text-xs bg-red-500 bg-opacity-20 rounded hover:bg-opacity-30 transition-all">
                                <i class="fas fa-trash mr-1"></i>删除
                            </button>
                        </div>
                    </div>
                    <div class="ml-4">
                        <svg class="progress-ring" width="60" height="60">
                            <circle class="progress-ring-circle" stroke="#e0e7ff" stroke-width="4" fill="transparent" r="54" cx="30" cy="30" style="stroke-dashoffset: ${strokeDashoffset}"/>
                        </svg>
                        <div class="text-center -mt-10 text-sm">${task.progress}%</div>
                    </div>
                </div>
            `;

            taskCard.onclick = function() { openTaskDetail(task.id); };

            return taskCard;
        }
        
        // 更新任务统计
        function updateTaskStats() {
            const tasks = window.dataManager.getTasks();
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const pendingTasks = totalTasks - completedTasks;
            const urgentTasks = tasks.filter(task => task.priority === '紧急' && task.status !== 'completed').length;

            // 更新统计卡片
            const statCards = document.querySelectorAll('.glass-morphism.rounded-xl.p-6.text-blue-100.hover-scale');
            if (statCards.length >= 4) {
                statCards[0].querySelector('.text-3xl.font-bold').textContent = totalTasks;
                statCards[1].querySelector('.text-3xl.font-bold').textContent = completedTasks;
                statCards[2].querySelector('.text-3xl.font-bold').textContent = pendingTasks;
                statCards[3].querySelector('.text-3xl.font-bold').textContent = urgentTasks;
            }
        }

        // 切换任务完成状态
        function toggleTaskComplete(checkbox, taskId) {
            const newStatus = checkbox.checked ? 'completed' : 'pending';
            const progress = checkbox.checked ? 100 : 0;

            if (window.dataManager.updateTask(taskId, { status: newStatus, progress: progress })) {
                const taskCard = checkbox.closest('.task-card');
                const title = taskCard.querySelector('h3');
                const description = taskCard.querySelector('p');
                const statusBadge = taskCard.querySelector('.bg-green-500');
                const progressRing = taskCard.querySelector('.progress-ring-circle');
                const progressText = taskCard.querySelector('.text-center.-mt-10');

                if (checkbox.checked) {
                    title.classList.add('line-through', 'opacity-50');
                    description.classList.add('opacity-50');

                    // 添加已完成标签
                    if (!statusBadge) {
                        const badge = document.createElement('span');
                        badge.className = 'ml-2 px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full';
                        badge.textContent = '已完成';
                        title.parentNode.appendChild(badge);
                    }

                    // 更新进度环
                    if (progressRing) progressRing.style.strokeDashoffset = '0';
                    if (progressText) progressText.textContent = '100%';

                    showNotification('任务已完成！');
                } else {
                    title.classList.remove('line-through', 'opacity-50');
                    description.classList.remove('opacity-50');

                    // 移除已完成标签
                    if (statusBadge) statusBadge.remove();

                    // 更新进度环
                    if (progressRing) progressRing.style.strokeDashoffset = '339.292';
                    if (progressText) progressText.textContent = '0%';
                }

                updateTaskStats();
            } else {
                showNotification('更新任务状态失败', 'error');
            }
        }

        // 删除任务
        function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？此操作不可撤销。')) {
                if (window.dataManager.deleteTask(taskId)) {
                    showNotification('任务已删除');
                    loadTasks();
                } else {
                    showNotification('删除任务失败', 'error');
                }
            }
        }

        // 编辑任务
        function editTask(taskId) {
            const tasks = window.dataManager.getTasks();
            const task = tasks.find(t => t.id === taskId);

            if (task) {
                // 填充表单
                document.querySelector('#addTaskModal input[type="text"]').value = task.name;
                document.querySelector('#addTaskModal textarea').value = task.description;
                document.querySelector('#addTaskModal select').value = task.priority;
                document.querySelector('#addTaskModal input[type="date"]').value = task.deadline;
                document.querySelector('#addTaskModal input[placeholder="输入负责人姓名"]').value = task.assignee;

                // 修改按钮文本
                const saveBtn = document.querySelector('#addTaskModal button[onclick="saveTask()"]');
                saveBtn.textContent = '更新任务';
                saveBtn.setAttribute('onclick', `updateTask('${taskId}')`);

                // 修改标题
                document.querySelector('#addTaskModal h3').innerHTML = '<i class="fas fa-edit mr-2 text-purple-300"></i>编辑任务';

                // 打开模态框
                document.getElementById('addTaskModal').classList.remove('hidden');
            }
        }

        // 更新任务
        function updateTask(taskId) {
            const taskName = document.querySelector('#addTaskModal input[type="text"]').value.trim();
            const taskDesc = document.querySelector('#addTaskModal textarea').value.trim();
            const priority = document.querySelector('#addTaskModal select').value;
            const deadline = document.querySelector('#addTaskModal input[type="date"]').value;
            const assignee = document.querySelector('#addTaskModal input[placeholder="输入负责人姓名"]').value.trim();

            if (!taskName) {
                showNotification('请输入任务名称', 'error');
                return;
            }

            if (!deadline) {
                showNotification('请选择截止日期', 'error');
                return;
            }

            const updates = {
                name: taskName,
                description: taskDesc || '暂无描述',
                priority: priority,
                deadline: deadline,
                assignee: assignee || '未分配'
            };

            if (window.dataManager.updateTask(taskId, updates)) {
                closeAddTaskModal();
                showNotification('任务更新成功！');
                loadTasks();
                resetModal();
            } else {
                showNotification('更新任务失败', 'error');
            }
        }

        // 重置模态框
        function resetModal() {
            document.querySelector('#addTaskModal h3').innerHTML = '<i class="fas fa-plus-circle mr-2 text-purple-300"></i>创建新任务';
            const saveBtn = document.querySelector('#addTaskModal button[onclick^="updateTask"]');
            if (saveBtn) {
                saveBtn.textContent = '创建任务';
                saveBtn.setAttribute('onclick', 'saveTask()');
            }
        }
        
        // 打开任务详情
        function openTaskDetail(taskId) {
            showNotification(`打开任务 #${taskId} 详情`);
        }
        
        // 筛选任务
        function filterTasks(filter) {
            showNotification(`筛选: ${filter}`);
        }
        
        // 切换视图
        function toggleView() {
            showNotification('切换视图模式');
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-6 glass-morphism rounded-lg px-4 py-3 text-blue-100 fade-in z-50';

            let icon = '';
            let iconColor = '';
            let borderColor = '';

            switch (type) {
                case 'error':
                    icon = 'fas fa-exclamation-circle';
                    iconColor = 'text-red-300';
                    borderColor = 'border-red-500';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    iconColor = 'text-yellow-300';
                    borderColor = 'border-yellow-500';
                    break;
                case 'info':
                    icon = 'fas fa-info-circle';
                    iconColor = 'text-blue-300';
                    borderColor = 'border-blue-500';
                    break;
                default:
                    icon = 'fas fa-check-circle';
                    iconColor = 'text-green-300';
                    borderColor = 'border-green-500';
            }

            notification.className += ` border-l-4 ${borderColor}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="${icon} mr-2 ${iconColor}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 搜索功能
        function searchTasks() {
            const searchInput = document.querySelector('input[placeholder="搜索任务..."]');
            const searchTerm = searchInput.value.trim().toLowerCase();
            const tasks = window.dataManager.getTasks();
            const taskList = document.getElementById('taskList');

            // 保留新建任务卡片
            const addTaskCard = document.querySelector('.add-task-card');
            taskList.innerHTML = '';
            if (addTaskCard) {
                taskList.appendChild(addTaskCard);
            }

            // 筛选任务
            let filteredTasks = tasks;
            if (searchTerm) {
                filteredTasks = tasks.filter(task =>
                    task.name.toLowerCase().includes(searchTerm) ||
                    task.description.toLowerCase().includes(searchTerm) ||
                    task.assignee.toLowerCase().includes(searchTerm)
                );
            }

            // 显示筛选结果
            if (filteredTasks.length === 0 && searchTerm) {
                const noResults = document.createElement('div');
                noResults.className = 'glass-morphism rounded-xl p-6 text-blue-100 text-center';
                noResults.innerHTML = `
                    <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                    <p class="text-lg">没有找到匹配的任务</p>
                    <p class="text-sm opacity-75 mt-2">尝试使用其他关键词搜索</p>
                `;
                taskList.appendChild(noResults);
            } else {
                filteredTasks.forEach((task, index) => {
                    const taskCard = createTaskCard(task, index);
                    taskList.appendChild(taskCard);
                });
            }
        }

        // 筛选任务
        function filterTasks(filter) {
            const tasks = window.dataManager.getTasks();
            const taskList = document.getElementById('taskList');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 保留新建任务卡片
            const addTaskCard = document.querySelector('.add-task-card');
            taskList.innerHTML = '';
            if (addTaskCard) {
                taskList.appendChild(addTaskCard);
            }

            let filteredTasks = tasks;

            switch (filter) {
                case 'today':
                    filteredTasks = tasks.filter(task => {
                        const deadlineDate = new Date(task.deadline);
                        deadlineDate.setHours(0, 0, 0, 0);
                        return deadlineDate.getTime() === today.getTime();
                    });
                    break;
                case 'week':
                    const weekFromNow = new Date(today);
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    filteredTasks = tasks.filter(task => {
                        const deadlineDate = new Date(task.deadline);
                        return deadlineDate >= today && deadlineDate <= weekFromNow;
                    });
                    break;
                case 'completed':
                    filteredTasks = tasks.filter(task => task.status === 'completed');
                    break;
                case 'pending':
                    filteredTasks = tasks.filter(task => task.status !== 'completed');
                    break;
            }

            // 显示筛选结果
            filteredTasks.forEach((task, index) => {
                const taskCard = createTaskCard(task, index);
                taskList.appendChild(taskCard);
            });

            showNotification(`已筛选: ${filter === 'all' ? '全部任务' : filter === 'today' ? '今日任务' : filter === 'week' ? '本周任务' : filter === 'completed' ? '已完成任务' : '待完成任务'} (${filteredTasks.length}项)`, 'info');
        }

        // 数据导出功能
        function exportData() {
            try {
                const data = window.dataManager.exportData();
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `学办小星数据备份_${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                URL.revokeObjectURL(url);
                showNotification('数据导出成功！', 'success');
            } catch (error) {
                console.error('导出数据失败:', error);
                showNotification('导出数据失败，请重试', 'error');
            }
        }

        // 数据导入功能
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        window.dataManager.importData(data);

                        // 重新加载数据
                        loadTasks();
                        loadChatHistory();

                        showNotification('数据导入成功！页面将在3秒后刷新。', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    } catch (error) {
                        console.error('导入数据失败:', error);
                        showNotification('导入失败：文件格式不正确或数据损坏', 'error');
                    }
                };

                reader.readAsText(file);
            };

            input.click();
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 创建星空背景
            createStars();

            // 初始化双模式任务创建系统
            initializeDualModeTaskCreation();

            // 初始化数据
            setTimeout(() => {
                loadTasks();
                loadChatHistory();
                updateTaskStats();
            }, 100);

            // 添加搜索框事件监听
            const searchInput = document.querySelector('input[placeholder="搜索任务..."]');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchTasks();
                    }, 300); // 防抖，300ms后执行搜索
                });

                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchTasks();
                    }
                });
            }

            // 添加键盘快捷键
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + K 打开搜索
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.querySelector('input[placeholder="搜索任务..."]');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }

                // Ctrl/Cmd + N 新建任务
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    openAddTaskModal();
                }

                // Ctrl/Cmd + E 导出数据
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportData();
                }

                // Ctrl/Cmd + I 导入数据
                if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                    e.preventDefault();
                    importData();
                }

                // ESC 关闭模态框
                if (e.key === 'Escape') {
                    closeAddTaskModal();
                }
            });

            // 添加页面切换时的数据加载
            const originalShowPage = window.showPage;
            window.showPage = function(pageId) {
                originalShowPage(pageId);

                // 如果切换到任务页面，重新加载任务
                if (pageId === 'tasks') {
                    setTimeout(() => {
                        loadTasks();
                        updateTaskStats();
                    }, 100);
                }

                // 如果切换到聊天页面，重新加载聊天历史
                if (pageId === 'chat') {
                    setTimeout(() => {
                        loadChatHistory();
                    }, 100);
                }
            };
            
            // 添加拖拽功能
            const taskCards = document.querySelectorAll('.task-card');
            taskCards.forEach(card => {
                card.draggable = true;
                
                card.addEventListener('dragstart', function(e) {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.innerHTML);
                    this.style.opacity = '0.5';
                });
                
                card.addEventListener('dragend', function(e) {
                    this.style.opacity = '';
                });
                
                card.addEventListener('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.dataTransfer.dropEffect = 'move';
                    return false;
                });
                
                card.addEventListener('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    showNotification('任务顺序已更新');
                    return false;
                });
            });

            // 设置元智能体对话界面的欢迎时间
            const welcomeTimeElement = document.getElementById('welcome-time');
            if (welcomeTimeElement) {
                welcomeTimeElement.textContent = new Date().toLocaleTimeString();
            }
        });

        // ==================== 元智能体对话功能 ====================
        
        // 打开元智能体对话界面
        function openMetaAgentChat() {
            const modal = document.getElementById('metaAgentChatModal');
            modal.classList.remove('hidden');
            
            // 重置界面状态
            resetMetaAgentChat();
            
            // 聚焦到输入框
            setTimeout(() => {
                const input = document.getElementById('metaAgentInput');
                if (input) input.focus();
            }, 300);
        }
        
        // 关闭元智能体对话界面
        function closeMetaAgentChat() {
            const modal = document.getElementById('metaAgentChatModal');
            modal.classList.add('hidden');
            
            // 结束对话
            if (window.metaAgentChatManager && window.metaAgentChatManager.isActive) {
                window.metaAgentChatManager.endConversation();
            }
        }
        
        // 重新开始元智能体对话
        function restartMetaAgentChat() {
            if (confirm('确定要重新开始对话吗？当前的对话内容将会丢失。')) {
                if (window.metaAgentChatManager) {
                    window.metaAgentChatManager.restartConversation();
                }
                resetMetaAgentChat();
                
                // 重新开始对话
                const initialPrompt = "我想重新创建一个任务，请帮助我完善任务细节。";
                startMetaAgentConversation(initialPrompt);
            }
        }
        
        // 重置元智能体对话界面
        function resetMetaAgentChat() {
            // 清空消息区域（保留欢迎消息）
            const messagesContainer = document.getElementById('metaAgentMessages');
            const welcomeMessage = messagesContainer.querySelector('.message-bubble.agent-message');
            messagesContainer.innerHTML = '';
            if (welcomeMessage) {
                messagesContainer.appendChild(welcomeMessage);
            }
            
            // 重置进度跟踪
            resetProgressTracking();
            
            // 清空输入框
            const input = document.getElementById('metaAgentInput');
            if (input) input.value = '';
            
            // 隐藏拆解按钮
            const decomposeButton = document.getElementById('decomposeButton');
            if (decomposeButton) decomposeButton.classList.add('hidden');
            
            // 隐藏快速回复
            const quickReplies = document.getElementById('quickReplies');
            if (quickReplies) quickReplies.classList.add('hidden');
            
            // 重置对话状态
            updateConversationStatus('active');
        }
        
        // 开始元智能体对话
        async function startMetaAgentConversation(initialPrompt) {
            if (!window.metaAgentChatManager) {
                showNotification('元智能体管理器未初始化', 'error');
                return;
            }
            
            try {
                // 显示加载状态
                showTypingIndicator();
                
                const result = await window.metaAgentChatManager.startConversation(initialPrompt);
                
                if (result.success) {
                    // 添加用户消息
                    addMessageToChat('user', initialPrompt);
                    
                    // 添加AI回复
                    if (result.data.firstQuestion) {
                        setTimeout(() => {
                            hideTypingIndicator();
                            addMessageToChat('meta_agent', result.data.firstQuestion);
                            updateProgress(result.data.progress, result.data.phase, getPhaseDescription(result.data.phase));
                        }, 1000);
                    }
                } else {
                    hideTypingIndicator();
                    showNotification('启动对话失败: ' + (result.errors ? result.errors.join(', ') : '未知错误'), 'error');
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('启动对话失败:', error);
                showNotification('启动对话时发生错误', 'error');
            }
        }
        
        // 发送元智能体消息
        async function sendMetaAgentMessage(retryCount = 0) {
            const input = document.getElementById('metaAgentInput');
            const message = input.value.trim();
            
            if (!message) {
                showNotification('请输入消息内容', 'warning');
                return;
            }
            
            if (!window.metaAgentChatManager || !window.metaAgentChatManager.isActive) {
                showNotification('对话未激活，请重新开始', 'error');
                return;
            }
            
            const sendButton = document.getElementById('sendButton');
            
            try {
                // 禁用发送按钮并显示加载状态
                sendButton.disabled = true;
                sendButton.classList.add('loading');
                updateConversationStatus('thinking');
                
                // 清空输入框（仅在首次发送时）
                if (retryCount === 0) {
                    input.value = '';
                    // 添加用户消息
                    addMessageToChat('user', message);
                }
                
                // 显示打字指示器
                showTypingIndicator();
                
                // 发送消息
                const result = await window.metaAgentChatManager.sendMessage(message);
                
                if (result.success) {
                    // 模拟AI思考时间
                    const thinkingTime = 1000 + Math.random() * 1500;
                    
                    setTimeout(() => {
                        hideTypingIndicator();
                        updateConversationStatus('active');
                        
                        // 添加AI回复
                        if (result.data.response) {
                            addMessageToChat('meta_agent', result.data.response);
                        }
                        
                        // 更新进度
                        if (result.data.progress !== undefined) {
                            updateProgress(result.data.progress, result.data.phase, getPhaseDescription(result.data.phase));
                        }
                        
                        // 显示拆解按钮
                        if (result.data.canDecompose) {
                            const decomposeButton = document.getElementById('decomposeButton');
                            decomposeButton.classList.remove('hidden');
                        }
                        
                        // 显示快速回复选项
                        if (result.data.nextQuestion) {
                            showQuickReplies(result.data.nextQuestion);
                        }
                        
                        // 重新启用发送按钮
                        sendButton.disabled = false;
                        sendButton.classList.remove('loading');
                        
                        // 聚焦到输入框
                        input.focus();
                    }, thinkingTime);
                } else {
                    handleSendMessageError(result.errors, message, retryCount);
                }
            } catch (error) {
                handleSendMessageError([error.message || '网络连接错误'], message, retryCount);
            }
        }
        
        // 处理发送消息错误
        function handleSendMessageError(errors, originalMessage, retryCount) {
            hideTypingIndicator();
            updateConversationStatus('active');
            
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = false;
            sendButton.classList.remove('loading');
            
            const errorMessage = errors ? errors.join(', ') : '未知错误';
            console.error('发送消息失败:', errorMessage);
            
            // 如果是网络错误且重试次数少于3次，提供重试选项
            if (retryCount < 3 && (errorMessage.includes('网络') || errorMessage.includes('连接') || errorMessage.includes('timeout'))) {
                addMessageToChat('system', `❌ 发送失败: ${errorMessage}。正在自动重试... (${retryCount + 1}/3)`);
                
                // 自动重试
                setTimeout(() => {
                    const input = document.getElementById('metaAgentInput');
                    input.value = originalMessage;
                    sendMetaAgentMessage(retryCount + 1);
                }, 2000);
            } else {
                // 显示错误并提供手动重试选项
                addMessageToChat('system', `❌ 发送失败: ${errorMessage}`);
                
                // 恢复输入框内容以便用户重试
                const input = document.getElementById('metaAgentInput');
                input.value = originalMessage;
                
                // 显示重试选项
                showRetryOptions(originalMessage);
                
                // 触发错误事件
                if (window.metaAgentChatManager) {
                    window.metaAgentChatManager._notifyHandlers('error_occurred', {
                        error: errorMessage,
                        originalMessage: originalMessage,
                        retryCount: retryCount
                    });
                }
            }
        }
        
        // 显示重试选项
        function showRetryOptions(originalMessage) {
            const quickReplies = document.getElementById('quickReplies');
            const quickReplyButtons = document.getElementById('quickReplyButtons');
            
            if (quickReplies && quickReplyButtons) {
                quickReplyButtons.innerHTML = '';
                
                const retryButton = document.createElement('button');
                retryButton.className = 'quick-reply-btn';
                retryButton.textContent = '🔄 重试发送';
                retryButton.onclick = () => {
                    quickReplies.classList.add('hidden');
                    sendMetaAgentMessage(0);
                };
                
                const editButton = document.createElement('button');
                editButton.className = 'quick-reply-btn';
                editButton.textContent = '✏️ 修改消息';
                editButton.onclick = () => {
                    quickReplies.classList.add('hidden');
                    const input = document.getElementById('metaAgentInput');
                    input.focus();
                    input.select();
                };
                
                quickReplyButtons.appendChild(retryButton);
                quickReplyButtons.appendChild(editButton);
                quickReplies.classList.remove('hidden');
            }
        }
        
        // 处理输入框按键事件
        function handleMetaAgentInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMetaAgentMessage();
            }
        }
        
        // 添加消息到对话界面
        function addMessageToChat(type, content, metadata = {}) {
            const messagesContainer = document.getElementById('metaAgentMessages');
            const messageElement = createMessageElement(type, content, metadata);
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageElement;
        }
        
        // 创建消息元素
        function createMessageElement(type, content, metadata = {}) {
            const messageDiv = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            let avatarIcon, senderName, messageClass;
            
            switch (type) {
                case 'user':
                    avatarIcon = 'fas fa-user';
                    senderName = '您';
                    messageClass = 'user-message';
                    break;
                case 'meta_agent':
                    avatarIcon = 'fas fa-robot';
                    senderName = '元智能体';
                    messageClass = 'agent-message';
                    break;
                case 'system':
                    avatarIcon = 'fas fa-cog';
                    senderName = '系统';
                    messageClass = 'system-message';
                    break;
                default:
                    avatarIcon = 'fas fa-comment';
                    senderName = '未知';
                    messageClass = 'agent-message';
            }
            
            messageDiv.className = `message-bubble ${messageClass}`;
            messageDiv.innerHTML = `
                <div class="flex items-start">
                    <div class="message-avatar w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                        <i class="${avatarIcon}"></i>
                    </div>
                    <div class="message-content glass-morphism p-4 rounded-lg">
                        <div class="message-header flex items-center mb-2">
                            <span class="message-sender font-medium">${senderName}</span>
                            <span class="message-time text-xs opacity-60 ml-2">${timestamp}</span>
                        </div>
                        <p class="message-text">${content}</p>
                    </div>
                </div>
            `;
            
            return messageDiv;
        }
        
        // 显示打字指示器
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('metaAgentMessages');
            
            // 移除现有的打字指示器
            const existingIndicator = messagesContainer.querySelector('.typing-indicator-message');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message-bubble agent-message typing-indicator-message';
            typingDiv.innerHTML = `
                <div class="flex items-start">
                    <div class="message-avatar w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content glass-morphism p-4 rounded-lg">
                        <div class="typing-indicator">
                            <span class="text-sm opacity-75 mr-2">元智能体正在思考</span>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 隐藏打字指示器
        function hideTypingIndicator() {
            const messagesContainer = document.getElementById('metaAgentMessages');
            const typingIndicator = messagesContainer.querySelector('.typing-indicator-message');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // 更新进度
        function updateProgress(percentage, phase, description) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercentage = document.getElementById('progressPercentage');
            
            if (progressFill) {
                // 添加更新动画
                progressFill.classList.add('updating');
                progressFill.style.width = percentage + '%';
                
                setTimeout(() => {
                    progressFill.classList.remove('updating');
                }, 500);
            }
            
            if (progressText) {
                progressText.textContent = description;
            }
            
            if (progressPercentage) {
                progressPercentage.textContent = Math.round(percentage) + '%';
            }
            
            // 更新里程碑状态
            updateMilestones(phase);
            
            // 更新阶段指示器
            updatePhaseIndicator(phase, description);
            
            // 显示任务汇总（当进度超过10%时）
            if (percentage > 10) {
                showTaskSummary();
            }
            
            // 显示阶段指示器（当进度超过5%时）
            if (percentage > 5) {
                showPhaseIndicator();
            }
        }
        
        // 更新里程碑状态
        function updateMilestones(currentPhase) {
            const milestones = document.querySelectorAll('.milestone');
            const phaseOrder = ['initial', 'collecting', 'analyzing', 'refining', 'finalizing'];
            const currentIndex = phaseOrder.indexOf(currentPhase);
            
            // 添加工具提示
            const phaseTooltips = {
                'initial': '开始任务创建流程',
                'collecting': '收集任务基本信息',
                'analyzing': '分析任务需求和约束',
                'refining': '完善任务细节',
                'finalizing': '最终确认任务信息'
            };
            
            milestones.forEach((milestone, index) => {
                milestone.classList.remove('active', 'completed');
                
                // 设置工具提示
                const phase = phaseOrder[index];
                if (phase && phaseTooltips[phase]) {
                    milestone.setAttribute('data-tooltip', phaseTooltips[phase]);
                }
                
                if (index < currentIndex) {
                    milestone.classList.add('completed');
                } else if (index === currentIndex) {
                    milestone.classList.add('active');
                }
            });
        }
        
        // 更新阶段指示器
        function updatePhaseIndicator(phase, description) {
            const currentPhase = document.getElementById('currentPhase');
            const phaseDescription = document.getElementById('phaseDescription');
            
            const phaseNames = {
                'initial': '初始化',
                'collecting': '信息收集',
                'analyzing': '需求分析',
                'refining': '细化完善',
                'finalizing': '最终确认',
                'decomposing': '任务拆解',
                'completed': '完成'
            };
            
            if (currentPhase) {
                currentPhase.textContent = phaseNames[phase] || phase;
            }
            
            if (phaseDescription) {
                phaseDescription.textContent = description;
            }
        }
        
        // 显示任务汇总
        function showTaskSummary() {
            const taskSummary = document.getElementById('taskSummary');
            if (taskSummary && taskSummary.classList.contains('hidden')) {
                taskSummary.classList.remove('hidden');
                taskSummary.style.animation = 'fadeIn 0.3s ease-out';
            }
        }
        
        // 显示阶段指示器
        function showPhaseIndicator() {
            const phaseIndicator = document.getElementById('phaseIndicator');
            if (phaseIndicator && phaseIndicator.classList.contains('hidden')) {
                phaseIndicator.classList.remove('hidden');
                phaseIndicator.style.animation = 'fadeIn 0.3s ease-out';
            }
        }
        
        // 切换任务汇总显示
        function toggleTaskSummary() {
            const taskSummary = document.getElementById('taskSummary');
            const summaryContent = document.getElementById('summaryContent');
            const toggleIcon = document.getElementById('summaryToggleIcon');
            
            if (summaryContent && toggleIcon) {
                if (summaryContent.style.display === 'none') {
                    summaryContent.style.display = 'block';
                    toggleIcon.className = 'fas fa-chevron-up';
                    taskSummary.classList.remove('collapsed');
                } else {
                    summaryContent.style.display = 'none';
                    toggleIcon.className = 'fas fa-chevron-down';
                    taskSummary.classList.add('collapsed');
                }
            }
        }
        
        // 更新任务汇总信息
        function updateTaskSummaryInfo(taskContext) {
            if (!taskContext) return;
            
            // 更新标题
            const summaryTitle = document.getElementById('summaryTitle');
            if (summaryTitle && taskContext.title) {
                updateSummaryValue(summaryTitle, taskContext.title);
            }
            
            // 更新优先级
            const summaryPriority = document.getElementById('summaryPriority');
            if (summaryPriority && taskContext.priority) {
                const priorityText = getPriorityText(taskContext.priority);
                updateSummaryValue(summaryPriority, priorityText);
            }
            
            // 更新复杂度
            const summaryComplexity = document.getElementById('summaryComplexity');
            if (summaryComplexity && taskContext.complexity !== undefined) {
                const complexityText = `${(taskContext.complexity * 100).toFixed(0)}%`;
                updateSummaryValue(summaryComplexity, complexityText);
            }
            
            // 更新预计时长
            const summaryDuration = document.getElementById('summaryDuration');
            if (summaryDuration && taskContext.estimatedDuration) {
                updateSummaryValue(summaryDuration, taskContext.estimatedDuration);
            }
            
            // 更新描述
            const summaryDescription = document.getElementById('summaryDescription');
            if (summaryDescription && taskContext.description) {
                updateSummaryValue(summaryDescription, taskContext.description);
            }
            
            // 更新需求列表
            if (taskContext.requirements && taskContext.requirements.length > 0) {
                updateRequirementsTags(taskContext.requirements);
            }
        }
        
        // 更新汇总值并添加动画
        function updateSummaryValue(element, newValue) {
            if (element.textContent !== newValue) {
                element.textContent = newValue;
                element.classList.add('updated');
                setTimeout(() => {
                    element.classList.remove('updated');
                }, 500);
            }
        }
        
        // 获取优先级文本
        function getPriorityText(priority) {
            const priorityMap = {
                1: '低优先级',
                2: '中等优先级',
                3: '高优先级',
                4: '紧急',
                'low': '低优先级',
                'medium': '中等优先级',
                'high': '高优先级',
                'urgent': '紧急'
            };
            
            return priorityMap[priority] || priority;
        }
        
        // 更新需求标签
        function updateRequirementsTags(requirements) {
            const summaryRequirements = document.getElementById('summaryRequirements');
            const summaryRequirementTags = document.getElementById('summaryRequirementTags');
            
            if (!summaryRequirements || !summaryRequirementTags) return;
            
            // 显示需求区域
            summaryRequirements.classList.remove('hidden');
            
            // 清空现有标签
            summaryRequirementTags.innerHTML = '';
            
            // 添加新标签
            requirements.forEach((requirement, index) => {
                const tag = document.createElement('span');
                tag.className = 'summary-tag new';
                tag.textContent = requirement;
                
                // 延迟添加动画
                setTimeout(() => {
                    summaryRequirementTags.appendChild(tag);
                }, index * 100);
            });
        }
        
        // 重置进度跟踪
        function resetProgressTracking() {
            // 重置进度条
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercentage = document.getElementById('progressPercentage');
            
            if (progressFill) progressFill.style.width = '0%';
            if (progressText) progressText.textContent = '等待开始任务创建...';
            if (progressPercentage) progressPercentage.textContent = '0%';
            
            // 重置里程碑
            const milestones = document.querySelectorAll('.milestone');
            milestones.forEach(milestone => {
                milestone.classList.remove('active', 'completed');
            });
            
            // 隐藏任务汇总和阶段指示器
            const taskSummary = document.getElementById('taskSummary');
            const phaseIndicator = document.getElementById('phaseIndicator');
            
            if (taskSummary) {
                taskSummary.classList.add('hidden');
                // 重置汇总内容
                resetTaskSummaryContent();
            }
            
            if (phaseIndicator) {
                phaseIndicator.classList.add('hidden');
            }
        }
        
        // 重置任务汇总内容
        function resetTaskSummaryContent() {
            const summaryTitle = document.getElementById('summaryTitle');
            const summaryPriority = document.getElementById('summaryPriority');
            const summaryComplexity = document.getElementById('summaryComplexity');
            const summaryDuration = document.getElementById('summaryDuration');
            const summaryDescription = document.getElementById('summaryDescription');
            const summaryRequirements = document.getElementById('summaryRequirements');
            const summaryRequirementTags = document.getElementById('summaryRequirementTags');
            
            if (summaryTitle) summaryTitle.textContent = '未设置';
            if (summaryPriority) summaryPriority.textContent = '未设置';
            if (summaryComplexity) summaryComplexity.textContent = '分析中';
            if (summaryDuration) summaryDuration.textContent = '评估中';
            if (summaryDescription) summaryDescription.textContent = '正在收集任务信息...';
            if (summaryRequirements) summaryRequirements.classList.add('hidden');
            if (summaryRequirementTags) summaryRequirementTags.innerHTML = '';
        }
        
        // 获取阶段描述
        function getPhaseDescription(phase) {
            const descriptions = {
                'initial': '初始化对话...',
                'collecting': '收集任务基本信息...',
                'analyzing': '分析任务需求和约束...',
                'refining': '完善任务细节...',
                'finalizing': '最终确认任务信息...',
                'decomposing': '分解复杂任务...',
                'completed': '任务创建完成'
            };
            
            return descriptions[phase] || '处理中...';
        }
        
        // 显示快速回复选项
        function showQuickReplies(question) {
            const quickReplies = document.getElementById('quickReplies');
            const quickReplyButtons = document.getElementById('quickReplyButtons');
            
            // 根据问题类型生成快速回复选项
            const replies = generateQuickReplies(question);
            
            if (replies.length > 0) {
                quickReplyButtons.innerHTML = '';
                replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.className = 'quick-reply-btn';
                    button.textContent = reply;
                    button.onclick = () => selectQuickReply(reply);
                    quickReplyButtons.appendChild(button);
                });
                
                quickReplies.classList.remove('hidden');
            } else {
                quickReplies.classList.add('hidden');
            }
        }
        
        // 生成快速回复选项
        function generateQuickReplies(question) {
            const lowerQuestion = question.toLowerCase();
            
            if (lowerQuestion.includes('优先级') || lowerQuestion.includes('重要')) {
                return ['高优先级', '中等优先级', '低优先级'];
            } else if (lowerQuestion.includes('时间') || lowerQuestion.includes('期限')) {
                return ['今天完成', '本周完成', '本月完成', '没有特定期限'];
            } else if (lowerQuestion.includes('类型') || lowerQuestion.includes('分类')) {
                return ['工作任务', '学习任务', '生活任务', '项目任务'];
            } else if (lowerQuestion.includes('是否') || lowerQuestion.includes('需要')) {
                return ['是的', '不需要', '不确定'];
            } else {
                return [];
            }
        }
        
        // 选择快速回复
        function selectQuickReply(reply) {
            const input = document.getElementById('metaAgentInput');
            input.value = reply;
            
            // 隐藏快速回复
            const quickReplies = document.getElementById('quickReplies');
            quickReplies.classList.add('hidden');
            
            // 自动发送
            sendMetaAgentMessage();
        }
        
        // 显示任务拆解
        async function showTaskDecomposition() {
            if (!window.metaAgentChatManager || !window.metaAgentChatManager.canDecompose) {
                showNotification('当前任务复杂度不足，无需拆解', 'info');
                return;
            }
            
            try {
                showNotification('正在分析任务复杂度...', 'info');
                
                const result = await window.metaAgentChatManager.requestDecomposition();
                
                if (result.success) {
                    displayDecompositionResult(result.data);
                    
                    // 打开拆解结果模态框
                    const modal = document.getElementById('taskDecompositionModal');
                    modal.classList.remove('hidden');
                } else {
                    showNotification('任务拆解失败: ' + (result.errors ? result.errors.join(', ') : '未知错误'), 'error');
                }
            } catch (error) {
                console.error('任务拆解失败:', error);
                showNotification('任务拆解时发生错误', 'error');
            }
        }
        
        // 显示拆解结果
        function displayDecompositionResult(decompositionData) {
            // 计算统计信息
            const stats = calculateDecompositionStats(decompositionData);
            
            // 更新统计信息显示
            updateDecompositionStats(stats);
            
            // 更新复杂度评分
            const complexityScore = document.getElementById('complexityScore');
            if (complexityScore && decompositionData.complexity !== undefined) {
                complexityScore.textContent = decompositionData.complexity.toFixed(1);
            }
            
            // 显示主任务
            const mainTaskDisplay = document.getElementById('mainTaskDisplay');
            if (mainTaskDisplay && decompositionData.mainTask) {
                mainTaskDisplay.innerHTML = createTaskItemHTML(decompositionData.mainTask, 'main');
            }
            
            // 显示子任务
            const subtaskList = document.getElementById('subtaskList');
            const subtaskCount = document.getElementById('subtaskCount');
            
            if (subtaskList && decompositionData.subtasks) {
                subtaskList.innerHTML = '';
                decompositionData.subtasks.forEach((subtask, index) => {
                    const subtaskElement = document.createElement('div');
                    subtaskElement.className = 'task-item subtask glass-morphism p-4 rounded-lg';
                    subtaskElement.innerHTML = createTaskItemHTML(subtask, 'subtask', index + 1);
                    subtaskList.appendChild(subtaskElement);
                });
                
                if (subtaskCount) {
                    subtaskCount.textContent = `(${decompositionData.subtasks.length}个子任务)`;
                }
            }
            
            // 显示依赖关系
            if (decompositionData.dependencies && decompositionData.dependencies.length > 0) {
                const dependenciesSection = document.getElementById('dependenciesSection');
                const dependencyGraph = document.getElementById('dependencyGraph');
                
                if (dependenciesSection && dependencyGraph) {
                    dependenciesSection.classList.remove('hidden');
                    dependencyGraph.innerHTML = createDependencyGraphHTML(decompositionData.dependencies);
                }
            }
        }
        
        // 创建任务项HTML
        function createTaskItemHTML(task, type, index = null) {
            const priorityClass = getPriorityClass(task.priority);
            const indexText = index ? `${index}. ` : '';
            const typeIcon = type === 'main' ? 'fas fa-flag' : 'fas fa-tasks';
            const typeLabel = type === 'main' ? '主任务' : '子任务';
            
            return `
                <div class="task-content">
                    <div class="task-header flex items-center justify-between mb-3">
                        <div class="task-title-section flex items-center">
                            <div class="task-type-indicator mr-3">
                                <i class="${typeIcon} text-lg ${type === 'main' ? 'text-purple-300' : 'text-blue-300'}"></i>
                            </div>
                            <div>
                                <h6 class="task-title text-lg font-semibold">${indexText}${task.title || task.name || '未命名任务'}</h6>
                                <div class="task-type-label text-xs opacity-60">${typeLabel}</div>
                            </div>
                        </div>
                        <div class="task-meta flex items-center space-x-2">
                            <span class="task-priority ${priorityClass}">${task.priority || '中'}</span>
                            ${task.estimatedDuration ? `<span class="task-duration">${task.estimatedDuration}h</span>` : ''}
                            ${task.complexity ? `<span class="task-complexity text-xs opacity-60">复杂度: ${Math.round(task.complexity * 100)}%</span>` : ''}
                        </div>
                    </div>
                    <p class="task-description text-sm opacity-80 mb-3">${task.description || '暂无描述'}</p>
                    
                    <!-- 任务详细信息 -->
                    <div class="task-details grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        ${task.requirements && task.requirements.length > 0 ? `
                            <div class="task-requirements">
                                <div class="detail-label text-xs opacity-60 mb-1 flex items-center">
                                    <i class="fas fa-list-check mr-1"></i>
                                    需求清单:
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    ${task.requirements.map(req => `<span class="requirement-tag">${req}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${task.deliverables && task.deliverables.length > 0 ? `
                            <div class="task-deliverables">
                                <div class="detail-label text-xs opacity-60 mb-1 flex items-center">
                                    <i class="fas fa-box mr-1"></i>
                                    交付物:
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    ${task.deliverables.map(item => `<span class="deliverable-tag">${item}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${task.dependencies && task.dependencies.length > 0 ? `
                        <div class="task-dependencies">
                            <div class="detail-label text-xs opacity-60 mb-1 flex items-center">
                                <i class="fas fa-project-diagram mr-1"></i>
                                依赖任务:
                            </div>
                            <div class="flex flex-wrap gap-1">
                                ${task.dependencies.map(dep => `<span class="dependency-tag">${dep}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- 任务进度指示器 -->
                    <div class="task-progress mt-3 pt-3 border-t border-white border-opacity-10">
                        <div class="progress-info flex items-center justify-between text-xs opacity-60">
                            <span>预计进度</span>
                            <span>0%</span>
                        </div>
                        <div class="progress-bar w-full h-1 bg-white bg-opacity-10 rounded-full mt-1">
                            <div class="progress-fill h-full bg-gradient-to-r from-purple-400 to-purple-600 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 编辑表单 -->
                <div class="task-edit-form">
                    <div class="space-y-3">
                        <input type="text" class="task-title-input w-full p-2 rounded bg-white bg-opacity-10 text-blue-100" 
                               value="${task.title || task.name || ''}" placeholder="任务标题">
                        <textarea class="task-desc-input w-full p-2 rounded bg-white bg-opacity-10 text-blue-100" 
                                  rows="3" placeholder="任务描述">${task.description || ''}</textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <select class="task-priority-input p-2 rounded bg-white bg-opacity-10 text-blue-100">
                                <option value="低" ${task.priority === '低' ? 'selected' : ''}>低优先级</option>
                                <option value="中" ${task.priority === '中' ? 'selected' : ''}>中优先级</option>
                                <option value="高" ${task.priority === '高' ? 'selected' : ''}>高优先级</option>
                            </select>
                            <input type="number" class="task-duration-input p-2 rounded bg-white bg-opacity-10 text-blue-100" 
                                   value="${task.estimatedDuration || ''}" placeholder="预计时长(小时)" step="0.5" min="0">
                        </div>
                        
                        <!-- 依赖关系编辑 -->
                        <div class="dependencies-edit mt-3">
                            <label class="block text-xs opacity-60 mb-1">依赖任务 (用逗号分隔):</label>
                            <input type="text" class="task-dependencies-input w-full p-2 rounded bg-white bg-opacity-10 text-blue-100" 
                                   value="${task.dependencies ? task.dependencies.join(', ') : ''}" 
                                   placeholder="输入依赖的任务名称">
                        </div>
                        
                        <!-- 需求编辑 -->
                        <div class="requirements-edit mt-3">
                            <label class="block text-xs opacity-60 mb-1">需求清单 (用逗号分隔):</label>
                            <input type="text" class="task-requirements-input w-full p-2 rounded bg-white bg-opacity-10 text-blue-100" 
                                   value="${task.requirements ? task.requirements.join(', ') : ''}" 
                                   placeholder="输入任务需求">
                        </div>
                    </div>
                    <div class="flex space-x-2 mt-3">
                        <button onclick="saveTaskEdit(this)" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-white text-sm flex items-center">
                            <i class="fas fa-save mr-1"></i>
                            保存
                        </button>
                        <button onclick="cancelTaskEdit(this)" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white text-sm flex items-center">
                            <i class="fas fa-times mr-1"></i>
                            取消
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 获取优先级样式类
        function getPriorityClass(priority) {
            switch (priority) {
                case '高':
                case 'high':
                    return 'priority-high';
                case '中':
                case 'medium':
                    return 'priority-medium';
                case '低':
                case 'low':
                    return 'priority-low';
                default:
                    return 'priority-medium';
            }
        }
        
        // 创建依赖关系图HTML
        function createDependencyGraphHTML(dependencies) {
            return `
                <div class="dependency-placeholder">
                    <i class="fas fa-project-diagram text-4xl mb-3 opacity-50"></i>
                    <p class="text-lg">依赖关系图</p>
                    <p class="text-sm opacity-75 mt-2">显示任务之间的依赖关系</p>
                    <div class="mt-4 text-xs">
                        <p>检测到 ${dependencies.length} 个依赖关系</p>
                    </div>
                </div>
            `;
        }
        
        // 计算拆解统计信息
        function calculateDecompositionStats(decompositionData) {
            const subtasks = decompositionData.subtasks || [];
            const dependencies = decompositionData.dependencies || [];
            
            // 计算总任务数（主任务 + 子任务）
            const totalTasks = 1 + subtasks.length;
            
            // 计算预计总时长
            let totalTime = 0;
            if (decompositionData.mainTask && decompositionData.mainTask.estimatedDuration) {
                totalTime += parseFloat(decompositionData.mainTask.estimatedDuration) || 0;
            }
            subtasks.forEach(task => {
                if (task.estimatedDuration) {
                    totalTime += parseFloat(task.estimatedDuration) || 0;
                }
            });
            
            // 计算任务层级（简单实现：主任务为1级，子任务为2级）
            const taskLevels = subtasks.length > 0 ? 2 : 1;
            
            // 依赖关系数量
            const dependenciesCount = dependencies.length;
            
            return {
                totalTasks,
                totalTime,
                taskLevels,
                dependenciesCount,
                subtasksCount: subtasks.length
            };
        }
        
        // 更新拆解统计信息显示
        function updateDecompositionStats(stats) {
            // 更新总任务数
            const totalTasksElement = document.getElementById('totalTasksCount');
            if (totalTasksElement) {
                totalTasksElement.textContent = stats.totalTasks;
            }
            
            // 更新预计时长
            const estimatedTimeElement = document.getElementById('estimatedTime');
            if (estimatedTimeElement) {
                if (stats.totalTime > 0) {
                    estimatedTimeElement.textContent = `${stats.totalTime}h`;
                } else {
                    estimatedTimeElement.textContent = '待评估';
                }
            }
            
            // 更新任务层级
            const taskLevelsElement = document.getElementById('taskLevels');
            if (taskLevelsElement) {
                taskLevelsElement.textContent = stats.taskLevels;
            }
            
            // 更新依赖关系数量
            const dependenciesCountElement = document.getElementById('dependenciesCount');
            if (dependenciesCountElement) {
                dependenciesCountElement.textContent = stats.dependenciesCount;
            }
            
            // 更新子任务数量显示
            const subtaskCountElement = document.getElementById('subtaskCount');
            if (subtaskCountElement) {
                subtaskCountElement.textContent = `(${stats.subtasksCount}个子任务)`;
            }
        }
        
        // 关闭任务拆解模态框
        function closeTaskDecomposition() {
            const modal = document.getElementById('taskDecompositionModal');
            modal.classList.add('hidden');
        }
        
        // 编辑拆解结果
        function editDecompositionResult() {
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(item => {
                item.classList.add('editing');
            });
            
            // 显示编辑工具栏
            showEditToolbar();
            
            showNotification('进入编辑模式，您可以修改任务信息、添加或删除子任务', 'info');
        }
        
        // 显示编辑工具栏
        function showEditToolbar() {
            const subtasksSection = document.querySelector('.subtasks');
            if (!subtasksSection) return;
            
            // 检查是否已经有工具栏
            let toolbar = subtasksSection.querySelector('.edit-toolbar');
            if (toolbar) return;
            
            // 创建编辑工具栏
            toolbar = document.createElement('div');
            toolbar.className = 'edit-toolbar glass-morphism p-3 rounded-lg mb-3 flex items-center justify-between';
            toolbar.innerHTML = `
                <div class="toolbar-info flex items-center">
                    <i class="fas fa-edit mr-2 text-purple-300"></i>
                    <span class="text-sm">编辑模式</span>
                </div>
                <div class="toolbar-actions flex space-x-2">
                    <button onclick="addNewSubtask()" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-white text-sm flex items-center">
                        <i class="fas fa-plus mr-1"></i>
                        添加子任务
                    </button>
                    <button onclick="exitEditMode()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm flex items-center">
                        <i class="fas fa-check mr-1"></i>
                        完成编辑
                    </button>
                </div>
            `;
            
            // 插入到子任务标题后面
            const subtaskTitle = subtasksSection.querySelector('h5');
            if (subtaskTitle) {
                subtaskTitle.insertAdjacentElement('afterend', toolbar);
            }
        }
        
        // 退出编辑模式
        function exitEditMode() {
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(item => {
                item.classList.remove('editing');
            });
            
            // 隐藏编辑工具栏
            const toolbar = document.querySelector('.edit-toolbar');
            if (toolbar) {
                toolbar.remove();
            }
            
            // 移除删除按钮
            const deleteButtons = document.querySelectorAll('.delete-task-btn');
            deleteButtons.forEach(btn => btn.remove());
            
            showNotification('编辑完成', 'success');
        }
        
        // 添加新的子任务
        function addNewSubtask() {
            const subtaskList = document.getElementById('subtaskList');
            if (!subtaskList) return;
            
            // 创建新的子任务数据
            const newSubtask = {
                title: '新子任务',
                description: '请输入任务描述',
                priority: '中',
                estimatedDuration: 1,
                requirements: [],
                dependencies: []
            };
            
            // 计算新的索引
            const existingSubtasks = subtaskList.querySelectorAll('.task-item');
            const newIndex = existingSubtasks.length + 1;
            
            // 创建新的子任务元素
            const subtaskElement = document.createElement('div');
            subtaskElement.className = 'task-item subtask glass-morphism p-4 rounded-lg editing';
            subtaskElement.innerHTML = createTaskItemHTML(newSubtask, 'subtask', newIndex);
            
            // 添加删除按钮
            addDeleteButton(subtaskElement);
            
            // 添加到列表
            subtaskList.appendChild(subtaskElement);
            
            // 更新统计信息
            updateSubtaskCount();
            
            showNotification('新子任务已添加', 'success');
        }
        
        // 添加删除按钮到任务项
        function addDeleteButton(taskItem) {
            // 只为子任务添加删除按钮
            if (!taskItem.classList.contains('subtask')) return;
            
            const taskHeader = taskItem.querySelector('.task-header');
            if (!taskHeader) return;
            
            // 检查是否已经有删除按钮
            if (taskHeader.querySelector('.delete-task-btn')) return;
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-task-btn ml-2 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-white text-xs flex items-center';
            deleteButton.innerHTML = '<i class="fas fa-trash mr-1"></i>删除';
            deleteButton.onclick = () => deleteSubtask(taskItem);
            
            const taskMeta = taskHeader.querySelector('.task-meta');
            if (taskMeta) {
                taskMeta.appendChild(deleteButton);
            }
        }
        
        // 删除子任务
        function deleteSubtask(taskItem) {
            if (!confirm('确定要删除这个子任务吗？')) return;
            
            taskItem.remove();
            
            // 重新编号剩余的子任务
            renumberSubtasks();
            
            // 更新统计信息
            updateSubtaskCount();
            
            showNotification('子任务已删除', 'success');
        }
        
        // 重新编号子任务
        function renumberSubtasks() {
            const subtaskList = document.getElementById('subtaskList');
            if (!subtaskList) return;
            
            const subtasks = subtaskList.querySelectorAll('.task-item');
            subtasks.forEach((subtask, index) => {
                const titleElement = subtask.querySelector('.task-title');
                if (titleElement) {
                    const titleText = titleElement.textContent;
                    const newTitle = `${index + 1}. ${titleText.replace(/^\d+\.\s*/, '')}`;
                    titleElement.textContent = newTitle;
                }
                
                const titleInput = subtask.querySelector('.task-title-input');
                if (titleInput) {
                    const inputValue = titleInput.value;
                    titleInput.value = inputValue.replace(/^\d+\.\s*/, '');
                }
            });
        }
        
        // 更新子任务数量显示
        function updateSubtaskCount() {
            const subtaskList = document.getElementById('subtaskList');
            const subtaskCountElement = document.getElementById('subtaskCount');
            
            if (subtaskList && subtaskCountElement) {
                const count = subtaskList.querySelectorAll('.task-item').length;
                subtaskCountElement.textContent = `(${count}个子任务)`;
                
                // 更新统计卡片
                const totalTasksElement = document.getElementById('totalTasksCount');
                if (totalTasksElement) {
                    totalTasksElement.textContent = count + 1; // +1 for main task
                }
            }
        }
        
        // 保存任务编辑
        function saveTaskEdit(button) {
            const taskItem = button.closest('.task-item');
            
            // 获取输入元素
            const titleInput = taskItem.querySelector('.task-title-input');
            const descInput = taskItem.querySelector('.task-desc-input');
            const priorityInput = taskItem.querySelector('.task-priority-input');
            const durationInput = taskItem.querySelector('.task-duration-input');
            const dependenciesInput = taskItem.querySelector('.task-dependencies-input');
            const requirementsInput = taskItem.querySelector('.task-requirements-input');
            
            // 验证输入
            if (!titleInput || !titleInput.value.trim()) {
                showNotification('任务标题不能为空', 'error');
                return;
            }
            
            // 更新显示内容
            const titleElement = taskItem.querySelector('.task-title');
            const descElement = taskItem.querySelector('.task-description');
            const priorityElement = taskItem.querySelector('.task-priority');
            const durationElement = taskItem.querySelector('.task-duration');
            
            // 更新标题
            if (titleElement && titleInput) {
                const isSubtask = taskItem.classList.contains('subtask');
                const titleText = titleInput.value.trim();
                
                if (isSubtask) {
                    // 保持子任务编号
                    const currentTitle = titleElement.textContent;
                    const numberMatch = currentTitle.match(/^(\d+\.\s*)/);
                    const prefix = numberMatch ? numberMatch[1] : '';
                    titleElement.textContent = prefix + titleText;
                } else {
                    titleElement.textContent = titleText;
                }
            }
            
            // 更新描述
            if (descElement && descInput) {
                descElement.textContent = descInput.value.trim() || '暂无描述';
            }
            
            // 更新优先级
            if (priorityElement && priorityInput) {
                const newPriority = priorityInput.value;
                priorityElement.textContent = newPriority;
                priorityElement.className = `task-priority ${getPriorityClass(newPriority)}`;
            }
            
            // 更新预计时长
            if (durationElement && durationInput) {
                const duration = parseFloat(durationInput.value);
                if (duration > 0) {
                    durationElement.textContent = `${duration}h`;
                    durationElement.style.display = 'inline-block';
                } else {
                    durationElement.style.display = 'none';
                }
            }
            
            // 更新依赖关系
            if (dependenciesInput) {
                const dependenciesContainer = taskItem.querySelector('.task-dependencies');
                const dependenciesValue = dependenciesInput.value.trim();
                
                if (dependenciesValue) {
                    const dependencies = dependenciesValue.split(',').map(dep => dep.trim()).filter(dep => dep);
                    
                    if (dependencies.length > 0) {
                        if (!dependenciesContainer) {
                            // 创建依赖关系容器
                            const newContainer = document.createElement('div');
                            newContainer.className = 'task-dependencies';
                            newContainer.innerHTML = `
                                <div class="detail-label text-xs opacity-60 mb-1 flex items-center">
                                    <i class="fas fa-project-diagram mr-1"></i>
                                    依赖任务:
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    ${dependencies.map(dep => `<span class="dependency-tag">${dep}</span>`).join('')}
                                </div>
                            `;
                            
                            const taskContent = taskItem.querySelector('.task-content');
                            if (taskContent) {
                                taskContent.appendChild(newContainer);
                            }
                        } else {
                            // 更新现有容器
                            const tagsContainer = dependenciesContainer.querySelector('.flex');
                            if (tagsContainer) {
                                tagsContainer.innerHTML = dependencies.map(dep => `<span class="dependency-tag">${dep}</span>`).join('');
                            }
                        }
                    }
                } else if (dependenciesContainer) {
                    // 移除依赖关系容器
                    dependenciesContainer.remove();
                }
            }
            
            // 更新需求清单
            if (requirementsInput) {
                const requirementsContainer = taskItem.querySelector('.task-requirements');
                const requirementsValue = requirementsInput.value.trim();
                
                if (requirementsValue) {
                    const requirements = requirementsValue.split(',').map(req => req.trim()).filter(req => req);
                    
                    if (requirements.length > 0) {
                        if (!requirementsContainer) {
                            // 创建需求容器
                            const newContainer = document.createElement('div');
                            newContainer.className = 'task-requirements';
                            newContainer.innerHTML = `
                                <div class="detail-label text-xs opacity-60 mb-1 flex items-center">
                                    <i class="fas fa-list-check mr-1"></i>
                                    需求清单:
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    ${requirements.map(req => `<span class="requirement-tag">${req}</span>`).join('')}
                                </div>
                            `;
                            
                            const taskDetails = taskItem.querySelector('.task-details');
                            if (taskDetails) {
                                taskDetails.appendChild(newContainer);
                            }
                        } else {
                            // 更新现有容器
                            const tagsContainer = requirementsContainer.querySelector('.flex');
                            if (tagsContainer) {
                                tagsContainer.innerHTML = requirements.map(req => `<span class="requirement-tag">${req}</span>`).join('');
                            }
                        }
                    }
                } else if (requirementsContainer) {
                    // 移除需求容器
                    requirementsContainer.remove();
                }
            }
            
            // 退出编辑模式
            taskItem.classList.remove('editing');
            
            // 更新统计信息
            updateDecompositionStatsFromDOM();
            
            showNotification('任务信息已更新', 'success');
        }
        
        // 从DOM更新统计信息
        function updateDecompositionStatsFromDOM() {
            const subtaskList = document.getElementById('subtaskList');
            const mainTask = document.getElementById('mainTaskDisplay');
            
            if (!subtaskList || !mainTask) return;
            
            const subtasks = subtaskList.querySelectorAll('.task-item');
            const totalTasks = subtasks.length + 1; // +1 for main task
            
            // 计算总时长
            let totalTime = 0;
            
            // 主任务时长
            const mainDuration = mainTask.querySelector('.task-duration');
            if (mainDuration) {
                const duration = parseFloat(mainDuration.textContent);
                if (!isNaN(duration)) totalTime += duration;
            }
            
            // 子任务时长
            subtasks.forEach(subtask => {
                const duration = subtask.querySelector('.task-duration');
                if (duration) {
                    const durationValue = parseFloat(duration.textContent);
                    if (!isNaN(durationValue)) totalTime += durationValue;
                }
            });
            
            // 更新显示
            const stats = {
                totalTasks,
                totalTime,
                taskLevels: subtasks.length > 0 ? 2 : 1,
                dependenciesCount: 0, // 简化处理
                subtasksCount: subtasks.length
            };
            
            updateDecompositionStats(stats);
        }
        
        // 验证拆解结果
        function validateDecompositionResult() {
            const mainTask = document.getElementById('mainTaskDisplay');
            const subtaskList = document.getElementById('subtaskList');
            
            const errors = [];
            
            // 验证主任务
            if (mainTask) {
                const mainTitle = mainTask.querySelector('.task-title');
                if (!mainTitle || !mainTitle.textContent.trim()) {
                    errors.push('主任务标题不能为空');
                }
            } else {
                errors.push('缺少主任务');
            }
            
            // 验证子任务
            if (subtaskList) {
                const subtasks = subtaskList.querySelectorAll('.task-item');
                subtasks.forEach((subtask, index) => {
                    const title = subtask.querySelector('.task-title');
                    if (!title || !title.textContent.trim()) {
                        errors.push(`子任务 ${index + 1} 标题不能为空`);
                    }
                });
                
                // 检查是否有重复的任务标题
                const titles = Array.from(subtasks).map(subtask => {
                    const titleElement = subtask.querySelector('.task-title');
                    return titleElement ? titleElement.textContent.replace(/^\d+\.\s*/, '').trim() : '';
                });
                
                const duplicates = titles.filter((title, index) => titles.indexOf(title) !== index);
                if (duplicates.length > 0) {
                    errors.push(`发现重复的任务标题: ${duplicates.join(', ')}`);
                }
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }
        
        // 保存拆解结果到元智能体管理器
        function saveDecompositionResult() {
            // 验证结果
            const validation = validateDecompositionResult();
            if (!validation.isValid) {
                showNotification('验证失败: ' + validation.errors.join('; '), 'error');
                return false;
            }
            
            // 收集拆解结果数据
            const decompositionData = collectDecompositionData();
            
            // 更新元智能体管理器中的拆解结果
            if (window.metaAgentChatManager) {
                window.metaAgentChatManager.updateDecompositionResult(decompositionData);
            }
            
            showNotification('拆解结果已保存', 'success');
            return true;
        }
        
        // 收集拆解结果数据
        function collectDecompositionData() {
            const mainTaskElement = document.getElementById('mainTaskDisplay');
            const subtaskList = document.getElementById('subtaskList');
            
            // 收集主任务数据
            const mainTask = collectTaskData(mainTaskElement);
            
            // 收集子任务数据
            const subtasks = [];
            if (subtaskList) {
                const subtaskElements = subtaskList.querySelectorAll('.task-item');
                subtaskElements.forEach(element => {
                    subtasks.push(collectTaskData(element));
                });
            }
            
            return {
                mainTask,
                subtasks,
                dependencies: [], // 简化处理
                complexity: window.metaAgentChatManager ? window.metaAgentChatManager.taskContext.complexity : 0.7,
                estimatedTotalTime: calculateTotalTime(mainTask, subtasks)
            };
        }
        
        // 收集单个任务的数据
        function collectTaskData(taskElement) {
            if (!taskElement) return null;
            
            const titleElement = taskElement.querySelector('.task-title');
            const descElement = taskElement.querySelector('.task-description');
            const priorityElement = taskElement.querySelector('.task-priority');
            const durationElement = taskElement.querySelector('.task-duration');
            
            // 收集依赖关系
            const dependencies = [];
            const dependencyTags = taskElement.querySelectorAll('.dependency-tag');
            dependencyTags.forEach(tag => {
                dependencies.push(tag.textContent.trim());
            });
            
            // 收集需求
            const requirements = [];
            const requirementTags = taskElement.querySelectorAll('.requirement-tag');
            requirementTags.forEach(tag => {
                requirements.push(tag.textContent.trim());
            });
            
            return {
                title: titleElement ? titleElement.textContent.replace(/^\d+\.\s*/, '').trim() : '',
                description: descElement ? descElement.textContent.trim() : '',
                priority: priorityElement ? priorityElement.textContent.trim() : '中',
                estimatedDuration: durationElement ? parseFloat(durationElement.textContent) || 0 : 0,
                dependencies,
                requirements
            };
        }
        
        // 计算总时长
        function calculateTotalTime(mainTask, subtasks) {
            let total = 0;
            
            if (mainTask && mainTask.estimatedDuration) {
                total += mainTask.estimatedDuration;
            }
            
            subtasks.forEach(subtask => {
                if (subtask.estimatedDuration) {
                    total += subtask.estimatedDuration;
                }
            });
            
            return total;
        }
        
        // 取消任务编辑
        function cancelTaskEdit(button) {
            const taskItem = button.closest('.task-item');
            taskItem.classList.remove('editing');
        }
        
        // 重新生成拆解
        async function regenerateDecomposition() {
            if (!window.metaAgentChatManager) {
                showNotification('元智能体管理器未初始化', 'error');
                return;
            }
            
            try {
                showNotification('正在重新分析任务...', 'info');
                
                const result = await window.metaAgentChatManager.requestDecomposition();
                
                if (result.success) {
                    displayDecompositionResult(result.data);
                    showNotification('任务拆解已更新', 'success');
                } else {
                    showNotification('重新拆解失败: ' + (result.errors ? result.errors.join(', ') : '未知错误'), 'error');
                }
            } catch (error) {
                console.error('重新拆解失败:', error);
                showNotification('重新拆解时发生错误', 'error');
            }
        }
        
        // 确认任务创建
        async function confirmTaskCreation() {
            if (!window.metaAgentChatManager) {
                showNotification('元智能体管理器未初始化', 'error');
                return;
            }
            
            try {
                // 验证拆解结果
                const validation = validateDecompositionResult();
                if (!validation.isValid) {
                    showNotification('验证失败: ' + validation.errors.join('; '), 'error');
                    return;
                }
                
                // 显示确认对话框
                const confirmed = await showTaskCreationConfirmation();
                if (!confirmed) return;
                
                // 显示创建进度
                showTaskCreationProgress();
                
                // 收集最终的拆解数据
                const decompositionData = collectDecompositionData();
                
                // 批量创建任务
                const result = await createTasksBatch(decompositionData);
                
                if (result.success) {
                    // 显示创建成功
                    showTaskCreationSuccess(result.data);
                    
                    // 关闭所有模态框
                    setTimeout(() => {
                        closeTaskDecomposition();
                        closeMetaAgentChat();
                        
                        // 刷新任务列表
                        if (typeof loadTasks === 'function') {
                            loadTasks();
                        }
                        
                        // 切换到任务页面
                        if (typeof showPage === 'function') {
                            showPage('tasks');
                        }
                    }, 2000);
                    
                } else {
                    showTaskCreationError(result.errors);
                }
                
            } catch (error) {
                console.error('创建任务失败:', error);
                showTaskCreationError(['创建任务时发生未知错误']);
            }
        }
        
        // 显示任务创建确认对话框
        function showTaskCreationConfirmation() {
            return new Promise((resolve) => {
                const subtaskList = document.getElementById('subtaskList');
                const subtaskCount = subtaskList ? subtaskList.querySelectorAll('.task-item').length : 0;
                const totalTasks = subtaskCount + 1; // +1 for main task
                
                const confirmed = confirm(
                    `确认创建任务吗？\n\n` +
                    `将创建 ${totalTasks} 个任务：\n` +
                    `- 1 个主任务\n` +
                    `- ${subtaskCount} 个子任务\n\n` +
                    `创建后将自动添加到任务列表中。`
                );
                
                resolve(confirmed);
            });
        }
        
        // 显示任务创建进度
        function showTaskCreationProgress() {
            const modal = document.getElementById('taskDecompositionModal');
            const content = modal.querySelector('.decomposition-content');
            
            content.innerHTML = `
                <div class="creation-progress text-center py-12">
                    <div class="progress-animation mb-6">
                        <div class="creation-spinner">
                            <i class="fas fa-cog fa-spin text-6xl text-purple-300 mb-4"></i>
                        </div>
                        <div class="progress-steps">
                            <div class="step active" id="step-validate">
                                <i class="fas fa-check-circle mr-2"></i>
                                验证任务信息
                            </div>
                            <div class="step" id="step-create">
                                <i class="fas fa-plus-circle mr-2"></i>
                                创建主任务
                            </div>
                            <div class="step" id="step-subtasks">
                                <i class="fas fa-tasks mr-2"></i>
                                创建子任务
                            </div>
                            <div class="step" id="step-complete">
                                <i class="fas fa-flag-checkered mr-2"></i>
                                完成创建
                            </div>
                        </div>
                    </div>
                    <h5 class="text-xl font-semibold mb-2">正在创建任务...</h5>
                    <p class="text-sm opacity-75" id="progressMessage">正在验证任务信息</p>
                </div>
            `;
        }
        
        // 批量创建任务
        async function createTasksBatch(decompositionData) {
            try {
                // 更新进度：创建主任务
                updateCreationProgress('step-create', '正在创建主任务...');
                
                // 创建主任务
                const mainTaskResult = await createSingleTask(decompositionData.mainTask, 'main');
                if (!mainTaskResult.success) {
                    return { success: false, errors: ['主任务创建失败: ' + mainTaskResult.error] };
                }
                
                await delay(500); // 短暂延迟以显示进度
                
                // 更新进度：创建子任务
                updateCreationProgress('step-subtasks', `正在创建 ${decompositionData.subtasks.length} 个子任务...`);
                
                // 创建子任务
                const subtaskResults = [];
                for (let i = 0; i < decompositionData.subtasks.length; i++) {
                    const subtask = decompositionData.subtasks[i];
                    const result = await createSingleTask(subtask, 'subtask', i + 1);
                    subtaskResults.push(result);
                    
                    // 更新子任务创建进度
                    updateCreationProgress('step-subtasks', `正在创建子任务 ${i + 1}/${decompositionData.subtasks.length}...`);
                    await delay(300);
                }
                
                // 检查子任务创建结果
                const failedSubtasks = subtaskResults.filter(result => !result.success);
                if (failedSubtasks.length > 0) {
                    return { 
                        success: false, 
                        errors: [`${failedSubtasks.length} 个子任务创建失败`] 
                    };
                }
                
                // 更新进度：完成
                updateCreationProgress('step-complete', '任务创建完成！');
                
                // 通知元智能体管理器任务创建完成
                const finalizeResult = await window.metaAgentChatManager.finalizeTask(decompositionData);
                
                return {
                    success: true,
                    data: {
                        mainTask: mainTaskResult.data,
                        subtasks: subtaskResults.map(result => result.data),
                        totalCreated: 1 + decompositionData.subtasks.length
                    }
                };
                
            } catch (error) {
                console.error('批量创建任务失败:', error);
                return { success: false, errors: ['批量创建过程中发生错误'] };
            }
        }
        
        // 创建单个任务
        async function createSingleTask(taskData, type, index = null) {
            try {
                // 构建任务对象
                const task = {
                    name: taskData.title,
                    description: taskData.description,
                    priority: taskData.priority || '中',
                    deadline: '', // 可以根据需要设置截止日期
                    assignee: '', // 可以根据需要设置负责人
                    type: type,
                    index: index,
                    estimatedDuration: taskData.estimatedDuration || 0,
                    dependencies: taskData.dependencies || [],
                    requirements: taskData.requirements || [],
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    source: 'meta_agent_decomposition'
                };
                
                // 使用现有的数据管理器添加任务
                if (window.dataManager && typeof window.dataManager.addTask === 'function') {
                    const success = window.dataManager.addTask(task);
                    if (success) {
                        return { success: true, data: task };
                    } else {
                        return { success: false, error: '数据管理器添加任务失败' };
                    }
                } else {
                    // 如果没有数据管理器，模拟成功
                    console.log('创建任务:', task);
                    return { success: true, data: task };
                }
                
            } catch (error) {
                console.error('创建单个任务失败:', error);
                return { success: false, error: error.message };
            }
        }
        
        // 更新创建进度
        function updateCreationProgress(stepId, message) {
            // 更新步骤状态
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => step.classList.remove('active'));
            
            const currentStep = document.getElementById(stepId);
            if (currentStep) {
                currentStep.classList.add('active');
            }
            
            // 更新进度消息
            const progressMessage = document.getElementById('progressMessage');
            if (progressMessage) {
                progressMessage.textContent = message;
            }
        }
        
        // 显示任务创建成功
        function showTaskCreationSuccess(data) {
            const modal = document.getElementById('taskDecompositionModal');
            const content = modal.querySelector('.decomposition-content');
            
            content.innerHTML = `
                <div class="creation-success text-center py-12">
                    <div class="success-animation mb-6">
                        <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                    </div>
                    <h5 class="text-2xl font-semibold mb-4 text-green-400">任务创建成功！</h5>
                    <div class="success-stats glass-morphism p-4 rounded-lg mb-4">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-purple-300">${data.totalCreated}</div>
                                <div class="text-xs opacity-60">总任务数</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-blue-300">1</div>
                                <div class="text-xs opacity-60">主任务</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-300">${data.subtasks.length}</div>
                                <div class="text-xs opacity-60">子任务</div>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm opacity-75 mb-4">所有任务已成功添加到任务列表中</p>
                    <p class="text-xs opacity-60">页面将在 2 秒后自动跳转到任务管理页面</p>
                </div>
            `;
            
            showNotification('任务创建成功！', 'success');
        }
        
        // 显示任务创建错误
        function showTaskCreationError(errors) {
            const modal = document.getElementById('taskDecompositionModal');
            const content = modal.querySelector('.decomposition-content');
            
            content.innerHTML = `
                <div class="creation-error text-center py-12">
                    <div class="error-animation mb-6">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                    </div>
                    <h5 class="text-2xl font-semibold mb-4 text-red-400">任务创建失败</h5>
                    <div class="error-details glass-morphism p-4 rounded-lg mb-4">
                        <div class="text-sm text-left">
                            <div class="font-medium mb-2">错误详情：</div>
                            <ul class="list-disc list-inside space-y-1 opacity-75">
                                ${errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="error-actions flex justify-center space-x-3">
                        <button onclick="regenerateDecomposition()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded text-white">
                            重新拆解
                        </button>
                        <button onclick="closeTaskDecomposition()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            showNotification('任务创建失败: ' + errors.join('; '), 'error');
        }
        
        // 延迟函数
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // 设置元智能体事件处理器
        function setupMetaAgentEventHandlers() {
            if (!window.metaAgentChatManager) return;
            
            window.metaAgentChatManager.onMessage((eventType, data) => {
                switch (eventType) {
                    case 'conversation_started':
                        console.log('对话已开始:', data);
                        handleConversationStarted(data);
                        break;
                        
                    case 'message_sent':
                        console.log('消息已发送:', data);
                        handleMessageSent(data);
                        break;
                        
                    case 'complexity_analyzed':
                        console.log('复杂度分析完成:', data);
                        handleComplexityAnalyzed(data);
                        break;
                        
                    case 'task_decomposed':
                        console.log('任务拆解完成:', data);
                        handleTaskDecomposed(data);
                        break;
                        
                    case 'task_finalized':
                        console.log('任务创建完成:', data);
                        handleTaskFinalized(data);
                        break;
                        
                    case 'conversation_ended':
                        console.log('对话已结束');
                        handleConversationEnded();
                        break;
                        
                    case 'conversation_restarted':
                        console.log('对话已重新开始');
                        handleConversationRestarted();
                        break;
                        
                    case 'context_updated':
                        console.log('上下文已更新:', data);
                        handleContextUpdated(data);
                        break;
                        
                    case 'error_occurred':
                        console.error('对话错误:', data);
                        handleConversationError(data);
                        break;
                        
                    default:
                        console.log('未知事件:', eventType, data);
                }
            });
        }
        
        // ==================== 对话流程事件处理器 ====================
        
        // 处理对话开始事件
        function handleConversationStarted(data) {
            // 保存对话状态到本地存储
            saveConversationState();
            
            // 更新界面状态
            updateConversationStatus('active');
            
            // 启动自动保存
            startAutoSave();
        }
        
        // 处理消息发送事件
        function handleMessageSent(data) {
            // 更新任务上下文显示
            if (data.taskContext) {
                updateTaskContextDisplay(data.taskContext);
            }
            
            // 检查是否需要显示拆解按钮
            if (data.canDecompose) {
                const decomposeButton = document.getElementById('decomposeButton');
                if (decomposeButton) {
                    decomposeButton.classList.remove('hidden');
                    decomposeButton.title = `任务复杂度: ${(data.taskContext.complexity * 100).toFixed(0)}%`;
                }
            }
            
            // 保存对话状态
            saveConversationState();
        }
        
        // 处理复杂度分析事件
        function handleComplexityAnalyzed(data) {
            // 更新复杂度可视化显示
            updateComplexityVisualization(data);
            
            // 更新拆解按钮状态
            updateDecomposeButtonState(data);
            
            // 显示复杂度分析区域
            showComplexityAnalysis();
            
            if (data.canDecompose) {
                const decomposeButton = document.getElementById('decomposeButton');
                if (decomposeButton) {
                    decomposeButton.classList.remove('hidden');
                    decomposeButton.title = `任务复杂度: ${(data.complexity * 100).toFixed(0)}%`;
                    
                    // 添加脉冲动画提示用户
                    decomposeButton.classList.add('pulse-animation');
                    setTimeout(() => {
                        decomposeButton.classList.remove('pulse-animation');
                    }, 3000);
                }
                
                // 显示复杂度提示
                addMessageToChat('system', `📊 任务复杂度分析完成，复杂度评分: ${(data.complexity * 100).toFixed(0)}%。由于任务较为复杂，建议进行任务拆解。`);
            }
        }
        
        // 处理任务拆解事件
        function handleTaskDecomposed(data) {
            // 更新进度到拆解阶段
            updateProgress(95, 'decomposing', '任务拆解完成');
            
            // 添加系统消息
            const subtaskCount = data.decompositionResult.subtasks ? data.decompositionResult.subtasks.length : 0;
            addMessageToChat('system', `🔧 任务拆解完成！主任务已分解为 ${subtaskCount} 个子任务。您可以查看拆解结果并进行调整。`);
        }
        
        // 处理任务完成事件
        function handleTaskFinalized(data) {
            // 更新进度到完成状态
            updateProgress(100, 'completed', '任务创建完成');
            
            // 清除自动保存
            stopAutoSave();
            
            // 清除保存的对话状态
            clearConversationState();
        }
        
        // 处理对话结束事件
        function handleConversationEnded() {
            // 更新界面状态
            updateConversationStatus('ended');
            
            // 停止自动保存
            stopAutoSave();
            
            // 清除保存的对话状态
            clearConversationState();
        }
        
        // 处理对话重新开始事件
        function handleConversationRestarted() {
            // 重置界面状态
            resetMetaAgentChat();
            
            // 清除保存的对话状态
            clearConversationState();
        }
        
        // 处理上下文更新事件
        function handleContextUpdated(data) {
            if (data.taskContext) {
                updateTaskContextDisplay(data.taskContext);
            }
            
            // 保存对话状态
            saveConversationState();
        }
        
        // 处理对话错误事件
        function handleConversationError(data) {
            const errorMessage = data.error || data.message || '发生未知错误';
            
            // 显示错误消息
            addMessageToChat('system', `❌ 对话过程中发生错误: ${errorMessage}`);
            
            // 提供恢复选项
            showErrorRecoveryOptions(data);
        }
        
        // ==================== 复杂度分析可视化 ====================
        
        // 更新复杂度可视化显示
        function updateComplexityVisualization(data) {
            const complexityAnalysis = document.getElementById('complexityAnalysis');
            if (!complexityAnalysis) return;
            
            // 显示复杂度分析区域
            complexityAnalysis.classList.remove('hidden');
            
            // 更新复杂度评分圆环
            const progressRing = document.getElementById('complexityProgressRing');
            const percentage = Math.round((data.complexity || 0) * 100);
            const circumference = 2 * Math.PI * 15.9155;
            const strokeDasharray = `${(percentage / 100) * circumference}, ${circumference}`;
            
            if (progressRing) {
                progressRing.style.strokeDasharray = strokeDasharray;
                
                // 根据复杂度设置颜色
                const color = getComplexityColor(data.complexity || 0);
                progressRing.style.stroke = color;
            }
            
            // 更新百分比显示
            const complexityPercentage = document.getElementById('complexityPercentage');
            if (complexityPercentage) {
                complexityPercentage.textContent = `${percentage}%`;
            }
            
            // 更新复杂度等级
            const complexityLevel = document.getElementById('complexityLevel');
            if (complexityLevel) {
                complexityLevel.textContent = getComplexityLevel(data.complexity || 0);
            }
            
            // 更新复杂度因素标签
            if (data.factors && data.factors.length > 0) {
                updateComplexityFactors(data.factors);
            }
            
            // 更新阈值显示
            updateThresholdDisplay(data.threshold || 0.7);
            
            // 更新建议文本
            const recommendation = document.getElementById('complexityRecommendation');
            if (recommendation) {
                recommendation.textContent = getComplexityRecommendation(data.complexity || 0, data.threshold || 0.7);
            }
        }
        
        // 更新拆解按钮状态
        function updateDecomposeButtonState(data) {
            const decomposeButton = document.getElementById('decomposeButton');
            if (!decomposeButton) return;
            
            if (data.canDecompose) {
                decomposeButton.classList.remove('hidden');
                decomposeButton.classList.add('can-decompose');
                decomposeButton.title = `任务复杂度: ${Math.round((data.complexity || 0) * 100)}% - 建议拆解`;
            } else {
                decomposeButton.classList.add('hidden');
                decomposeButton.classList.remove('can-decompose');
            }
        }
        
        // 显示复杂度分析区域
        function showComplexityAnalysis() {
            const complexityAnalysis = document.getElementById('complexityAnalysis');
            if (complexityAnalysis) {
                complexityAnalysis.classList.remove('hidden');
            }
        }
        
        // 切换复杂度分析区域显示
        function toggleComplexityAnalysis() {
            const complexityAnalysis = document.getElementById('complexityAnalysis');
            const toggleIcon = document.getElementById('complexityToggleIcon');
            
            if (complexityAnalysis && toggleIcon) {
                complexityAnalysis.classList.toggle('collapsed');
                
                if (complexityAnalysis.classList.contains('collapsed')) {
                    toggleIcon.className = 'fas fa-chevron-down';
                } else {
                    toggleIcon.className = 'fas fa-chevron-up';
                }
            }
        }
        
        // 更新复杂度因素标签
        function updateComplexityFactors(factors) {
            const factorsContainer = document.getElementById('complexityFactors');
            if (!factorsContainer) return;
            
            factorsContainer.innerHTML = '';
            
            factors.forEach(factor => {
                const tag = document.createElement('span');
                tag.className = 'factor-tag';
                tag.textContent = factor;
                factorsContainer.appendChild(tag);
            });
        }
        
        // 更新阈值显示
        function updateThresholdDisplay(threshold) {
            const thresholdElement = document.getElementById('decompositionThreshold');
            const thresholdMarker = document.getElementById('thresholdMarker');
            
            if (thresholdElement) {
                thresholdElement.textContent = `${Math.round(threshold * 100)}%`;
            }
            
            if (thresholdMarker) {
                thresholdMarker.style.left = `${threshold * 100}%`;
            }
        }
        
        // 获取复杂度颜色
        function getComplexityColor(complexity) {
            if (complexity < 0.3) return '#10b981'; // 绿色
            if (complexity < 0.5) return '#f59e0b'; // 黄色
            if (complexity < 0.7) return '#f97316'; // 橙色
            return '#ef4444'; // 红色
        }
        
        // 获取复杂度等级
        function getComplexityLevel(complexity) {
            if (complexity < 0.3) return '简单';
            if (complexity < 0.5) return '中等';
            if (complexity < 0.7) return '复杂';
            return '非常复杂';
        }
        
        // 获取复杂度建议
        function getComplexityRecommendation(complexity, threshold) {
            if (complexity < threshold) {
                return '任务复杂度较低，可以直接创建';
            } else {
                return '任务复杂度较高，建议进行任务拆解';
            }
        }
        
        // ==================== 对话状态管理 ====================
        
        let autoSaveInterval = null;
        const CONVERSATION_STORAGE_KEY = 'meta_agent_conversation_state';
        
        // 开始自动保存
        function startAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            // 每30秒自动保存一次对话状态
            autoSaveInterval = setInterval(() => {
                saveConversationState();
            }, 30000);
        }
        
        // 停止自动保存
        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }
        
        // 保存对话状态
        function saveConversationState() {
            if (!window.metaAgentChatManager || !window.metaAgentChatManager.isActive) {
                return;
            }
            
            try {
                const state = {
                    conversationData: window.metaAgentChatManager.exportConversation(),
                    uiState: {
                        progress: document.getElementById('progressFill')?.style.width || '0%',
                        progressText: document.getElementById('progressText')?.textContent || '',
                        canDecompose: !document.getElementById('decomposeButton')?.classList.contains('hidden')
                    },
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem(CONVERSATION_STORAGE_KEY, JSON.stringify(state));
                console.log('对话状态已保存');
            } catch (error) {
                console.error('保存对话状态失败:', error);
            }
        }
        
        // 加载对话状态
        function loadConversationState() {
            try {
                const stateStr = localStorage.getItem(CONVERSATION_STORAGE_KEY);
                if (!stateStr) return null;
                
                const state = JSON.parse(stateStr);
                
                // 检查状态是否过期（24小时）
                const stateTime = new Date(state.timestamp);
                const now = new Date();
                const hoursDiff = (now - stateTime) / (1000 * 60 * 60);
                
                if (hoursDiff > 24) {
                    clearConversationState();
                    return null;
                }
                
                return state;
            } catch (error) {
                console.error('加载对话状态失败:', error);
                clearConversationState();
                return null;
            }
        }
        
        // 清除对话状态
        function clearConversationState() {
            try {
                localStorage.removeItem(CONVERSATION_STORAGE_KEY);
                console.log('对话状态已清除');
            } catch (error) {
                console.error('清除对话状态失败:', error);
            }
        }
        
        // 恢复对话状态
        function restoreConversationState() {
            const state = loadConversationState();
            if (!state) return false;
            
            try {
                // 恢复对话数据
                if (window.metaAgentChatManager && state.conversationData) {
                    const result = window.metaAgentChatManager.importConversation(state.conversationData);
                    if (!result.success) {
                        console.error('恢复对话数据失败');
                        return false;
                    }
                }
                
                // 恢复UI状态
                if (state.uiState) {
                    const progressFill = document.getElementById('progressFill');
                    const progressText = document.getElementById('progressText');
                    const decomposeButton = document.getElementById('decomposeButton');
                    
                    if (progressFill) progressFill.style.width = state.uiState.progress;
                    if (progressText) progressText.textContent = state.uiState.progressText;
                    if (decomposeButton && state.uiState.canDecompose) {
                        decomposeButton.classList.remove('hidden');
                    }
                }
                
                // 重新加载消息到界面
                reloadMessagesToUI();
                
                console.log('对话状态已恢复');
                showNotification('已恢复之前的对话状态', 'info');
                return true;
            } catch (error) {
                console.error('恢复对话状态失败:', error);
                clearConversationState();
                return false;
            }
        }
        
        // 重新加载消息到界面
        function reloadMessagesToUI() {
            if (!window.metaAgentChatManager) return;
            
            const messages = window.metaAgentChatManager.getMessages();
            const messagesContainer = document.getElementById('metaAgentMessages');
            
            // 清空现有消息（保留欢迎消息）
            const welcomeMessage = messagesContainer.querySelector('.message-bubble.agent-message');
            messagesContainer.innerHTML = '';
            if (welcomeMessage) {
                messagesContainer.appendChild(welcomeMessage);
            }
            
            // 重新添加所有消息
            messages.forEach(message => {
                const messageElement = createMessageElement(message.type, message.content, message.metadata);
                messagesContainer.appendChild(messageElement);
            });
            
            // 滚动到底部
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 更新对话状态显示
        function updateConversationStatus(status) {
            const statusElement = document.querySelector('.agent-status');
            if (!statusElement) return;
            
            const statusIndicator = statusElement.querySelector('.w-2.h-2');
            const statusText = statusElement.querySelector('span:not(.w-2)');
            
            switch (status) {
                case 'active':
                    if (statusIndicator) {
                        statusIndicator.className = 'w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse';
                    }
                    if (statusText) statusText.textContent = '对话中';
                    break;
                case 'thinking':
                    if (statusIndicator) {
                        statusIndicator.className = 'w-2 h-2 bg-yellow-400 rounded-full mr-2 animate-pulse';
                    }
                    if (statusText) statusText.textContent = '思考中';
                    break;
                case 'ended':
                    if (statusIndicator) {
                        statusIndicator.className = 'w-2 h-2 bg-gray-400 rounded-full mr-2';
                    }
                    if (statusText) statusText.textContent = '已结束';
                    break;
                default:
                    if (statusIndicator) {
                        statusIndicator.className = 'w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse';
                    }
                    if (statusText) statusText.textContent = '在线';
            }
        }
        
        // 更新任务上下文显示
        function updateTaskContextDisplay(taskContext) {
            // 更新任务汇总信息
            updateTaskSummaryInfo(taskContext);
            
            // 记录日志
            console.log('任务上下文已更新:', taskContext);
        }
        
        // 显示错误恢复选项
        function showErrorRecoveryOptions(errorData) {
            const quickReplies = document.getElementById('quickReplies');
            const quickReplyButtons = document.getElementById('quickReplyButtons');
            
            if (quickReplies && quickReplyButtons) {
                quickReplyButtons.innerHTML = '';
                
                // 添加恢复选项
                const recoveryOptions = [
                    { text: '重试上次操作', action: 'retry' },
                    { text: '重新开始对话', action: 'restart' },
                    { text: '保存并退出', action: 'save_exit' }
                ];
                
                recoveryOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'quick-reply-btn';
                    button.textContent = option.text;
                    button.onclick = () => handleErrorRecovery(option.action, errorData);
                    quickReplyButtons.appendChild(button);
                });
                
                quickReplies.classList.remove('hidden');
            }
        }
        
        // 处理错误恢复
        function handleErrorRecovery(action, errorData) {
            const quickReplies = document.getElementById('quickReplies');
            if (quickReplies) quickReplies.classList.add('hidden');
            
            switch (action) {
                case 'retry':
                    // 重试上次操作
                    retryLastOperation();
                    break;
                case 'restart':
                    // 重新开始对话
                    restartMetaAgentChat();
                    break;
                case 'save_exit':
                    // 保存并退出
                    saveConversationState();
                    closeMetaAgentChat();
                    showNotification('对话已保存，您可以稍后继续', 'info');
                    break;
            }
        }
        
        // 重试上次操作
        function retryLastOperation() {
            // 获取最后一条用户消息并重新发送
            if (window.metaAgentChatManager) {
                const messages = window.metaAgentChatManager.getMessages();
                const lastUserMessage = messages.reverse().find(msg => msg.type === 'user');
                
                if (lastUserMessage) {
                    const input = document.getElementById('metaAgentInput');
                    if (input) {
                        input.value = lastUserMessage.content;
                        sendMetaAgentMessage();
                    }
                } else {
                    showNotification('没有找到可重试的操作', 'warning');
                }
            }
        }
        
        // 检查并提供对话恢复
        function checkAndOfferConversationRestore() {
            const state = loadConversationState();
            if (state && state.conversationData) {
                const stateTime = new Date(state.timestamp);
                const timeAgo = Math.round((new Date() - stateTime) / (1000 * 60)); // 分钟
                
                if (confirm(`检测到 ${timeAgo} 分钟前的未完成对话，是否要恢复？`)) {
                    return restoreConversationState();
                } else {
                    clearConversationState();
                }
            }
            return false;
        }
    </script>
</body>
</html>
                loadChatHistory();
                initializeCharts();
                
                // 初始化表单验证器
                if (typeof FormValidator !== 'undefined') {
                    formValidator = new FormValidator();
                }
                
                // 初始化大模型配置管理器
                if (typeof LLMConfigManager !== 'undefined') {
                    window.llmConfigManager = new LLMConfigManager();
                    loadLLMConfigs();
                    setupFormValidation();
                    startConfigMonitoring();
                }
                
                // 初始化智能体管理器
                if (typeof AgentManager !== 'undefined') {
                    window.agentManager = new AgentManager();
                    loadAgents();
                }
            }, 1000);
        });
    </script>

    <!-- 大模型配置模态框 -->
    <div id="llm-config-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-morphism rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-blue-100 flex items-center">
                    <i class="fas fa-brain mr-2 text-purple-300"></i>
                    <span id="llm-modal-title">添加大模型配置</span>
                </h3>
                <button onclick="closeLLMConfigModal()" class="text-blue-100 hover:text-purple-300 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="llm-config-form" class="space-y-6">
                <!-- 基本信息 -->
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">基本信息</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">配置名称 *</label>
                        <input type="text" id="config-name" name="name" required
                               class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                               placeholder="请输入配置名称">
                        <div class="text-red-400 text-sm mt-1 hidden" id="name-error"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">提供商 *</label>
                        <select id="config-provider" name="provider" required
                                class="w-full p-3 rounded-lg glass-morphism text-blue-100 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                onchange="updateProviderFields()">
                            <option value="">请选择提供商</option>
                            <option value="siliconflow">SiliconFlow</option>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="local">本地部署</option>
                        </select>
                        <div class="text-red-400 text-sm mt-1 hidden" id="provider-error"></div>
                    </div>
                </div>
                
                <!-- 连接配置 -->
                <div class="space-y-4" id="connection-config">
                    <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">连接配置</h4>
                    
                    <div id="api-key-field">
                        <label class="block text-sm font-medium text-blue-100 mb-2">API密钥 *</label>
                        <div class="relative">
                            <input type="password" id="config-api-key" name="apiKey"
                                   class="w-full p-3 pr-12 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                   placeholder="请输入API密钥">
                            <button type="button" onclick="togglePasswordVisibility('config-api-key')" 
                                    class="absolute right-3 top-3 text-blue-100 hover:text-purple-300">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="text-red-400 text-sm mt-1 hidden" id="apiKey-error"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">基础URL</label>
                        <input type="url" id="config-base-url" name="baseUrl"
                               class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                               placeholder="API基础URL">
                        <div class="text-red-400 text-sm mt-1 hidden" id="baseUrl-error"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-100 mb-2">模型名称 *</label>
                        <input type="text" id="config-model" name="model" required
                               class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                               placeholder="请输入模型名称">
                        <div class="text-red-400 text-sm mt-1 hidden" id="model-error"></div>
                    </div>
                </div>
                
                <!-- 高级参数 -->
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">高级参数</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-100 mb-2">温度参数</label>
                            <input type="number" id="config-temperature" name="temperature" min="0" max="2" step="0.1"
                                   class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                   placeholder="0.7">
                            <div class="text-xs text-blue-300 opacity-75 mt-1">控制输出的随机性 (0-2)</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-blue-100 mb-2">最大令牌数</label>
                            <input type="number" id="config-max-tokens" name="maxTokens" min="1" max="32768"
                                   class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                   placeholder="2048">
                            <div class="text-xs text-blue-300 opacity-75 mt-1">单次请求最大令牌数</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-blue-100 mb-2">超时时间(毫秒)</label>
                            <input type="number" id="config-timeout" name="timeout" min="1000" max="300000"
                                   class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                   placeholder="30000">
                            <div class="text-xs text-blue-300 opacity-75 mt-1">请求超时时间</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-blue-100 mb-2">重试次数</label>
                            <input type="number" id="config-max-retries" name="maxRetries" min="0" max="10"
                                   class="w-full p-3 rounded-lg glass-morphism text-blue-100 placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                   placeholder="3">
                            <div class="text-xs text-blue-300 opacity-75 mt-1">失败时重试次数</div>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex justify-between items-center pt-6 border-t border-purple-300 border-opacity-30">
                    <div class="flex space-x-3">
                        <button type="button" onclick="testLLMConnection()" id="test-connection-btn"
                                class="px-4 py-2 glass-morphism rounded-lg text-blue-100 hover:bg-white hover:bg-opacity-10 transition-all flex items-center">
                            <i class="fas fa-plug mr-2"></i>
                            测试连接
                        </button>
                        <div id="test-result" class="flex items-center text-sm hidden">
                            <i class="fas fa-spinner fa-spin mr-2 text-yellow-400"></i>
                            <span>测试中...</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeLLMConfigModal()"
                                class="px-6 py-3 glass-morphism rounded-lg text-blue-100 hover:bg-white hover:bg-opacity-10 transition-all">
                            取消
                        </button>
                        <button type="submit" id="save-config-btn"
                                class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                            <i class="fas fa-save mr-2"></i>
                            保存配置
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 配置详情模态框 -->
    <div id="llm-config-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-morphism rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-blue-100 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-purple-300"></i>
                    配置详情
                </h3>
                <button onclick="closeLLMConfigDetailModal()" class="text-blue-100 hover:text-purple-300 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="config-detail-content">
                <!-- 详情内容将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 智能体详情模态框 -->
    <div id="agent-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="glass-morphism rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <!-- 模态框头部 -->
                <div class="flex justify-between items-center p-6 border-b border-white border-opacity-20">
                    <div class="flex items-center">
                        <div id="modal-agent-icon" class="w-12 h-12 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-4">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3 id="modal-agent-name" class="text-xl font-semibold text-blue-100">智能体详情</h3>
                            <div id="modal-agent-status" class="status-indicator status-idle mt-1">
                                空闲
                            </div>
                        </div>
                    </div>
                    <button onclick="closeAgentDetailModal()" class="text-blue-100 hover:text-white p-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- 标签页导航 -->
                <div class="flex border-b border-white border-opacity-20">
                    <button class="detail-tab-btn active px-6 py-3 text-blue-100 hover:bg-white hover:bg-opacity-10 transition border-b-2 border-transparent" 
                            data-tab="overview" onclick="switchDetailTab('overview')">
                        <i class="fas fa-info-circle mr-2"></i>
                        概览
                    </button>
                    <button class="detail-tab-btn px-6 py-3 text-blue-100 hover:bg-white hover:bg-opacity-10 transition border-b-2 border-transparent" 
                            data-tab="config" onclick="switchDetailTab('config')">
                        <i class="fas fa-cog mr-2"></i>
                        配置
                    </button>
                    <button class="detail-tab-btn px-6 py-3 text-blue-100 hover:bg-white hover:bg-opacity-10 transition border-b-2 border-transparent" 
                            data-tab="history" onclick="switchDetailTab('history')">
                        <i class="fas fa-history mr-2"></i>
                        历史记录
                    </button>
                    <button class="detail-tab-btn px-6 py-3 text-blue-100 hover:bg-white hover:bg-opacity-10 transition border-b-2 border-transparent" 
                            data-tab="logs" onclick="switchDetailTab('logs')">
                        <i class="fas fa-file-alt mr-2"></i>
                        日志
                    </button>
                </div>
                
                <!-- 模态框内容 -->
                <div class="p-6 max-h-[60vh] overflow-y-auto">
                    <!-- 概览标签页 -->
                    <div id="detail-tab-overview" class="detail-tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- 基本信息 -->
                            <div class="glass-morphism p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-blue-100 mb-4 flex items-center">
                                    <i class="fas fa-info mr-2 text-purple-300"></i>
                                    基本信息
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">智能体ID</span>
                                        <span id="overview-agent-id" class="text-sm font-mono">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">类型</span>
                                        <span id="overview-agent-type" class="text-sm">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">创建时间</span>
                                        <span id="overview-created-at" class="text-sm">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">最后更新</span>
                                        <span id="overview-updated-at" class="text-sm">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 当前状态 -->
                            <div class="glass-morphism p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-blue-100 mb-4 flex items-center">
                                    <i class="fas fa-heartbeat mr-2 text-purple-300"></i>
                                    当前状态
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm opacity-75">运行状态</span>
                                        <div id="overview-status" class="status-indicator status-idle">空闲</div>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">当前任务</span>
                                        <span id="overview-current-task" class="text-sm">无</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm opacity-75">健康状态</span>
                                        <div id="overview-health" class="flex items-center">
                                            <div class="health-indicator health-healthy mr-2"></div>
                                            <span class="text-sm">健康</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">最后检查</span>
                                        <span id="overview-last-check" class="text-sm">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 能力和描述 -->
                        <div class="mt-6 glass-morphism p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-blue-100 mb-4 flex items-center">
                                <i class="fas fa-star mr-2 text-purple-300"></i>
                                能力描述
                            </h4>
                            <p id="overview-description" class="text-sm opacity-80 mb-4">-</p>
                            <div id="overview-capabilities" class="flex flex-wrap gap-2">
                                <!-- 能力标签将动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 执行统计 -->
                        <div class="mt-6 glass-morphism p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-blue-100 mb-4 flex items-center">
                                <i class="fas fa-chart-bar mr-2 text-purple-300"></i>
                                执行统计
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div id="overview-total-executions" class="text-2xl font-bold text-blue-100">0</div>
                                    <div class="text-xs opacity-75">总执行次数</div>
                                </div>
                                <div class="text-center">
                                    <div id="overview-successful-executions" class="text-2xl font-bold text-green-400">0</div>
                                    <div class="text-xs opacity-75">成功次数</div>
                                </div>
                                <div class="text-center">
                                    <div id="overview-success-rate" class="text-2xl font-bold text-purple-400">0%</div>
                                    <div class="text-xs opacity-75">成功率</div>
                                </div>
                                <div class="text-center">
                                    <div id="overview-avg-time" class="text-2xl font-bold text-yellow-400">0s</div>
                                    <div class="text-xs opacity-75">平均耗时</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 配置标签页 -->
                    <div id="detail-tab-config" class="detail-tab-content hidden">
                        <div class="space-y-6">
                            <!-- 大模型配置 -->
                            <div class="glass-morphism p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-blue-100 mb-4 flex items-center">
                                    <i class="fas fa-brain mr-2 text-purple-300"></i>
                                    大模型配置
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">配置名称</span>
                                        <span id="config-llm-name" class="text-sm">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">模型提供商</span>
                                        <span id="config-llm-provider" class="text-sm">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm opacity-75">模型名称</span>
                                        <span id="config-llm-model" class="text-sm">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 参数配置 -->
                            <div class="glass-morphism p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-blue-100 mb-4 flex items-center">
                                    <i class="fas fa-sliders-h mr-2 text-purple-300"></i>
                                    参数配置
                                </h4>
                                <div id="config-parameters" class="space-y-3">
                                    <!-- 参数将动态生成 -->
                                </div>
                                <button onclick="editAgentConfigModal()" class="mt-4 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
                                    <i class="fas fa-edit mr-2"></i>
                                    编辑配置
                                </button>
                            </div>
                            
                            <!-- 约束条件 -->
                            <div class="glass-morphism p-4 rounded-lg">
                                <h4 class="text-lg font-semibold text-blue-100 mb-4 flex items-center">
                                    <i class="fas fa-shield-alt mr-2 text-purple-300"></i>
                                    约束条件
                                </h4>
                                <div id="config-constraints" class="space-y-2">
                                    <!-- 约束条件将动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 历史记录标签页 -->
                    <div id="detail-tab-history" class="detail-tab-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold text-blue-100 flex items-center">
                                <i class="fas fa-history mr-2 text-purple-300"></i>
                                执行历史
                            </h4>
                            <div class="flex space-x-2">
                                <select id="history-filter" class="px-3 py-1 bg-black bg-opacity-30 text-blue-100 rounded border border-white border-opacity-20">
                                    <option value="">全部状态</option>
                                    <option value="success">成功</option>
                                    <option value="failed">失败</option>
                                    <option value="running">运行中</option>
                                </select>
                                <button onclick="loadAgentHistory()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-white">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="history-list" class="space-y-3">
                            <!-- 历史记录将动态生成 -->
                            <div class="text-center py-8 opacity-75">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>加载历史记录中...</p>
                            </div>
                        </div>
                        
                        <!-- 分页 -->
                        <div id="history-pagination" class="flex justify-center mt-6">
                            <!-- 分页按钮将动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 日志标签页 -->
                    <div id="detail-tab-logs" class="detail-tab-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold text-blue-100 flex items-center">
                                <i class="fas fa-file-alt mr-2 text-purple-300"></i>
                                运行日志
                            </h4>
                            <div class="flex space-x-2">
                                <select id="log-level-filter" class="px-3 py-1 bg-black bg-opacity-30 text-blue-100 rounded border border-white border-opacity-20">
                                    <option value="all">全部级别</option>
                                    <option value="error">错误</option>
                                    <option value="warning">警告</option>
                                    <option value="info">信息</option>
                                    <option value="debug">调试</option>
                                </select>
                                <button onclick="loadAgentLogs()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-white">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="toggleAutoRefreshLogs()" id="auto-refresh-btn" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-white">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="logs-container" class="bg-black bg-opacity-50 rounded-lg p-4 font-mono text-sm max-h-96 overflow-y-auto">
                            <!-- 日志内容将动态生成 -->
                            <div class="text-center py-8 opacity-75">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>加载日志中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 大模型配置相关JavaScript函数
        let currentEditingConfigId = null;
        let formValidator = null;

        // 打开配置模态框
        function openLLMConfigModal(configId = null) {
            currentEditingConfigId = configId;
            const modal = document.getElementById('llm-config-modal');
            const title = document.getElementById('llm-modal-title');
            const form = document.getElementById('llm-config-form');
            
            if (configId) {
                title.textContent = '编辑大模型配置';
                loadConfigForEdit(configId);
            } else {
                title.textContent = '添加大模型配置';
                form.reset();
                clearFormErrors();
            }
            
            modal.classList.remove('hidden');
        }

        // 关闭配置模态框
        function closeLLMConfigModal() {
            const modal = document.getElementById('llm-config-modal');
            modal.classList.add('hidden');
            currentEditingConfigId = null;
            document.getElementById('llm-config-form').reset();
            clearFormErrors();
        }

        // 设置表单验证
        function setupFormValidation() {
            if (!formValidator) return;
            
            const form = document.getElementById('llm-config-form');
            const fields = form.querySelectorAll('input, select');
            
            fields.forEach(field => {
                const fieldName = field.name;
                if (fieldName && LLMConfigValidationRules[fieldName]) {
                    formValidator.setupRealTimeValidation(field, LLMConfigValidationRules[fieldName]);
                }
            });
        }

        // 更新提供商字段
        function updateProviderFields() {
            const provider = document.getElementById('config-provider').value;
            const apiKeyField = document.getElementById('api-key-field');
            const baseUrlField = document.getElementById('config-base-url');
            
            if (!window.llmConfigManager) return;
            
            const providers = window.llmConfigManager.getSupportedProviders();
            const providerInfo = providers.find(p => p.key === provider);
            
            if (providerInfo) {
                // 设置默认值
                Object.keys(providerInfo.defaultValues).forEach(key => {
                    const field = document.getElementById(`config-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
                    if (field && !field.value) {
                        field.value = providerInfo.defaultValues[key];
                    }
                });
                
                // 控制API密钥字段显示
                if (providerInfo.requiredFields.includes('apiKey')) {
                    apiKeyField.style.display = 'block';
                    document.getElementById('config-api-key').required = true;
                } else {
                    apiKeyField.style.display = 'none';
                    document.getElementById('config-api-key').required = false;
                }
                
                // 更新验证规则
                if (formValidator && typeof getDynamicValidationRules === 'function') {
                    const dynamicRules = getDynamicValidationRules(provider);
                    
                    // 重新设置字段验证
                    Object.keys(dynamicRules).forEach(fieldName => {
                        const field = document.getElementById(`config-${fieldName.replace(/([A-Z])/g, '-$1').toLowerCase()}`) ||
                                     document.querySelector(`[name="${fieldName}"]`);
                        if (field) {
                            formValidator.setupRealTimeValidation(field, dynamicRules[fieldName]);
                        }
                    });
                }
            }
        }

        // 切换密码可见性
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.nextElementSibling.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // 测试连接
        async function testLLMConnection() {
            const form = document.getElementById('llm-config-form');
            const formData = new FormData(form);
            const testBtn = document.getElementById('test-connection-btn');
            const testResult = document.getElementById('test-result');
            
            // 构建配置对象
            const config = {
                name: formData.get('name'),
                provider: formData.get('provider'),
                settings: {
                    apiKey: formData.get('apiKey'),
                    baseUrl: formData.get('baseUrl'),
                    model: formData.get('model'),
                    temperature: parseFloat(formData.get('temperature')) || 0.7,
                    maxTokens: parseInt(formData.get('maxTokens')) || 2048,
                    timeout: parseInt(formData.get('timeout')) || 30000,
                    maxRetries: parseInt(formData.get('maxRetries')) || 3
                }
            };
            
            // 验证必需字段
            if (!config.name || !config.provider || !config.settings.model) {
                showNotification('请填写必需字段后再测试连接', 'error');
                return;
            }
            
            // 显示测试状态
            testBtn.disabled = true;
            testResult.classList.remove('hidden');
            testResult.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 text-yellow-400"></i><span>测试中...</span>';
            
            try {
                // 创建临时配置进行测试
                const tempConfigResult = await window.llmConfigManager.createConfig(config);
                if (!tempConfigResult.success) {
                    throw new Error(tempConfigResult.errors.join(', '));
                }
                
                const tempConfigId = tempConfigResult.data.configId;
                const testResult = await window.llmConfigManager.testConnection(tempConfigId);
                
                // 删除临时配置
                await window.llmConfigManager.deleteConfig(tempConfigId);
                
                if (testResult.success) {
                    document.getElementById('test-result').innerHTML = 
                        `<i class="fas fa-check-circle mr-2 text-green-400"></i><span>连接成功 (${testResult.data.responseTime}ms)</span>`;
                    showNotification('连接测试成功！', 'success');
                } else {
                    document.getElementById('test-result').innerHTML = 
                        '<i class="fas fa-times-circle mr-2 text-red-400"></i><span>连接失败</span>';
                    showNotification(`连接测试失败: ${testResult.errors.join(', ')}`, 'error');
                }
            } catch (error) {
                document.getElementById('test-result').innerHTML = 
                    '<i class="fas fa-times-circle mr-2 text-red-400"></i><span>测试失败</span>';
                showNotification(`连接测试失败: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                setTimeout(() => {
                    testResult.classList.add('hidden');
                }, 5000);
            }
        }

        // 保存配置
        document.getElementById('llm-config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const saveBtn = document.getElementById('save-config-btn');
            const provider = formData.get('provider');
            
            // 使用表单验证器验证
            if (formValidator && typeof getDynamicValidationRules === 'function') {
                const validationRules = getDynamicValidationRules(provider);
                const validationResult = formValidator.validateForm(form, validationRules);
                
                if (!validationResult.isValid) {
                    formValidator.displayErrors(validationResult);
                    showNotification('请修正表单中的错误', 'error');
                    return;
                }
            }
            
            // 构建配置对象
            const config = {
                name: formData.get('name'),
                provider: formData.get('provider'),
                settings: {
                    apiKey: formData.get('apiKey'),
                    baseUrl: formData.get('baseUrl'),
                    model: formData.get('model'),
                    temperature: parseFloat(formData.get('temperature')) || undefined,
                    maxTokens: parseInt(formData.get('maxTokens')) || undefined,
                    timeout: parseInt(formData.get('timeout')) || undefined,
                    maxRetries: parseInt(formData.get('maxRetries')) || undefined
                }
            };
            
            // 清除空值
            Object.keys(config.settings).forEach(key => {
                if (config.settings[key] === undefined || config.settings[key] === '') {
                    delete config.settings[key];
                }
            });
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>保存中...';
            
            try {
                let result;
                if (currentEditingConfigId) {
                    result = await window.llmConfigManager.updateConfig(currentEditingConfigId, config);
                } else {
                    result = await window.llmConfigManager.createConfig(config);
                }
                
                if (result.success) {
                    showNotification(currentEditingConfigId ? '配置更新成功！' : '配置创建成功！', 'success');
                    closeLLMConfigModal();
                    loadLLMConfigs();
                } else {
                    displayFormErrors(result.errors);
                    showNotification('保存失败，请检查输入信息', 'error');
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                showNotification('保存配置时发生错误', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>保存配置';
            }
        });

        // 显示表单错误
        function displayFormErrors(errors) {
            if (formValidator) {
                // 使用验证器显示错误
                errors.forEach(error => {
                    // 简单的错误映射
                    if (error.includes('配置名称')) {
                        formValidator.showFieldError('name', error);
                    } else if (error.includes('提供商')) {
                        formValidator.showFieldError('provider', error);
                    } else if (error.includes('apiKey') || error.includes('API密钥')) {
                        formValidator.showFieldError('apiKey', error);
                    } else if (error.includes('baseUrl') || error.includes('URL')) {
                        formValidator.showFieldError('baseUrl', error);
                    } else if (error.includes('model') || error.includes('模型')) {
                        formValidator.showFieldError('model', error);
                    } else {
                        showNotification(error, 'error');
                    }
                });
            } else {
                // 回退到原始方法
                clearFormErrors();
                errors.forEach(error => {
                    showNotification(error, 'error');
                });
            }
        }

        // 显示字段错误（兼容性函数）
        function showFieldError(fieldName, message) {
            if (formValidator) {
                formValidator.showFieldError(fieldName, message);
            } else {
                const errorElement = document.getElementById(`${fieldName}-error`);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                }
            }
        }

        // 清除表单错误
        function clearFormErrors() {
            if (formValidator) {
                formValidator.clearErrors();
            } else {
                const errorElements = document.querySelectorAll('[id$="-error"]');
                errorElements.forEach(element => {
                    element.textContent = '';
                    element.classList.add('hidden');
                });
            }
        }

        // 加载配置进行编辑
        function loadConfigForEdit(configId) {
            if (!window.llmConfigManager) return;
            
            const config = window.llmConfigManager.getFullConfig(configId);
            if (!config) return;
            
            // 填充表单
            document.getElementById('config-name').value = config.name;
            document.getElementById('config-provider').value = config.provider;
            document.getElementById('config-api-key').value = config.settings.apiKey || '';
            document.getElementById('config-base-url').value = config.settings.baseUrl || '';
            document.getElementById('config-model').value = config.settings.model || '';
            document.getElementById('config-temperature').value = config.settings.temperature || '';
            document.getElementById('config-max-tokens').value = config.settings.maxTokens || '';
            document.getElementById('config-timeout').value = config.settings.timeout || '';
            document.getElementById('config-max-retries').value = config.settings.maxRetries || '';
            
            // 更新提供商字段
            updateProviderFields();
        }

        // 加载大模型配置列表
        function loadLLMConfigs() {
            if (!window.llmConfigManager) return;
            
            const configs = window.llmConfigManager.getAllConfigs();
            const configList = document.getElementById('llm-config-list');
            
            // 清空现有内容，但保留添加按钮
            const addButton = configList.querySelector('.border-dashed');
            configList.innerHTML = '';
            if (addButton) {
                configList.appendChild(addButton);
            }
            
            // 按健康度排序配置
            const sortedConfigs = configs.sort((a, b) => {
                const scoreA = calculateConfigHealthScore(a);
                const scoreB = calculateConfigHealthScore(b);
                
                // 活跃配置优先
                if (a.isActive && !b.isActive) return -1;
                if (!a.isActive && b.isActive) return 1;
                
                // 然后按健康度排序
                return scoreB - scoreA;
            });
            
            sortedConfigs.forEach(config => {
                const configCard = createLLMConfigCard(config);
                configList.appendChild(configCard);
            });
            
            // 更新统计摘要
            updateConfigSummary();
        }

        // 创建配置卡片
        function createLLMConfigCard(config) {
            const card = document.createElement('div');
            card.className = 'glass-morphism rounded-lg p-4 text-blue-100 hover-scale cursor-pointer relative';
            card.onclick = () => showLLMConfigDetail(config.id);
            
            const statusColor = config.testResult?.isValid === true ? 'text-green-400' : 
                               config.testResult?.isValid === false ? 'text-red-400' : 'text-gray-400';
            const statusIcon = config.testResult?.isValid === true ? 'check-circle' : 
                              config.testResult?.isValid === false ? 'times-circle' : 'question-circle';
            const statusText = config.testResult?.isValid === true ? '连接正常' : 
                              config.testResult?.isValid === false ? '连接异常' : '未测试';
            
            // 计算健康度评分
            const healthScore = calculateConfigHealthScore(config);
            const healthColor = healthScore >= 80 ? 'text-green-400' : 
                               healthScore >= 60 ? 'text-yellow-400' : 'text-red-400';
            
            card.innerHTML = `
                <!-- 健康度指示器 -->
                <div class="absolute top-2 right-2">
                    <div class="w-3 h-3 rounded-full ${config.testResult?.isValid === true ? 'bg-green-400' : 
                                                        config.testResult?.isValid === false ? 'bg-red-400' : 'bg-gray-400'} 
                         ${config.testResult?.isValid === true ? 'animate-pulse' : ''}"></div>
                </div>
                
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-3 relative">
                            <i class="fas fa-brain"></i>
                            ${config.isActive ? '<div class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full flex items-center justify-center"><i class="fas fa-check text-xs text-white"></i></div>' : ''}
                        </div>
                        <div>
                            <h4 class="font-semibold">${config.name}</h4>
                            <p class="text-xs opacity-75">${getProviderDisplayName(config.provider)}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${config.isActive ? '<span class="px-2 py-1 bg-green-500 bg-opacity-30 text-xs rounded-full">活跃</span>' : ''}
                        <div class="flex items-center" title="${statusText}">
                            <i class="fas fa-${statusIcon} ${statusColor}"></i>
                        </div>
                    </div>
                </div>
                
                <!-- 状态信息 -->
                <div class="text-sm opacity-80 mb-3 space-y-1">
                    <div class="flex justify-between">
                        <span>模型:</span>
                        <span class="truncate ml-2">${config.settings.model || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>状态:</span>
                        <span class="${statusColor}">${statusText}</span>
                    </div>
                    ${config.testResult?.responseTime ? `
                    <div class="flex justify-between">
                        <span>响应时间:</span>
                        <span class="${config.testResult.responseTime < 1000 ? 'text-green-400' : 
                                      config.testResult.responseTime < 3000 ? 'text-yellow-400' : 'text-red-400'}">${config.testResult.responseTime}ms</span>
                    </div>
                    ` : ''}
                    ${config.testResult?.lastTested ? `
                    <div class="flex justify-between">
                        <span>最后测试:</span>
                        <span class="text-xs">${formatRelativeTime(config.testResult.lastTested)}</span>
                    </div>
                    ` : ''}
                </div>
                
                <!-- 使用统计 -->
                ${config.usage && (config.usage.totalRequests > 0) ? `
                <div class="text-xs opacity-60 mb-3 p-2 bg-white bg-opacity-5 rounded">
                    <div class="flex justify-between">
                        <span>请求数:</span>
                        <span>${config.usage.totalRequests}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>成功率:</span>
                        <span class="${config.usage.totalRequests > 0 ? 
                                      (config.usage.successfulRequests / config.usage.totalRequests * 100) >= 90 ? 'text-green-400' : 
                                      (config.usage.successfulRequests / config.usage.totalRequests * 100) >= 70 ? 'text-yellow-400' : 'text-red-400' : 'text-gray-400'}">
                            ${config.usage.totalRequests > 0 ? Math.round(config.usage.successfulRequests / config.usage.totalRequests * 100) : 0}%
                        </span>
                    </div>
                </div>
                ` : ''}
                
                <!-- 健康度评分 -->
                <div class="mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs opacity-75">健康度</span>
                        <span class="text-xs ${healthColor}">${healthScore}%</span>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-1">
                        <div class="h-1 rounded-full transition-all duration-300 ${healthScore >= 80 ? 'bg-green-400' : 
                                                                                    healthScore >= 60 ? 'bg-yellow-400' : 'bg-red-400'}" 
                             style="width: ${healthScore}%"></div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button onclick="event.stopPropagation(); editLLMConfig('${config.id}')" 
                                class="text-blue-300 hover:text-blue-200 text-sm transition-colors">
                            <i class="fas fa-edit mr-1"></i>编辑
                        </button>
                        <button onclick="event.stopPropagation(); testLLMConfigConnection('${config.id}')" 
                                class="text-green-300 hover:text-green-200 text-sm transition-colors" 
                                id="test-btn-${config.id}">
                            <i class="fas fa-plug mr-1"></i>测试
                        </button>
                        ${!config.isActive ? `
                        <button onclick="event.stopPropagation(); activateLLMConfig('${config.id}')" 
                                class="text-purple-300 hover:text-purple-200 text-sm transition-colors">
                            <i class="fas fa-power-off mr-1"></i>激活
                        </button>
                        ` : ''}
                    </div>
                    <button onclick="event.stopPropagation(); deleteLLMConfig('${config.id}')" 
                            class="text-red-300 hover:text-red-200 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            return card;
        }

        // 获取提供商显示名称
        function getProviderDisplayName(provider) {
            const providerNames = {
                'siliconflow': 'SiliconFlow',
                'openai': 'OpenAI',
                'anthropic': 'Anthropic',
                'local': '本地部署'
            };
            return providerNames[provider] || provider;
        }

        // 计算配置健康度评分
        function calculateConfigHealthScore(config) {
            let score = 0;
            
            // 基础配置完整性 (30分)
            if (config.name && config.provider && config.settings.model) {
                score += 30;
            }
            
            // 连接测试状态 (40分)
            if (config.testResult?.isValid === true) {
                score += 40;
                
                // 响应时间加分
                if (config.testResult.responseTime < 1000) {
                    score += 10; // 快速响应额外加分
                } else if (config.testResult.responseTime < 3000) {
                    score += 5; // 中等响应加分
                }
            } else if (config.testResult?.isValid === false) {
                score += 0; // 连接失败不加分
            } else {
                score += 10; // 未测试给予基础分
            }
            
            // 使用统计 (20分)
            if (config.usage && config.usage.totalRequests > 0) {
                const successRate = config.usage.successfulRequests / config.usage.totalRequests;
                score += Math.round(successRate * 20);
            } else {
                score += 10; // 新配置给予基础分
            }
            
            // 最近活跃度 (10分)
            if (config.testResult?.lastTested) {
                const lastTested = new Date(config.testResult.lastTested);
                const now = new Date();
                const daysSinceTest = (now - lastTested) / (1000 * 60 * 60 * 24);
                
                if (daysSinceTest < 1) {
                    score += 10; // 最近测试过
                } else if (daysSinceTest < 7) {
                    score += 5; // 一周内测试过
                } else {
                    score += 0; // 很久没测试
                }
            }
            
            return Math.min(100, Math.max(0, score));
        }

        // 格式化相对时间
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) {
                return '刚刚';
            } else if (diffMins < 60) {
                return `${diffMins}分钟前`;
            } else if (diffHours < 24) {
                return `${diffHours}小时前`;
            } else if (diffDays < 7) {
                return `${diffDays}天前`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // 编辑配置
        function editLLMConfig(configId) {
            openLLMConfigModal(configId);
        }

        // 测试配置连接
        async function testLLMConfigConnection(configId) {
            if (!window.llmConfigManager) return;
            
            const testBtn = document.getElementById(`test-btn-${configId}`);
            const originalContent = testBtn ? testBtn.innerHTML : '';
            
            try {
                // 更新按钮状态
                if (testBtn) {
                    testBtn.disabled = true;
                    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>测试中';
                    testBtn.className = testBtn.className.replace('text-green-300', 'text-yellow-300');
                }
                
                showNotification('正在测试连接...', 'info');
                const startTime = Date.now();
                const result = await window.llmConfigManager.testConnection(configId);
                const testDuration = Date.now() - startTime;
                
                if (result.success) {
                    showNotification(`连接测试成功！响应时间: ${result.data.responseTime}ms`, 'success');
                    
                    // 更新按钮为成功状态
                    if (testBtn) {
                        testBtn.innerHTML = '<i class="fas fa-check mr-1"></i>成功';
                        testBtn.className = testBtn.className.replace('text-yellow-300', 'text-green-300');
                        
                        // 3秒后恢复原状
                        setTimeout(() => {
                            testBtn.innerHTML = originalContent;
                            testBtn.disabled = false;
                        }, 3000);
                    }
                } else {
                    showNotification(`连接测试失败: ${result.errors.join(', ')}`, 'error');
                    
                    // 更新按钮为失败状态
                    if (testBtn) {
                        testBtn.innerHTML = '<i class="fas fa-times mr-1"></i>失败';
                        testBtn.className = testBtn.className.replace('text-yellow-300', 'text-red-300');
                        
                        // 3秒后恢复原状
                        setTimeout(() => {
                            testBtn.innerHTML = originalContent;
                            testBtn.className = testBtn.className.replace('text-red-300', 'text-green-300');
                            testBtn.disabled = false;
                        }, 3000);
                    }
                }
                
                // 刷新配置列表以更新状态
                setTimeout(() => {
                    loadLLMConfigs();
                }, 1000);
                
            } catch (error) {
                console.error('测试连接失败:', error);
                showNotification('测试连接时发生错误', 'error');
                
                // 恢复按钮状态
                if (testBtn) {
                    testBtn.innerHTML = originalContent;
                    testBtn.disabled = false;
                    testBtn.className = testBtn.className.replace('text-yellow-300', 'text-green-300');
                }
            }
        }

        // 激活配置
        async function activateLLMConfig(configId) {
            if (!window.llmConfigManager) return;
            
            try {
                const result = await window.llmConfigManager.setActiveConfig(configId);
                
                if (result.success) {
                    showNotification('配置已激活！', 'success');
                    loadLLMConfigs();
                } else {
                    showNotification(`激活配置失败: ${result.errors.join(', ')}`, 'error');
                }
            } catch (error) {
                console.error('激活配置失败:', error);
                showNotification('激活配置时发生错误', 'error');
            }
        }

        // 删除配置
        async function deleteLLMConfig(configId) {
            if (!window.llmConfigManager) return;
            
            if (!confirm('确定要删除这个配置吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                const result = await window.llmConfigManager.deleteConfig(configId);
                
                if (result.success) {
                    showNotification('配置已删除！', 'success');
                    loadLLMConfigs();
                } else {
                    showNotification(`删除配置失败: ${result.errors.join(', ')}`, 'error');
                }
            } catch (error) {
                console.error('删除配置失败:', error);
                showNotification('删除配置时发生错误', 'error');
            }
        }

        // 显示配置详情
        function showLLMConfigDetail(configId) {
            if (!window.llmConfigManager) return;
            
            const config = window.llmConfigManager.getConfig(configId);
            if (!config) return;
            
            const modal = document.getElementById('llm-config-detail-modal');
            const content = document.getElementById('config-detail-content');
            
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">基本信息</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-blue-300">配置名称:</span>
                                <span>${config.name}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">提供商:</span>
                                <span>${getProviderDisplayName(config.provider)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">模型:</span>
                                <span>${config.settings.model || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">状态:</span>
                                <span class="${config.isActive ? 'text-green-400' : 'text-gray-400'}">
                                    ${config.isActive ? '活跃' : '非活跃'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">连接信息</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-blue-300">API密钥:</span>
                                <span>${config.settings.apiKey || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">基础URL:</span>
                                <span class="text-xs">${config.settings.baseUrl || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">温度参数:</span>
                                <span>${config.settings.temperature || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">最大令牌数:</span>
                                <span>${config.settings.maxTokens || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">测试结果</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-blue-300">连接状态:</span>
                                <span class="${config.testResult?.isValid === true ? 'text-green-400' : 
                                             config.testResult?.isValid === false ? 'text-red-400' : 'text-gray-400'}">
                                    ${config.testResult?.isValid === true ? '正常' : 
                                      config.testResult?.isValid === false ? '异常' : '未测试'}
                                </span>
                            </div>
                            ${config.testResult?.responseTime ? `
                            <div class="flex justify-between">
                                <span class="text-blue-300">响应时间:</span>
                                <span>${config.testResult.responseTime}ms</span>
                            </div>
                            ` : ''}
                            ${config.testResult?.lastTested ? `
                            <div class="flex justify-between">
                                <span class="text-blue-300">最后测试:</span>
                                <span class="text-xs">${new Date(config.testResult.lastTested).toLocaleString()}</span>
                            </div>
                            ` : ''}
                            ${config.testResult?.errorMessage ? `
                            <div class="flex justify-between">
                                <span class="text-blue-300">错误信息:</span>
                                <span class="text-red-400 text-xs">${config.testResult.errorMessage}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-blue-100 border-b border-purple-300 border-opacity-30 pb-2">使用统计</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-blue-300">总请求数:</span>
                                <span>${config.usage?.totalRequests || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">成功请求数:</span>
                                <span>${config.usage?.successfulRequests || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">总令牌数:</span>
                                <span>${config.usage?.totalTokens || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-300">创建时间:</span>
                                <span class="text-xs">${new Date(config.createdAt).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-3 mt-6 pt-6 border-t border-purple-300 border-opacity-30">
                    <button onclick="editLLMConfig('${config.id}'); closeLLMConfigDetailModal();" 
                            class="btn-blue px-6 py-3 text-white rounded-lg flex items-center">
                        <i class="fas fa-edit mr-2"></i>
                        编辑配置
                    </button>
                    <button onclick="testLLMConfigConnection('${config.id}'); closeLLMConfigDetailModal();" 
                            class="px-6 py-3 glass-morphism rounded-lg text-blue-100 hover:bg-white hover:bg-opacity-10 transition-all flex items-center">
                        <i class="fas fa-plug mr-2"></i>
                        测试连接
                    </button>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // 关闭配置详情模态框
        function closeLLMConfigDetailModal() {
            const modal = document.getElementById('llm-config-detail-modal');
            modal.classList.add('hidden');
        }

        // 配置状态监控
        let configMonitorInterval = null;
        
        function startConfigMonitoring() {
            // 每5分钟检查一次配置状态
            configMonitorInterval = setInterval(async () => {
                if (!window.llmConfigManager) return;
                
                const configs = window.llmConfigManager.getAllConfigs();
                const activeConfig = window.llmConfigManager.getActiveConfig();
                
                // 检查活跃配置的健康状态
                if (activeConfig && activeConfig.testResult?.lastTested) {
                    const lastTested = new Date(activeConfig.testResult.lastTested);
                    const now = new Date();
                    const hoursSinceTest = (now - lastTested) / (1000 * 60 * 60);
                    
                    // 如果超过24小时没有测试，自动测试一次
                    if (hoursSinceTest > 24) {
                        console.log('自动测试活跃配置连接状态');
                        await testLLMConfigConnection(activeConfig.id);
                    }
                }
                
                // 更新配置列表显示
                loadLLMConfigs();
            }, 5 * 60 * 1000); // 5分钟
        }
        
        function stopConfigMonitoring() {
            if (configMonitorInterval) {
                clearInterval(configMonitorInterval);
                configMonitorInterval = null;
            }
        }

        // 添加配置统计摘要
        function updateConfigSummary() {
            if (!window.llmConfigManager) return;
            
            const configs = window.llmConfigManager.getAllConfigs();
            const summary = {
                total: configs.length,
                active: configs.filter(c => c.isActive).length,
                healthy: configs.filter(c => c.testResult?.isValid === true).length,
                unhealthy: configs.filter(c => c.testResult?.isValid === false).length,
                untested: configs.filter(c => c.testResult?.isValid === null || c.testResult?.isValid === undefined).length
            };
            
            // 更新页面上的统计信息（如果有的话）
            const summaryElement = document.getElementById('llm-config-summary');
            if (summaryElement) {
                summaryElement.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-blue-100">${summary.total}</div>
                            <div class="text-xs opacity-75">总配置</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-400">${summary.active}</div>
                            <div class="text-xs opacity-75">活跃</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-400">${summary.healthy}</div>
                            <div class="text-xs opacity-75">健康</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-400">${summary.unhealthy}</div>
                            <div class="text-xs opacity-75">异常</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-400">${summary.untested}</div>
                            <div class="text-xs opacity-75">未测试</div>
                        </div>
                    </div>
                `;
            }
        }

        // 加载智能体信息
        async function loadAgents() {
            if (!window.agentManager) {
                console.warn('智能体管理器未初始化');
                return;
            }
            
            try {
                // 显示加载状态
                showAgentLoadingState();
                
                // 加载智能体数据
                const result = await window.agentManager.loadAgents();
                
                if (result.success) {
                    // 渲染智能体列表
                    renderAgentList(window.agentManager.getAllAgents());
                    
                    // 更新统计摘要
                    updateAgentSummary(window.agentManager.getAgentsSummary());
                    
                    // 设置状态更新监听器
                    setupAgentUpdateListeners();
                } else {
                    showAgentError('加载智能体失败: ' + (result.errors || []).join(', '));
                }
            } catch (error) {
                console.error('加载智能体时发生错误:', error);
                showAgentError('加载智能体时发生错误');
            }
        }
        
        // 显示加载状态
        function showAgentLoadingState() {
            const agentList = document.getElementById('agent-list');
            if (!agentList) return;
            
            agentList.innerHTML = `
                <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center border-2 border-dashed border-purple-300 border-opacity-50">
                    <div class="py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-purple-300 mb-3"></i>
                        <p class="text-lg font-medium">加载智能体中...</p>
                        <p class="text-sm opacity-75 mt-1">正在从后端获取智能体信息</p>
                    </div>
                </div>
            `;
        }
        
        // 显示错误状态
        function showAgentError(message) {
            const agentList = document.getElementById('agent-list');
            if (!agentList) return;
            
            agentList.innerHTML = `
                <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center border-2 border-dashed border-red-300 border-opacity-50">
                    <div class="py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-3"></i>
                        <p class="text-lg font-medium">加载失败</p>
                        <p class="text-sm opacity-75 mt-1">${message}</p>
                        <button onclick="loadAgents()" class="mt-4 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white">
                            重试
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 渲染智能体列表
        function renderAgentList(agents) {
            const agentList = document.getElementById('agent-list');
            if (!agentList) return;
            
            if (!agents || agents.length === 0) {
                agentList.innerHTML = `
                    <div class="glass-morphism rounded-lg p-4 text-blue-100 text-center border-2 border-dashed border-purple-300 border-opacity-50">
                        <div class="py-8">
                            <i class="fas fa-robot text-4xl text-purple-300 mb-3"></i>
                            <p class="text-lg font-medium">暂无智能体</p>
                            <p class="text-sm opacity-75 mt-1">点击创建智能体按钮开始</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const agentCards = agents.map(agent => createAgentCard(agent)).join('');
            agentList.innerHTML = agentCards;
        }
        
        // 创建智能体卡片
        function createAgentCard(agent) {
            const typeInfo = agent.typeInfo || {};
            const stats = agent.executionStats || {};
            const health = agent.healthStatus || {};
            
            // 格式化最后执行时间
            const lastExecution = stats.lastExecutionTime ? 
                new Date(stats.lastExecutionTime).toLocaleString('zh-CN') : '从未执行';
            
            // 格式化当前任务
            const currentTask = agent.currentTask || '无';
            
            // 能力标签
            const capabilityTags = (agent.capabilities || [])
                .map(cap => `<span class="capability-tag">${cap}</span>`)
                .join('');
            
            return `
                <div class="agent-card glass-morphism rounded-xl p-6 text-blue-100" 
                     data-agent-id="${agent.agentId}" 
                     onclick="showAgentDetails('${agent.agentId}')">
                    
                    <!-- 健康状态指示器 -->
                    <div class="health-indicator ${health.isHealthy ? 'health-healthy' : 'health-error'}"></div>
                    
                    <!-- 智能体头部信息 -->
                    <div class="flex items-center mb-4">
                        <div class="w-14 h-14 bg-gradient-to-r from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white mr-4 relative">
                            <i class="fas fa-${typeInfo.icon || 'robot'} text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold mb-1">${agent.name}</h4>
                            <div class="status-indicator status-${agent.status}">
                                ${getStatusText(agent.status)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 智能体描述 -->
                    <p class="text-sm opacity-80 mb-4 line-clamp-2">${agent.description}</p>
                    
                    <!-- 能力标签 -->
                    <div class="mb-4">
                        <div class="flex flex-wrap">
                            ${capabilityTags}
                        </div>
                    </div>
                    
                    <!-- 当前任务 -->
                    <div class="mb-4 p-3 bg-black bg-opacity-20 rounded-lg">
                        <div class="text-xs opacity-75 mb-1">当前任务</div>
                        <div class="text-sm font-medium truncate">${currentTask}</div>
                    </div>
                    
                    <!-- 执行统计 -->
                    <div class="mb-4 space-y-2">
                        <div class="stat-item">
                            <span class="stat-label">总执行次数</span>
                            <span class="stat-value">${stats.totalExecutions || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">成功率</span>
                            <span class="stat-value text-green-400">${stats.successRate || 0}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">平均耗时</span>
                            <span class="stat-value">${stats.averageExecutionTime || 0}s</span>
                        </div>
                    </div>
                    
                    <!-- 成功率进度条 -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs opacity-75 mb-1">
                            <span>成功率</span>
                            <span>${stats.successRate || 0}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stats.successRate || 0}%"></div>
                        </div>
                    </div>
                    
                    <!-- 最后执行时间 -->
                    <div class="text-xs opacity-60 mb-4">
                        最后执行: ${lastExecution}
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-2">
                            <span class="px-2 py-1 bg-blue-500 bg-opacity-30 text-xs rounded-full">
                                ${agent.agentType}
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="event.stopPropagation(); editAgentConfig('${agent.agentId}')" 
                                    class="text-purple-300 hover:text-purple-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button onclick="event.stopPropagation(); showAgentDetails('${agent.agentId}')" 
                                    class="text-blue-300 hover:text-blue-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'active': '活跃',
                'idle': '空闲',
                'busy': '忙碌',
                'error': '错误',
                'offline': '离线'
            };
            return statusMap[status] || '未知';
        }
        
        // 更新智能体统计摘要
        function updateAgentSummary(summary) {
            if (!summary) return;
            
            const totalEl = document.getElementById('total-agents');
            const activeEl = document.getElementById('active-agents');
            const busyEl = document.getElementById('busy-agents');
            const successRateEl = document.getElementById('avg-success-rate');
            
            if (totalEl) totalEl.textContent = summary.total || 0;
            if (activeEl) activeEl.textContent = summary.byStatus.active || 0;
            if (busyEl) busyEl.textContent = summary.byStatus.busy || 0;
            if (successRateEl) successRateEl.textContent = (summary.averageSuccessRate || 0) + '%';
        }
        
        // 设置智能体更新监听器
        function setupAgentUpdateListeners() {
            if (!window.agentManager) return;
            
            // 移除之前的监听器
            window.agentManager.statusUpdateHandlers.clear();
            
            // 添加新的监听器
            window.agentManager.onStatusUpdate((eventType, data) => {
                switch (eventType) {
                    case 'status_update':
                        updateAgentStatusWithAnimation(data.agentId, data);
                        showStatusChangeNotification(data.agentId, data);
                        break;
                    case 'config_update':
                        updateAgentConfig(data.agentId, data.configuration);
                        showConfigUpdateNotification(data.agentId);
                        break;
                    case 'stats_update':
                        updateAgentStatsWithAnimation(data.agentId, data.stats);
                        break;
                    case 'agents_loaded':
                        updateAgentSummary(window.agentManager.getAgentsSummary());
                        break;
                }
            });
            
            // 订阅WebSocket更新
            subscribeToRealtimeUpdates();
            
            // 设置定期刷新
            setupAutoRefresh();
        }
        
        // 订阅实时更新
        async function subscribeToRealtimeUpdates() {
            if (!window.agentManager) return;
            
            try {
                const result = await window.agentManager.subscribeToUpdates();
                if (result.success) {
                    console.log('已订阅智能体实时更新');
                    showConnectionStatus(true);
                } else {
                    console.warn('订阅智能体实时更新失败');
                    showConnectionStatus(false);
                }
            } catch (error) {
                console.error('订阅实时更新时发生错误:', error);
                showConnectionStatus(false);
            }
        }
        
        // 设置自动刷新
        function setupAutoRefresh() {
            // 清除之前的定时器
            if (window.agentRefreshInterval) {
                clearInterval(window.agentRefreshInterval);
            }
            
            // 设置新的定时器（每30秒刷新一次）
            window.agentRefreshInterval = setInterval(async () => {
                if (!window.agentManager) return;
                
                try {
                    await window.agentManager.refreshAgentStatus();
                } catch (error) {
                    console.error('自动刷新智能体状态失败:', error);
                }
            }, 30000);
        }
        
        // 显示连接状态
        function showConnectionStatus(isConnected) {
            // 在页面上显示WebSocket连接状态
            let statusEl = document.getElementById('websocket-status');
            if (!statusEl) {
                // 创建状态指示器
                statusEl = document.createElement('div');
                statusEl.id = 'websocket-status';
                statusEl.className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium transition-all';
                document.body.appendChild(statusEl);
            }
            
            if (isConnected) {
                statusEl.className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-green-600 text-white';
                statusEl.innerHTML = '<i class="fas fa-wifi mr-2"></i>实时连接已建立';
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    statusEl.style.opacity = '0';
                    setTimeout(() => {
                        if (statusEl.parentNode) {
                            statusEl.parentNode.removeChild(statusEl);
                        }
                    }, 300);
                }, 3000);
            } else {
                statusEl.className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-red-600 text-white';
                statusEl.innerHTML = '<i class="fas fa-wifi-slash mr-2"></i>实时连接断开';
                statusEl.style.opacity = '1';
            }
        }
        
        // 更新智能体状态（带动画）
        function updateAgentStatusWithAnimation(agentId, statusData) {
            const agentCard = document.querySelector(`[data-agent-id="${agentId}"]`);
            if (!agentCard) return;
            
            // 添加状态变化动画
            agentCard.classList.add('status-updating');
            
            // 更新状态指示器
            const statusIndicator = agentCard.querySelector('.status-indicator');
            if (statusIndicator) {
                // 添加闪烁效果
                statusIndicator.style.animation = 'pulse 0.5s ease-in-out';
                
                setTimeout(() => {
                    statusIndicator.className = `status-indicator status-${statusData.newStatus}`;
                    statusIndicator.textContent = getStatusText(statusData.newStatus);
                    statusIndicator.style.animation = '';
                }, 250);
            }
            
            // 更新当前任务
            const currentTaskEl = agentCard.querySelector('.truncate');
            if (currentTaskEl && statusData.currentTask) {
                // 添加文字变化动画
                currentTaskEl.style.opacity = '0.5';
                setTimeout(() => {
                    currentTaskEl.textContent = statusData.currentTask;
                    currentTaskEl.style.opacity = '1';
                }, 150);
            }
            
            // 更新健康状态指示器
            const healthIndicator = agentCard.querySelector('.health-indicator');
            if (healthIndicator) {
                const isHealthy = statusData.newStatus !== 'error';
                healthIndicator.className = `health-indicator ${isHealthy ? 'health-healthy' : 'health-error'}`;
            }
            
            // 更新模态框中的状态（如果打开）
            updateModalStatus(agentId, statusData);
            
            // 更新统计摘要
            updateAgentSummary(window.agentManager.getAgentsSummary());
            
            // 移除动画类
            setTimeout(() => {
                agentCard.classList.remove('status-updating');
            }, 500);
        }
        
        // 更新智能体统计（带动画）
        function updateAgentStatsWithAnimation(agentId, stats) {
            const agentCard = document.querySelector(`[data-agent-id="${agentId}"]`);
            if (!agentCard) return;
            
            // 更新统计数据
            const statItems = agentCard.querySelectorAll('.stat-item .stat-value');
            if (statItems.length >= 3) {
                // 添加数字变化动画
                animateNumberChange(statItems[0], stats.totalExecutions || 0);
                animateNumberChange(statItems[1], (stats.successRate || 0) + '%');
                animateNumberChange(statItems[2], (stats.averageExecutionTime || 0) + 's');
                
                statItems[1].className = 'stat-value text-green-400';
            }
            
            // 更新进度条
            const progressFill = agentCard.querySelector('.progress-fill');
            if (progressFill) {
                const newWidth = (stats.successRate || 0) + '%';
                progressFill.style.transition = 'width 0.5s ease';
                progressFill.style.width = newWidth;
            }
            
            // 更新模态框中的统计（如果打开）
            updateModalStats(agentId, stats);
            
            // 更新统计摘要
            updateAgentSummary(window.agentManager.getAgentsSummary());
        }
        
        // 数字变化动画
        function animateNumberChange(element, newValue) {
            if (!element) return;
            
            const oldValue = element.textContent;
            if (oldValue === newValue.toString()) return;
            
            // 添加变化效果
            element.style.transform = 'scale(1.1)';
            element.style.color = '#8b5cf6';
            
            setTimeout(() => {
                element.textContent = newValue;
                element.style.transform = 'scale(1)';
                element.style.color = '';
            }, 150);
        }
        
        // 显示状态变化通知
        function showStatusChangeNotification(agentId, statusData) {
            if (!window.agentManager) return;
            
            const agent = window.agentManager.getAgentDetails(agentId);
            if (!agent) return;
            
            // 只对重要状态变化显示通知
            const importantStatuses = ['error', 'active', 'offline'];
            if (!importantStatuses.includes(statusData.newStatus)) return;
            
            const notification = createNotification({
                type: getNotificationType(statusData.newStatus),
                title: `${agent.name} 状态变化`,
                message: `状态从 ${getStatusText(statusData.oldStatus)} 变更为 ${getStatusText(statusData.newStatus)}`,
                duration: 5000
            });
            
            showNotification(notification);
        }
        
        // 显示配置更新通知
        function showConfigUpdateNotification(agentId) {
            if (!window.agentManager) return;
            
            const agent = window.agentManager.getAgentDetails(agentId);
            if (!agent) return;
            
            const notification = createNotification({
                type: 'info',
                title: `${agent.name} 配置更新`,
                message: '智能体配置已更新',
                duration: 3000
            });
            
            showNotification(notification);
        }
        
        // 获取通知类型
        function getNotificationType(status) {
            const typeMap = {
                'error': 'error',
                'active': 'success',
                'offline': 'warning',
                'busy': 'info'
            };
            return typeMap[status] || 'info';
        }
        
        // 创建通知
        function createNotification({ type, title, message, duration = 3000 }) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type} fixed top-20 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
            
            const iconMap = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="${iconMap[type]} text-lg"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <h4 class="text-sm font-medium">${title}</h4>
                        <p class="text-sm opacity-90 mt-1">${message}</p>
                    </div>
                    <button onclick="this.parentNode.parentNode.remove()" class="ml-4 text-sm opacity-70 hover:opacity-100">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // 设置自动消失
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, duration);
            
            return notification;
        }
        
        // 显示通知
        function showNotification(notification) {
            document.body.appendChild(notification);
            
            // 触发动画
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
        }
        
        // 更新模态框状态
        function updateModalStatus(agentId, statusData) {
            const modal = document.getElementById('agent-detail-modal');
            if (!modal || modal.classList.contains('hidden')) return;
            
            const modalAgentId = modal.getAttribute('data-agent-id');
            if (modalAgentId !== agentId) return;
            
            // 更新头部状态
            const modalStatus = document.getElementById('modal-agent-status');
            if (modalStatus) {
                modalStatus.className = `status-indicator status-${statusData.newStatus}`;
                modalStatus.textContent = getStatusText(statusData.newStatus);
            }
            
            // 更新概览页面状态
            const overviewStatus = document.getElementById('overview-status');
            if (overviewStatus) {
                overviewStatus.className = `status-indicator status-${statusData.newStatus}`;
                overviewStatus.textContent = getStatusText(statusData.newStatus);
            }
            
            // 更新当前任务
            const overviewTask = document.getElementById('overview-current-task');
            if (overviewTask && statusData.currentTask) {
                overviewTask.textContent = statusData.currentTask;
            }
        }
        
        // 更新模态框统计
        function updateModalStats(agentId, stats) {
            const modal = document.getElementById('agent-detail-modal');
            if (!modal || modal.classList.contains('hidden')) return;
            
            const modalAgentId = modal.getAttribute('data-agent-id');
            if (modalAgentId !== agentId) return;
            
            // 更新概览页面统计
            const statElements = {
                'overview-total-executions': stats.totalExecutions || 0,
                'overview-successful-executions': stats.successfulExecutions || 0,
                'overview-success-rate': (stats.successRate || 0) + '%',
                'overview-avg-time': (stats.averageExecutionTime || 0) + 's'
            };
            
            Object.entries(statElements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) {
                    animateNumberChange(el, value);
                }
            });
        }
        
        // 更新智能体配置
        function updateAgentConfig(agentId, configuration) {
            // 如果详情模态框打开，更新配置信息
            const modal = document.getElementById('agent-detail-modal');
            if (modal && modal.style.display !== 'none') {
                const modalAgentId = modal.getAttribute('data-agent-id');
                if (modalAgentId === agentId) {
                    // 重新加载详情信息
                    showAgentDetails(agentId);
                }
            }
        }
        
        // 更新智能体统计
        function updateAgentStats(agentId, stats) {
            const agentCard = document.querySelector(`[data-agent-id="${agentId}"]`);
            if (!agentCard) return;
            
            // 更新统计数据
            const statItems = agentCard.querySelectorAll('.stat-item .stat-value');
            if (statItems.length >= 3) {
                statItems[0].textContent = stats.totalExecutions || 0;
                statItems[1].textContent = (stats.successRate || 0) + '%';
                statItems[1].className = 'stat-value text-green-400';
                statItems[2].textContent = (stats.averageExecutionTime || 0) + 's';
            }
            
            // 更新进度条
            const progressFill = agentCard.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = (stats.successRate || 0) + '%';
            }
            
            // 更新统计摘要
            updateAgentSummary(window.agentManager.getAgentsSummary());
        }
        
        // 刷新智能体
        async function refreshAgents() {
            await loadAgents();
        }
        
        // 编辑智能体配置
        function editAgentConfig(agentId) {
            // 这个功能将在后续任务中实现
            console.log('编辑智能体配置:', agentId);
        }
        
        // 显示智能体详情
        function showAgentDetails(agentId) {
            if (!window.agentManager) {
                console.error('智能体管理器未初始化');
                return;
            }
            
            const agent = window.agentManager.getAgentDetails(agentId);
            if (!agent) {
                console.error('未找到智能体:', agentId);
                return;
            }
            
            // 设置模态框数据
            const modal = document.getElementById('agent-detail-modal');
            modal.setAttribute('data-agent-id', agentId);
            
            // 更新头部信息
            updateModalHeader(agent);
            
            // 更新概览信息
            updateOverviewTab(agent);
            
            // 切换到概览标签页
            switchDetailTab('overview');
            
            // 显示模态框
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭智能体详情模态框
        function closeAgentDetailModal() {
            const modal = document.getElementById('agent-detail-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            
            // 停止自动刷新日志
            if (window.logAutoRefreshInterval) {
                clearInterval(window.logAutoRefreshInterval);
                window.logAutoRefreshInterval = null;
                updateAutoRefreshButton(false);
            }
        }
        
        // 更新模态框头部
        function updateModalHeader(agent) {
            const iconEl = document.getElementById('modal-agent-icon');
            const nameEl = document.getElementById('modal-agent-name');
            const statusEl = document.getElementById('modal-agent-status');
            
            if (iconEl) {
                const typeInfo = agent.typeInfo || {};
                iconEl.innerHTML = `<i class="fas fa-${typeInfo.icon || 'robot'} text-xl"></i>`;
            }
            
            if (nameEl) {
                nameEl.textContent = agent.name || '未知智能体';
            }
            
            if (statusEl) {
                statusEl.className = `status-indicator status-${agent.status}`;
                statusEl.textContent = getStatusText(agent.status);
            }
        }
        
        // 切换详情标签页
        function switchDetailTab(tabName) {
            // 更新标签按钮状态
            const tabBtns = document.querySelectorAll('.detail-tab-btn');
            tabBtns.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 更新标签内容显示
            const tabContents = document.querySelectorAll('.detail-tab-content');
            tabContents.forEach(content => {
                if (content.id === `detail-tab-${tabName}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            // 根据标签页加载相应数据
            const modal = document.getElementById('agent-detail-modal');
            const agentId = modal.getAttribute('data-agent-id');
            
            switch (tabName) {
                case 'config':
                    loadConfigTab(agentId);
                    break;
                case 'history':
                    loadHistoryTab(agentId);
                    break;
                case 'logs':
                    loadLogsTab(agentId);
                    break;
            }
        }
        
        // 更新概览标签页
        function updateOverviewTab(agent) {
            // 基本信息
            const elements = {
                'overview-agent-id': agent.agentId,
                'overview-agent-type': agent.agentType,
                'overview-created-at': new Date(agent.createdAt).toLocaleString('zh-CN'),
                'overview-updated-at': new Date(agent.updatedAt).toLocaleString('zh-CN'),
                'overview-current-task': agent.currentTask || '无',
                'overview-last-check': new Date(agent.healthStatus.lastHealthCheck).toLocaleString('zh-CN'),
                'overview-description': agent.description
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });
            
            // 状态指示器
            const statusEl = document.getElementById('overview-status');
            if (statusEl) {
                statusEl.className = `status-indicator status-${agent.status}`;
                statusEl.textContent = getStatusText(agent.status);
            }
            
            // 健康状态
            const healthEl = document.getElementById('overview-health');
            if (healthEl) {
                const healthClass = agent.healthStatus.isHealthy ? 'health-healthy' : 'health-error';
                const healthText = agent.healthStatus.isHealthy ? '健康' : '异常';
                healthEl.innerHTML = `
                    <div class="health-indicator ${healthClass} mr-2"></div>
                    <span class="text-sm">${healthText}</span>
                `;
            }
            
            // 能力标签
            const capabilitiesEl = document.getElementById('overview-capabilities');
            if (capabilitiesEl && agent.capabilities) {
                const capabilityTags = agent.capabilities
                    .map(cap => `<span class="capability-tag">${cap}</span>`)
                    .join('');
                capabilitiesEl.innerHTML = capabilityTags;
            }
            
            // 执行统计
            const stats = agent.executionStats || {};
            const statElements = {
                'overview-total-executions': stats.totalExecutions || 0,
                'overview-successful-executions': stats.successfulExecutions || 0,
                'overview-success-rate': (stats.successRate || 0) + '%',
                'overview-avg-time': (stats.averageExecutionTime || 0) + 's'
            };
            
            Object.entries(statElements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });
        }
        
        // 加载配置标签页
        function loadConfigTab(agentId) {
            if (!window.agentManager) return;
            
            const agent = window.agentManager.getAgentDetails(agentId);
            if (!agent) return;
            
            const config = agent.configuration || {};
            
            // 大模型配置
            const llmElements = {
                'config-llm-name': config.llmConfig || '未配置',
                'config-llm-provider': '未知',
                'config-llm-model': '未知'
            };
            
            Object.entries(llmElements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });
            
            // 参数配置
            const parametersEl = document.getElementById('config-parameters');
            if (parametersEl && config.parameters) {
                const parameterItems = Object.entries(config.parameters)
                    .map(([key, value]) => `
                        <div class="flex justify-between">
                            <span class="text-sm opacity-75">${key}</span>
                            <span class="text-sm">${value}</span>
                        </div>
                    `).join('');
                parametersEl.innerHTML = parameterItems || '<div class="text-sm opacity-75">暂无参数配置</div>';
            }
            
            // 约束条件
            const constraintsEl = document.getElementById('config-constraints');
            if (constraintsEl && config.constraints) {
                const constraintItems = config.constraints
                    .map(constraint => `
                        <div class="flex items-center">
                            <i class="fas fa-shield-alt text-purple-300 mr-2"></i>
                            <span class="text-sm">${constraint}</span>
                        </div>
                    `).join('');
                constraintsEl.innerHTML = constraintItems || '<div class="text-sm opacity-75">暂无约束条件</div>';
            }
        }
        
        // 加载历史记录标签页
        async function loadHistoryTab(agentId) {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;
            
            // 显示加载状态
            historyList.innerHTML = `
                <div class="text-center py-8 opacity-75">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>加载历史记录中...</p>
                </div>
            `;
            
            try {
                if (!window.agentManager) {
                    throw new Error('智能体管理器未初始化');
                }
                
                const filter = document.getElementById('history-filter')?.value || '';
                const result = await window.agentManager.getAgentHistory(agentId, {
                    status: filter,
                    page: 1,
                    pageSize: 20
                });
                
                if (result.success && result.data) {
                    renderHistoryList(result.data.items || []);
                    renderHistoryPagination(result.data.pagination || {});
                } else {
                    historyList.innerHTML = `
                        <div class="text-center py-8 opacity-75">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>加载历史记录失败</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载历史记录失败:', error);
                historyList.innerHTML = `
                    <div class="text-center py-8 opacity-75">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>加载历史记录时发生错误</p>
                    </div>
                `;
            }
        }
        
        // 渲染历史记录列表
        function renderHistoryList(items) {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;
            
            if (!items || items.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center py-8 opacity-75">
                        <i class="fas fa-history text-2xl mb-2"></i>
                        <p>暂无历史记录</p>
                    </div>
                `;
                return;
            }
            
            const historyItems = items.map(item => `
                <div class="history-item ${item.status}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h5 class="font-medium text-blue-100">${item.taskTitle || '未知任务'}</h5>
                            <p class="text-sm opacity-75">${item.description || ''}</p>
                        </div>
                        <div class="text-right">
                            <div class="status-indicator status-${item.status} mb-1">
                                ${getStatusText(item.status)}
                            </div>
                            <div class="text-xs opacity-60">
                                ${new Date(item.startTime).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs opacity-75">
                        <span>耗时: ${item.duration || 0}s</span>
                        <span>ID: ${item.executionId}</span>
                    </div>
                </div>
            `).join('');
            
            historyList.innerHTML = historyItems;
        }
        
        // 渲染历史记录分页
        function renderHistoryPagination(pagination) {
            const paginationEl = document.getElementById('history-pagination');
            if (!paginationEl || !pagination.totalPages) return;
            
            const { currentPage, totalPages } = pagination;
            let paginationHTML = '';
            
            // 上一页按钮
            paginationHTML += `
                <button class="pagination-btn" ${currentPage <= 1 ? 'disabled' : ''} 
                        onclick="loadHistoryPage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // 页码按钮
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                const page = i;
                paginationHTML += `
                    <button class="pagination-btn ${page === currentPage ? 'active' : ''}" 
                            onclick="loadHistoryPage(${page})">
                        ${page}
                    </button>
                `;
            }
            
            // 下一页按钮
            paginationHTML += `
                <button class="pagination-btn" ${currentPage >= totalPages ? 'disabled' : ''} 
                        onclick="loadHistoryPage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationEl.innerHTML = paginationHTML;
        }
        
        // 加载指定页的历史记录
        async function loadHistoryPage(page) {
            const modal = document.getElementById('agent-detail-modal');
            const agentId = modal.getAttribute('data-agent-id');
            if (!agentId) return;
            
            // 这里可以实现分页加载逻辑
            console.log('加载历史记录页面:', page);
        }
        
        // 加载历史记录（带过滤）
        async function loadAgentHistory() {
            const modal = document.getElementById('agent-detail-modal');
            const agentId = modal.getAttribute('data-agent-id');
            if (!agentId) return;
            
            await loadHistoryTab(agentId);
        }
        
        // 加载日志标签页
        async function loadLogsTab(agentId) {
            const logsContainer = document.getElementById('logs-container');
            if (!logsContainer) return;
            
            // 显示加载状态
            logsContainer.innerHTML = `
                <div class="text-center py-8 opacity-75">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>加载日志中...</p>
                </div>
            `;
            
            try {
                if (!window.agentManager) {
                    throw new Error('智能体管理器未初始化');
                }
                
                const level = document.getElementById('log-level-filter')?.value || 'all';
                const result = await window.agentManager.getAgentLogs(agentId, {
                    level: level,
                    limit: 100
                });
                
                if (result.success && result.data) {
                    renderLogsList(result.data.logs || []);
                } else {
                    logsContainer.innerHTML = `
                        <div class="text-center py-8 opacity-75">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>加载日志失败</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载日志失败:', error);
                logsContainer.innerHTML = `
                    <div class="text-center py-8 opacity-75">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>加载日志时发生错误</p>
                    </div>
                `;
            }
        }
        
        // 渲染日志列表
        function renderLogsList(logs) {
            const logsContainer = document.getElementById('logs-container');
            if (!logsContainer) return;
            
            if (!logs || logs.length === 0) {
                logsContainer.innerHTML = `
                    <div class="text-center py-8 opacity-75">
                        <i class="fas fa-file-alt text-2xl mb-2"></i>
                        <p>暂无日志记录</p>
                    </div>
                `;
                return;
            }
            
            const logEntries = logs.map(log => `
                <div class="log-entry">
                    <span class="log-timestamp">${new Date(log.timestamp).toLocaleTimeString('zh-CN')}</span>
                    <span class="log-level ${log.level}">${log.level.toUpperCase()}</span>
                    <span class="log-message">${log.message}</span>
                </div>
            `).join('');
            
            logsContainer.innerHTML = logEntries;
            
            // 滚动到底部
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        // 加载日志（带过滤）
        async function loadAgentLogs() {
            const modal = document.getElementById('agent-detail-modal');
            const agentId = modal.getAttribute('data-agent-id');
            if (!agentId) return;
            
            await loadLogsTab(agentId);
        }
        
        // 切换自动刷新日志
        function toggleAutoRefreshLogs() {
            if (window.logAutoRefreshInterval) {
                // 停止自动刷新
                clearInterval(window.logAutoRefreshInterval);
                window.logAutoRefreshInterval = null;
                updateAutoRefreshButton(false);
            } else {
                // 开始自动刷新
                window.logAutoRefreshInterval = setInterval(() => {
                    loadAgentLogs();
                }, 5000); // 每5秒刷新一次
                updateAutoRefreshButton(true);
            }
        }
        
        // 更新自动刷新按钮状态
        function updateAutoRefreshButton(isActive) {
            const btn = document.getElementById('auto-refresh-btn');
            if (!btn) return;
            
            if (isActive) {
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                btn.innerHTML = '<i class="fas fa-play"></i>';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            }
        }
        
        // 编辑智能体配置模态框
        function editAgentConfigModal() {
            // 这个功能将在后续实现
            console.log('编辑智能体配置模态框');
        }
        
        // 页面卸载时清理资源
        window.addEventListener('beforeunload', function() {
            // 清理定时器
            if (window.agentRefreshInterval) {
                clearInterval(window.agentRefreshInterval);
            }
            
            if (window.logAutoRefreshInterval) {
                clearInterval(window.logAutoRefreshInterval);
            }
            
            // 取消订阅
            if (window.agentManager) {
                window.agentManager.unsubscribeFromUpdates();
            }
        });
        
        // 页面可见性变化处理
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // 页面隐藏时暂停自动刷新
                if (window.agentRefreshInterval) {
                    clearInterval(window.agentRefreshInterval);
                }
            } else {
                // 页面显示时恢复自动刷新
                setupAutoRefresh();
                // 立即刷新一次数据
                if (window.agentManager) {
                    loadAgents();
                }
            }
        });
    </script>

    <!-- 引入配置文件 -->
    <script src="config.js"></script>
    
    <!-- 引入核心脚本 -->
    <script src="js/core/form-validator.js"></script>
    
    <!-- 引入管理器脚本 -->
    <script src="js/managers/llm-config-manager.js"></script>
    <script src="js/managers/agent-manager.js"></script>
    <script src="js/managers/meta-agent-chat-manager.js"></script>
</body>
</html>