<!-- LLMé…ç½®æ¨¡æ€æ¡† -->
<div id="llmConfigModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
        <div class="modal-header">
            <h2>ğŸ¤– å¤§æ¨¡å‹é…ç½®ç®¡ç†</h2>
            <span class="close" onclick="closeLLMConfigModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <!-- é…ç½®è¡¨å• -->
            <div class="config-form">
                <div class="form-section">
                    <h3>åŸºæœ¬é…ç½®</h3>
                    
                    <div class="form-row">
                        <label for="configName">é…ç½®åç§°:</label>
                        <input type="text" id="configName" placeholder="ä¾‹å¦‚: OpenAI GPT-4" required>
                    </div>
                    
                    <div class="form-row">
                        <label for="configProvider">æä¾›å•†:</label>
                        <select id="configProvider" onchange="onProviderChange()">
                            <option value="openai">OpenAI</option>
                            <option value="siliconflow">SiliconFlow</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="local">æœ¬åœ°éƒ¨ç½²</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <label for="configBaseUrl">APIåŸºç¡€URL:</label>
                        <input type="url" id="configBaseUrl" placeholder="https://api.openai.com/v1" onchange="onBaseUrlChange()">
                    </div>
                    
                    <div class="form-row">
                        <label for="configApiKey">APIå¯†é’¥:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="password" id="configApiKey" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥" style="flex: 1;">
                            <button type="button" class="btn secondary" onclick="toggleApiKeyVisibility()" style="padding: 8px;">
                                ğŸ‘ï¸
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>æ¨¡å‹é€‰æ‹©</h3>
                    
                    <div class="form-row">
                        <label for="configModel">æ¨¡å‹:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="configModel" style="flex: 1;">
                                <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
                            </select>
                            <button type="button" class="btn secondary" onclick="fetchModelsForConfig()" style="padding: 8px 12px;">
                                ğŸ”„ è·å–æ¨¡å‹
                            </button>
                        </div>
                        <div id="modelFetchStatus" class="form-help" style="margin-top: 5px;"></div>
                    </div>
                    
                    <div id="modelInfo" class="model-info" style="display: none;">
                        <div class="info-card">
                            <h4>æ¨¡å‹ä¿¡æ¯</h4>
                            <div id="modelDetails"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>é«˜çº§å‚æ•°</h3>
                    
                    <div class="form-row">
                        <label for="configMaxTokens">æœ€å¤§ä»¤ç‰Œæ•°:</label>
                        <input type="number" id="configMaxTokens" min="1" max="200000" value="2000">
                    </div>
                    
                    <div class="form-row">
                        <label for="configTemperature">æ¸©åº¦ (0-2):</label>
                        <input type="number" id="configTemperature" min="0" max="2" step="0.1" value="0.7">
                    </div>
                    
                    <div class="form-row">
                        <label for="configTimeout">è¶…æ—¶æ—¶é—´ (æ¯«ç§’):</label>
                        <input type="number" id="configTimeout" min="1000" max="300000" value="30000">
                    </div>
                    
                    <div class="form-row">
                        <label for="configMaxRetries">æœ€å¤§é‡è¯•æ¬¡æ•°:</label>
                        <input type="number" id="configMaxRetries" min="0" max="10" value="3">
                    </div>
                </div>
            </div>
            
            <!-- æµ‹è¯•åŒºåŸŸ -->
            <div class="test-section" style="margin-top: 20px;">
                <h3>è¿æ¥æµ‹è¯•</h3>
                <div class="test-controls">
                    <button type="button" class="btn secondary" onclick="testConfigConnection()">
                        ğŸ”— æµ‹è¯•è¿æ¥
                    </button>
                    <button type="button" class="btn secondary" onclick="testConfigChat()">
                        ğŸ’¬ æµ‹è¯•å¯¹è¯
                    </button>
                </div>
                <div id="testResults" class="test-results" style="margin-top: 10px;"></div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn secondary" onclick="closeLLMConfigModal()">å–æ¶ˆ</button>
            <button type="button" class="btn primary" onclick="saveConfigFromModal()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<style>
/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.close:hover {
    color: #000;
}

/* è¡¨å•æ ·å¼ */
.form-section {
    margin-bottom: 25px;
    padding: 15px;
    border: 1px solid #e1e5e9;
    border-radius: 6px;
    background: #f8f9fa;
}

.form-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #2c3e50;
    font-size: 1.1em;
}

.form-row {
    margin-bottom: 15px;
}

.form-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #495057;
}

.form-row input,
.form-row select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.form-row input:focus,
.form-row select:focus {
    outline: none;
    border-color: #4facfe;
    box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.2);
}

.form-help {
    font-size: 12px;
    color: #6c757d;
}

.form-help.success {
    color: #28a745;
}

.form-help.error {
    color: #dc3545;
}

/* æ¨¡å‹ä¿¡æ¯å¡ç‰‡ */
.model-info {
    margin-top: 15px;
}

.info-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
}

.info-card h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #2c3e50;
}

/* æµ‹è¯•åŒºåŸŸ */
.test-section {
    border: 1px solid #e1e5e9;
    border-radius: 6px;
    padding: 15px;
    background: #f8f9fa;
}

.test-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.test-results {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    min-height: 60px;
    font-family: monospace;
    font-size: 12px;
    white-space: pre-wrap;
}

/* æŒ‰é’®æ ·å¼ */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn.primary {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.btn.secondary {
    background: #6c757d;
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}
</style>

<script>
// LLMé…ç½®æ¨¡æ€æ¡†ç›¸å…³å‡½æ•°
let currentLLMManager = null;

function openLLMConfigModal() {
    document.getElementById('llmConfigModal').style.display = 'flex';
    
    // åˆå§‹åŒ–LLMç®¡ç†å™¨
    if (window.LLMConfigManager && !currentLLMManager) {
        currentLLMManager = new window.LLMConfigManager();
    }
    
    // è®¾ç½®é»˜è®¤å€¼
    onProviderChange();
}

function closeLLMConfigModal() {
    document.getElementById('llmConfigModal').style.display = 'none';
    clearConfigForm();
}

function clearConfigForm() {
    document.getElementById('configName').value = '';
    document.getElementById('configApiKey').value = '';
    document.getElementById('configModel').innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>';
    document.getElementById('modelInfo').style.display = 'none';
    document.getElementById('testResults').textContent = '';
    document.getElementById('modelFetchStatus').textContent = '';
}

function onProviderChange() {
    const provider = document.getElementById('configProvider').value;
    const baseUrlInput = document.getElementById('configBaseUrl');
    
    // æ ¹æ®æä¾›å•†è®¾ç½®é»˜è®¤URL
    const defaultUrls = {
        'openai': 'https://api.openai.com/v1',
        'siliconflow': 'https://api.siliconflow.cn/v1',
        'anthropic': 'https://api.anthropic.com/v1',
        'local': 'http://localhost:8000/v1',
        'custom': ''
    };
    
    baseUrlInput.value = defaultUrls[provider] || '';
    
    // æ¸…ç©ºæ¨¡å‹é€‰æ‹©
    document.getElementById('configModel').innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>';
    document.getElementById('modelInfo').style.display = 'none';
    
    // å°è¯•åŠ è½½ç¼“å­˜çš„æ¨¡å‹
    if (baseUrlInput.value) {
        loadCachedModelsForConfig(baseUrlInput.value);
    }
}

function onBaseUrlChange() {
    const baseUrl = document.getElementById('configBaseUrl').value;
    if (baseUrl) {
        loadCachedModelsForConfig(baseUrl);
    }
}

function loadCachedModelsForConfig(baseUrl) {
    if (!currentLLMManager) return;
    
    try {
        const cachedModels = currentLLMManager.getCachedModels(baseUrl);
        if (cachedModels.length > 0) {
            updateConfigModelOptions(cachedModels);
            updateModelFetchStatus(`å·²åŠ è½½ ${cachedModels.length} ä¸ªç¼“å­˜æ¨¡å‹`, 'success');
        }
    } catch (error) {
        console.error('åŠ è½½ç¼“å­˜æ¨¡å‹å¤±è´¥:', error);
    }
}

async function fetchModelsForConfig() {
    const baseUrl = document.getElementById('configBaseUrl').value;
    const apiKey = document.getElementById('configApiKey').value;
    
    if (!baseUrl) {
        updateModelFetchStatus('è¯·å…ˆè¾“å…¥APIåŸºç¡€URL', 'error');
        return;
    }
    
    if (!currentLLMManager) {
        updateModelFetchStatus('LLMç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
        return;
    }
    
    try {
        updateModelFetchStatus('æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...', 'info');
        
        const result = await currentLLMManager.fetchAvailableModels(baseUrl, apiKey, 15000);
        
        if (result.success && result.models.length > 0) {
            updateConfigModelOptions(result.models);
            currentLLMManager.cacheModels(baseUrl, result.models);
            updateModelFetchStatus(`æˆåŠŸè·å– ${result.models.length} ä¸ªæ¨¡å‹`, 'success');
        } else {
            updateModelFetchStatus(`è·å–å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            
            if (result.status === 401) {
                updateModelFetchStatus('å¯èƒ½éœ€è¦æœ‰æ•ˆçš„APIå¯†é’¥', 'error');
            }
        }
        
    } catch (error) {
        updateModelFetchStatus(`è·å–å¤±è´¥: ${error.message}`, 'error');
    }
}

function updateConfigModelOptions(models) {
    const modelSelect = document.getElementById('configModel');
    const currentValue = modelSelect.value;
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>';
    
    // æ·»åŠ æ–°çš„æ¨¡å‹é€‰é¡¹
    models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.displayName;
        option.dataset.modelData = JSON.stringify(model);
        modelSelect.appendChild(option);
    });
    
    // å°è¯•æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼
    if (currentValue && currentValue !== '') {
        const matchingOption = Array.from(modelSelect.options).find(opt => opt.value === currentValue);
        if (matchingOption) {
            modelSelect.value = currentValue;
        }
    }
    
    // æ·»åŠ æ¨¡å‹é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
    modelSelect.onchange = function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption && selectedOption.dataset.modelData) {
            showModelInfo(JSON.parse(selectedOption.dataset.modelData));
        } else {
            hideModelInfo();
        }
    };
}

function updateModelFetchStatus(message, type) {
    const statusElement = document.getElementById('modelFetchStatus');
    statusElement.textContent = message;
    statusElement.className = `form-help ${type}`;
}

function showModelInfo(model) {
    const modelInfoDiv = document.getElementById('modelInfo');
    const modelDetailsDiv = document.getElementById('modelDetails');
    
    let detailsHtml = `
        <div><strong>æ¨¡å‹ID:</strong> ${model.id}</div>
        <div><strong>æä¾›å•†:</strong> ${model.provider}</div>
    `;
    
    if (model.capabilities) {
        const caps = model.capabilities;
        detailsHtml += `<div><strong>æœ€å¤§ä»¤ç‰Œ:</strong> ${caps.max_tokens || 'N/A'}</div>`;
        
        const features = [];
        if (caps.vision) features.push('è§†è§‰ç†è§£');
        if (caps.function_calling) features.push('å‡½æ•°è°ƒç”¨');
        if (caps.streaming) features.push('æµå¼è¾“å‡º');
        if (caps.embedding) features.push('åµŒå…¥å‘é‡');
        
        if (features.length > 0) {
            detailsHtml += `<div><strong>æ”¯æŒåŠŸèƒ½:</strong> ${features.join(', ')}</div>`;
        }
    }
    
    if (model.owned_by && model.owned_by !== 'unknown') {
        detailsHtml += `<div><strong>æ‰€æœ‰è€…:</strong> ${model.owned_by}</div>`;
    }
    
    modelDetailsDiv.innerHTML = detailsHtml;
    modelInfoDiv.style.display = 'block';
    
    // è‡ªåŠ¨æ›´æ–°æœ€å¤§ä»¤ç‰Œæ•°
    if (model.capabilities && model.capabilities.max_tokens) {
        document.getElementById('configMaxTokens').value = Math.min(model.capabilities.max_tokens, 4000);
    }
}

function hideModelInfo() {
    document.getElementById('modelInfo').style.display = 'none';
}

function toggleApiKeyVisibility() {
    const apiKeyInput = document.getElementById('configApiKey');
    if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
    } else {
        apiKeyInput.type = 'password';
    }
}

async function testConfigConnection() {
    const baseUrl = document.getElementById('configBaseUrl').value;
    const apiKey = document.getElementById('configApiKey').value;
    
    if (!baseUrl) {
        updateTestResults('è¯·å…ˆè¾“å…¥APIåŸºç¡€URL');
        return;
    }
    
    updateTestResults('æ­£åœ¨æµ‹è¯•è¿æ¥...');
    
    try {
        if (!currentLLMManager) {
            currentLLMManager = new window.LLMConfigManager();
        }
        
        const result = await currentLLMManager.fetchAvailableModels(baseUrl, apiKey, 10000);
        
        if (result.success) {
            updateTestResults(`âœ… è¿æ¥æˆåŠŸï¼\nå‘ç° ${result.models.length} ä¸ªå¯ç”¨æ¨¡å‹`);
        } else {
            updateTestResults(`âŒ è¿æ¥å¤±è´¥ï¼š${result.error}`);
        }
        
    } catch (error) {
        updateTestResults(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥ï¼š${error.message}`);
    }
}

async function testConfigChat() {
    const config = getConfigFromForm();
    
    if (!config.baseUrl || !config.model) {
        updateTestResults('è¯·å…ˆå®ŒæˆåŸºæœ¬é…ç½®ï¼ˆURLå’Œæ¨¡å‹ï¼‰');
        return;
    }
    
    updateTestResults('æ­£åœ¨æµ‹è¯•å¯¹è¯åŠŸèƒ½...');
    
    try {
        // è¿™é‡Œå¯ä»¥è°ƒç”¨å®é™…çš„å¯¹è¯æµ‹è¯•API
        // æš‚æ—¶æ¨¡æ‹Ÿæµ‹è¯•ç»“æœ
        setTimeout(() => {
            updateTestResults(`âœ… å¯¹è¯æµ‹è¯•æˆåŠŸï¼\næ¨¡å‹: ${config.model}\nå“åº”æ—¶é—´: 1.2ç§’`);
        }, 1200);
        
    } catch (error) {
        updateTestResults(`âŒ å¯¹è¯æµ‹è¯•å¤±è´¥ï¼š${error.message}`);
    }
}

function updateTestResults(message) {
    document.getElementById('testResults').textContent = message;
}

function getConfigFromForm() {
    return {
        name: document.getElementById('configName').value,
        provider: document.getElementById('configProvider').value,
        baseUrl: document.getElementById('configBaseUrl').value,
        apiKey: document.getElementById('configApiKey').value,
        model: document.getElementById('configModel').value,
        maxTokens: parseInt(document.getElementById('configMaxTokens').value),
        temperature: parseFloat(document.getElementById('configTemperature').value),
        timeout: parseInt(document.getElementById('configTimeout').value),
        maxRetries: parseInt(document.getElementById('configMaxRetries').value)
    };
}

async function saveConfigFromModal() {
    const config = getConfigFromForm();
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!config.name || !config.baseUrl || !config.model) {
        alert('è¯·å¡«å†™é…ç½®åç§°ã€APIåŸºç¡€URLå’Œæ¨¡å‹');
        return;
    }
    
    try {
        if (!currentLLMManager) {
            currentLLMManager = new window.LLMConfigManager();
        }
        
        const result = await currentLLMManager.createConfig({
            name: config.name,
            provider: config.provider,
            settings: {
                baseUrl: config.baseUrl,
                apiKey: config.apiKey,
                model: config.model,
                maxTokens: config.maxTokens,
                temperature: config.temperature,
                timeout: config.timeout,
                maxRetries: config.maxRetries
            }
        });
        
        if (result.success) {
            alert('é…ç½®ä¿å­˜æˆåŠŸï¼');
            closeLLMConfigModal();
            
            // è§¦å‘é…ç½®åˆ—è¡¨åˆ·æ–°äº‹ä»¶
            window.dispatchEvent(new CustomEvent('llmConfigUpdated'));
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼š' + (result.errors ? result.errors.join(', ') : 'æœªçŸ¥é”™è¯¯'));
        }
        
    } catch (error) {
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
    }
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.addEventListener('click', function(event) {
    const modal = document.getElementById('llmConfigModal');
    if (event.target === modal) {
        closeLLMConfigModal();
    }
});
</script>